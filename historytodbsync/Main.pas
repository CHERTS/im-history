{ ############################################################################ }
{ #                                                                          # }
{ #  »ÏÔÓÚ ËÒÚÓËË HistoryToDBSync v2.4                                     # }
{ #                                                                          # }
{ #  License: GPLv3                                                          # }
{ #                                                                          # }
{ #  Author: Grigorev Michael (icq: 161867489, email: sleuthhound@gmail.com) # }
{ #                                                                          # }
{ ############################################################################ }

unit Main;

{$I HistoryToDBSync.inc}

interface

uses
  Global, Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, Menus, OleCtrls, SKYPE4COMLib_TLB, CoolTrayIcon, mmSystem, XMLIntf, XMLDoc, ZAbstractRODataset, ZAbstractDataset, ZDataset,
  ZAbstractConnection, ZConnection, ZAbstractTable, StdCtrls,
  ImgList, ComCtrls, ExtCtrls, DB, ZSqlProcessor, JvComponentBase, JvThread,
  JvAppStorage, JvAppIniStorage, JvFormPlacement, ZDbcIntfs, JvAppHotKey, JclStringConversions,
  DCPcrypt2, DCPblockciphers, DCPdes, DCPsha1, DCPbase64, RegExpr, Grids,
  ZSqlMonitor, JvThreadTimer, JvDesktopAlert, ShellApi, MapStream;

type
  TMainSyncForm = class(TForm)
    HistoryToDBSyncTray: TCoolTrayIcon;
    HistoryToDbSyncPopupMenu: TPopupMenu;
    HistorySync: TMenuItem;
    HistoryExit: TMenuItem;
    About: TMenuItem;
    HistoryMainForm: TMenuItem;
    ZConnection1: TZConnection;
    SyncGroupBox: TGroupBox;
    LSyncMethod: TLabel;
    LSyncInterval: TLabel;
    LSyncStatus: TLabel;
    SyncButton: TButton;
    TrayImageList: TImageList;
    SyncProgressBar: TProgressBar;
    LSyncStatusSet: TLabel;
    LSyncMethodSet: TLabel;
    LSyncIntervalSet: TLabel;
    SyncViewTimer: TTimer;
    StartStopSyncButton: TButton;
    TrayAniImageList: TImageList;
    MainSyncQuery: TZQuery;
    DBUpdateProcessor: TZSQLProcessor;
    LEndTime: TLabel;
    SyncThread: TJvThread;
    LEndTimeDesc: TLabel;
    LTotalMesCountDesc: TLabel;
    LMesCurrentCountDesc: TLabel;
    LMesCurrentCount: TLabel;
    LBadMesCountDesc: TLabel;
    LBadMesCount: TLabel;
    MainFormStorage: TJvFormStorage;
    AppIniFileStorage: TJvAppIniFileStorage;
    LDublicateMesCountDesc: TLabel;
    LDublicateMesCount: TLabel;
    CheckMD5HashThread: TJvThread;
    LTotalChangeMD5Hash—ountDesc: TLabel;
    LTotalChangeMD5Hash—ount: TLabel;
    LTotalBrokenMD5Hash—ount: TLabel;
    LTotalHashMsg—ount: TLabel;
    LTotalHashMsg—ountDesc: TLabel;
    LTotalBrokenMD5Hash—ountDesc: TLabel;
    LMD5DublicateMesCountDesc: TLabel;
    LMD5DublicateMesCount: TLabel;
    LDeletedMD5DublicateMesCountDesc: TLabel;
    LDeletedMD5DublicateMesCount: TLabel;
    LEncryptMesCountDesc: TLabel;
    LEncryptMesCount: TLabel;
    KeyQuery: TZQuery;
    LStartTimeDesc: TLabel;
    LStartTime: TLabel;
    UpdateContactListThread: TJvThread;
    N1: TMenuItem;
    N2: TMenuItem;
    N3: TMenuItem;
    StartUpdateContactLists: TMenuItem;
    StartCheckMD5: TMenuItem;
    StartCheckAndDeleteMD5: TMenuItem;
    ZSQLMonitor1: TZSQLMonitor;
    JvThreadTimerSync: TJvThreadTimer;
    ViewLogFile: TMenuItem;
    LSkypeStatusDesc: TLabel;
    LSkypeStatus: TLabel;
    LTotalMesCount: TLabel;
    JvThreadTimerSkype: TJvThreadTimer;
    HistoryShow: TMenuItem;
    ShowSettings: TMenuItem;
    PopupImage: TImage;
    ImageList_Main: TImageList;
    CheckUpdate: TMenuItem;
    JvThreadTimerAutoSync: TJvThreadTimer;
    procedure IMExcept(Sender: TObject; E: Exception);
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure FormDestroy(Sender: TObject);
    procedure FormCloseQuery(Sender: TObject; var CanClose: Boolean);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure HistoryToDBSyncTrayStartup(Sender: TObject; var ShowMainForm: Boolean);
    procedure HistoryExitClick(Sender: TObject);
    procedure HistoryMainFormClick(Sender: TObject);
    procedure AboutClick(Sender: TObject);
    procedure StartStopSyncButtonClick(Sender: TObject);
    procedure SyncButtonClick(Sender: TObject);
    procedure SyncViewTimerTimer(Sender: TObject);
    procedure ZConnection1AfterConnect(Sender: TObject);
    procedure SyncThreadExecute(Sender: TObject; Params: Pointer);
    procedure SyncThreadFinish(Sender: TObject);
    procedure CheckMD5HashThreadExecute(Sender: TObject; Params: Pointer);
    procedure CheckMD5HashThreadFinish(Sender: TObject);
    procedure LogViewButtonClick(Sender: TObject);
    procedure UpdateContactListThreadExecute(Sender: TObject; Params: Pointer);
    procedure UpdateContactListThreadFinish(Sender: TObject);
    procedure StartCheckMD5Click(Sender: TObject);
    procedure StartCheckAndDeleteMD5Click(Sender: TObject);
    procedure StartUpdateContactListsClick(Sender: TObject);
    procedure HistoryToDbSyncPopupMenuPopup(Sender: TObject);
    procedure ZSQLMonitor1Trace(Sender: TObject; Event: TZLoggingEvent; var LogTrace: Boolean);
    procedure JvThreadTimerSyncTimer(Sender: TObject);
    procedure ShowSettingsClick(Sender: TObject);
    procedure HistoryShowClick(Sender: TObject);
    procedure SkypeUILanguageChanged(ASender: TObject; const code: WideString);
    procedure SkypeMessageStatus(Sender: TObject; const pMessage: IChatMessage; Status: TChatMessageStatus);
    procedure SkypeAttachmentStatus(Sender: TObject; Status: TOleEnum);
    procedure SkypeApplicationDatagram(Sender: TObject; const pApp: IApplication; const pStream: IApplicationStream; const Text: WideString);
    procedure SkypeChatMembersChanged(ASender: TObject; const pChat: IChat; const pMembers: IUserCollection);
    procedure JvThreadTimerSkypeTimer(Sender: TObject);
    procedure ShowBalloonHint(BalloonTitle, BalloonMsg : WideString);
    procedure DoAlertShow(Sender: TObject);
    procedure DoAlertClose(Sender: TObject);
    procedure CheckUpdateClick(Sender: TObject);
    procedure CheckDBUpdate(PluginDllPath: String);
    procedure DBUpdate(SQLUpdateFile: String);
    procedure StartCheckMD5Hash;
    procedure AntiBoss(HideAllForms: Boolean);
    procedure LoadDBSettings;
    procedure CoreLanguageChanged;
    procedure ShowSyncSettings;
    procedure SQL_Zeos_Key(Sql: WideString);
    procedure SQL_Zeos(Sql: WideString);
    procedure SQL_Zeos_Exec(Sql: WideString);
    procedure RegisterHotKeys;
    procedure UnRegisterHotKeys;
    procedure ReadEncryptionKey;
    procedure StartUpdateContactList;
    procedure ConnectDB;
    procedure StartJvSyncTimer;
    procedure StopJvSyncTimer;
    procedure RunTimeSync;
    procedure EnableButton;
    procedure DisableButton;
    procedure EnableSkype;
    procedure DisableSkype;
    procedure ReadMappedText;
    function ReConnectDB: Boolean;
    function GetEncryptionKey(KeyPwd: String; var EncryptKey, EncryptKeyID: String): Integer;
    function ParseSQLAndEncrypt(SQLStr, EncryptKeyID, EncryptKey: String; var EncryptMsgCount: Integer): WideString;
    function CheckServiceMode: Boolean;
    function GetCurrentEncryptionKeyID(var ActiveKeyID: String): Integer;
    function CheckQueryRecNo(TotalRecNo, CurRecNo: Integer): Boolean;
    procedure JvThreadTimerAutoSyncTimer(Sender: TObject);
  private
    { Private declarations }
    Skype: TSkype;
    SkypeStrList: TStringList;
    SkypeChatList: TStringGrid;
    SessionEnding: Boolean;
    FLanguage : WideString;
    FCount: Integer;
    FMap: TMapStream;
    procedure LoadLanguageStrings;
    procedure msgBoxShow(var Msg: TMessage); message WM_MSGBOX;
    procedure OnControlReq(var Msg : TWMCopyData); message WM_COPYDATA;
    procedure OnLanguageChanged(var Msg: TMessage); message WM_LANGUAGECHANGED;
    procedure WMQueryEndSession(var Message: TMessage); message WM_QUERYENDSESSION;
    procedure DoHotKey(Sender:TObject);
  public
    { Public declarations }
    ThreadMsgNum: Integer;
    ThreadMsgStr: String;
    ProgressBarCount: Integer;
    SyncMesCurrentCount: Integer;
    SyncTotalMesCount: Integer;
    SyncBadMesCount: String;
    SyncDublicateMesCount: String;
    SyncStartTime: String;
    SyncEndTime: String;
    SyncEncryptMsgCount: Integer;
    CheckTotalHashMsg—ount: Integer;
    CheckTotalBrokenMD5Hash—ount: String;
    CheckTotalChangeMD5Hash—ount: String;
    CheckTotalMD5DublicateMesCount: String;
    CheckTotalDeletedMD5DublicateMesCount: String;
    HistoryMainFormHidden: Boolean;
    CloseRequest: Boolean;
    RunAppDone: Boolean;
    HistoryImportEnable: Boolean;
    SkypeInit: Boolean;
    SkypeRunDone: Boolean;
    SkypeAttachDone: Boolean;
    CheckMD5HashDone: Boolean;
    UpdateContactListDone: Boolean;
    SyncDone: Boolean;
    procedure SyncThreadShowMessage;
    procedure CLThreadShowMessage;
    procedure MD5ThreadShowMessage;
    function RegExprMatchStrings(Source, PatternRegExpr: WideString): Boolean;
    property CoreLanguage: WideString read FLanguage;
  end;

procedure StartSyncTrayFlashingTimer;
procedure StopSyncTrayFlashingTimer;
procedure SyncTrayFlashingTimerCallBack(uTimerID, uMessage: UINT; dwUser, dw1, dw2: DWORD); stdcall;

var
  MainSyncForm                  : TMainSyncForm;
  SyncTimer                     : Cardinal;  // ÃÛÎ¸ÚËÏÂ‰Ë‡ Ú‡ÈÏÂ ‚Á‡ÏÂÌ ÍË‚Ó„Ó TTimer
  SyncTrayFlashingTimer         : Cardinal;  // ÃÛÎ¸ÚËÏÂ‰Ë‡ Ú‡ÈÏÂ ‚Á‡ÏÂÌ ÍË‚Ó„Ó TTimer
  SyncTimerEnabled              : Boolean = False;
  SyncTrayFlashingTimerEnabled  : Boolean = False;
  SyncTimerStartTime            : Longint;
  SetSyncInterval               : Integer;
  SyncHistoryStartedEnabled     : Boolean = False;
  CheckMD5HashStartedEnabled    : Boolean = False;
  UpdateContactListStartedEnabled: Boolean = False;
  DeleteDublicate               : Boolean = False;
  JvSyncHotKey                  : TJvApplicationHotKey;

implementation

uses About, KeyPasswd, Log;

{$R *.dfm}

procedure TMainSyncForm.WMQueryEndSession(var Message: TMessage);
begin
  SessionEnding := True;
  Message.Result := 1;
end;

{ —‚ÓÈ Ó·‡·ÓÚ˜ËÍ ËÒÍÎ˛˜ÂÌËÈ }
procedure TMainSyncForm.IMExcept(Sender: TObject; E: Exception);
begin
  // œË¯ÂÏ ‚ ÎÓ„ Ó¯Ë·ÍË
  if EnableDebug then
    WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ IMExcept: Class - ' + E.ClassName + ' | Œ¯Ë·Í‡ - ' + Trim(e.Message), 2);
end;

procedure TMainSyncForm.FormCreate(Sender: TObject);
var
  CmdHelpStr, Path: WideString;
begin
  RunAppDone := False;
  CloseRequest := False;
  // ƒÎˇ ÏÛÎ¸ÚËˇÁ˚ÍÓ‚ÓÈ ÔÓ‰‰ÂÊÍË
  MainFormHandle := Handle;
  SetWindowLong(Handle, GWL_HWNDPARENT, 0);
  SetWindowLong(Handle, GWL_EXSTYLE, GetWindowLong(Handle, GWL_EXSTYLE) or WS_EX_APPWINDOW);
  // œÓ‰ÒÍ‡ÁÍ‡ ÔÓ Ô‡‡ÏÂÚ‡Ï Á‡ÔÛÒÍ‡
  if GetSysLang = '–ÛÒÒÍËÈ' then
  begin
    CmdHelpStr := 'œ‡‡ÏÂÚ˚ Á‡ÔÛÒÍ‡ ' + ProgramsName + ' v' + ProgramsVer + ':' + #13 +
    '----------------------------------------------------------' + #13#13 +
    'HistoryToDBSync.exe <1> <2> <3>' + #13#13 +
    '<1> - (Œ·ˇÁ‡ÚÂÎ¸Ì˚È Ô‡‡ÏÂÚ) - œÛÚ¸ ‰Ó Ù‡ÈÎ‡ ÔÎ‡„ËÌ‡ *HistoryToDB.dll, Ú‡Ï ÊÂ ‰ÓÎÊÂÌ ·˚Ú¸ Í‡Ú‡ÎÓ„ lang Ò Ù‡ÈÎ‡ÏË ÎÓÍ‡ÎËÁ‡ˆËË (Õ‡ÔËÏÂ: "C:\Program Files\QIP Infium\Plugins\QIPHistoryToDB\")' + #13#13 +
    '<2> - (Œ·ˇÁ‡ÚÂÎ¸Ì˚È Ô‡‡ÏÂÚ) - œÛÚ¸ ‰Ó Ù‡ÈÎ‡ Ì‡ÒÚÓÂÍ HistoryToDB.ini (Õ‡ÔËÏÂ: "C:\Program Files\QIP Infium\Profiles\username@qip.ru\Plugins\QIPHistoryToDB\")' + #13#13 +
    '<3> - (ÕÂÓ·ˇÁ‡ÚÂÎ¸Ì˚È Ô‡‡ÏÂÚ) - –ÂÊËÏ ‡·ÓÚ˚' + #13#13 +
    '¬ÓÁÏÓÊÌ˚Â ÁÌ‡˜ÂÌËˇ ÂÊËÏ‡ ‡·ÓÚ˚:' + #13 +
    '0 - ¿ÍÚË‚ËÓ‚‡Ú¸ ‚Â‰ÂÌËÂ ËÒÚÓËË ˜‡ÚÓ‚ Skype';
  end
  else
  begin
    CmdHelpStr := 'Startup options ' + ProgramsName + ' v' + ProgramsVer + ':' + #13 +
    '--------------------------------------------' + #13#13 +
    'HistoryToDBSync.exe <1> <2>' + #13#13 +
    '<1> - (Required) - The path to the plugin file *HistoryToDB.dll, there must be a directory lang files localization (Example: "C:\Program Files\QIP Infium\Plugins\QIPHistoryToDB\")' + #13#13 +
    '<2> - (Required) - The path to the configuration file HistoryToDB.ini (Example: "C:\Program Files\QIP Infium\Profiles\username@qip.ru\Plugins\QIPHistoryToDB\")' + #13#13 +
    '<3> - (Optional) - Mode' + #13#13 +
    'Values:' + #13 +
    '0 - Activate recording Skype chat history';
  end;
  // œÓ‚ÂÍ‡ ‚ıÓ‰Ì˚ı Ô‡‡ÏÂÚÓ‚
  if ParamCount < 2 then
  begin
    HistoryMainFormHidden := True;
    MsgInf(ProgramsName, CmdHelpStr);
    Exit;
  end
  else
  begin
    PluginPath := ParamStr(1);
    ProfilePath := ParamStr(2);
    // œÓ‚ÂˇÂÏ Ì‡ÎË˜ËÂ Í‡Ú‡ÎÓ„‡ Ë Ù‡ÈÎ‡ Ì‡ÒÚÓÈÍË
    if not DirectoryExists(ProfilePath) then
      CreateDir(ProfilePath);
    Path := ProfilePath + ININame;
    // —ÓÒÚÓˇÌËÂ ÙÓÏ˚
    AppIniFileStorage.FileName := ProfilePath + 'HistoryToDBForms.ini';
    // »ÌËˆË‡ÎËÁ‡ˆËˇ ÍËÔÚÓ‚‡ÌËˇ
    EncryptInit;
    // ◊ËÚ‡ÂÏ Ì‡ÒÚÓÈÍË
    LoadINI(ProfilePath, True);
    // Õ‡ÒÚÓÈÍË Skype
    if (ParamStr(3) <> '') and IsNumber(ParamStr(3)) then
    begin
      if ParamStr(3) = '0' then
      begin
        if not GlobalSkypeSupport then
          WriteCustomINI(ProfilePath, 'Main', 'SkypeSupport', '1');
        GlobalSkypeSupportOnRun := True;
        GlobalSkypeSupport := True;
        if IMClientType <> 'Skype' then
          WriteCustomINI(ProfilePath, 'Main', 'IMClientType', 'Skype');
        IMClientType := 'Skype';
      end
      else
      begin
        HistoryMainFormHidden := True;
        MsgInf(ProgramsName, CmdHelpStr);
        Exit;
      end;
    end;
    GlobalSkypeSupportOnRun := GlobalSkypeSupport;
    // ”ÒÚ‡Ì‡‚ÎË‚‡ÂÏ Ì‡ÒÚÓÈÍË ÒÓÂ‰ËÌÂÌËˇ Ò ¡ƒ
    LoadDBSettings;
    // «‡„ÛÊ‡ÂÏ Ì‡ÒÚÓÈÍË ÎÓÍ‡ÎËÁ‡ˆËË
    FLanguage := DefaultLanguage;
    LangDoc := NewXMLDocument();
    if not DirectoryExists(PluginPath + dirLangs) then
      CreateDir(PluginPath + dirLangs);
    if not FileExists(PluginPath + dirLangs + defaultLangFile) then
    begin
      HistoryMainFormHidden := True;
      if GetSysLang = '–ÛÒÒÍËÈ' then
        CmdHelpStr := '‘‡ÈÎ ÎÓÍ‡ÎËÁ‡ˆËË ' + PluginPath + dirLangs + defaultLangFile + ' ÌÂ Ì‡È‰ÂÌ.'
      else
        CmdHelpStr := 'The localization file ' + PluginPath + dirLangs + defaultLangFile + ' is not found.';
      MsgInf(ProgramsName, CmdHelpStr);
      // ŒÒ‚Ó·ÓÊ‰‡ÂÏ ÂÒÛÒ˚
      EncryptFree;
      Exit;
    end;
    CoreLanguageChanged;
    // —ËÒÚÂÈ
    HistoryToDBSyncTray.Hint := MainSyncForm.Caption;
    HistoryToDBSyncTray.IconVisible := not HideSyncIcon;
    HistoryToDBSyncTray.PopupMenu := HistoryToDbSyncPopupMenu;
    HistoryToDbSyncPopupMenu.Items[0].Hint := 'HistoryToDBSyncPopupMenuShow';
    // ŒÚÓ·‡Ê‡ÂÏ Ì‡ÒÚÓÈÍË ÒËÌıÓÌËÁ‡ˆËË
    ShowSyncSettings;
    // –Â„ËÒÚËÛÂÏ „Ó. ÍÎ‡‚Ë¯Ë
    JvSyncHotKey := TJvApplicationHotKey.Create(self);
    with JvSyncHotKey do
    begin
      HotKey := TextToShortCut(SyncHotKey);
      Active := False;
      OnHotKey := DoHotKey;
    end;
    RegisterHotKeys;
    // «‡ÔÛÒÍ ÒËÌıÓÌËÁ‡ˆËË ÔÓ ‚ÂÏÂÌË
    RunTimeSync;
    // –‡ÁÂ¯ËÚ¸ ÒËÌıÓÌËÁ‡ˆË˛ ËÁ Ù‡ÈÎ‡ HistoryToDBImport.sql
    HistoryImportEnable := True;
    // ÀÓ„„ËÓ‚‡ÌËÂ SQL Á‡ÔÓÒÓ‚
    if EnableDebug then
      ZSQLMonitor1.Active := True;
    // «‡„ÛÊ‡ÂÏ Ì‡ÒÚÓÈÍË ÎÓÍ‡ÎËÁ‡ˆËË
    LoadLanguageStrings;
    // œÓ‰‰ÂÊÍ‡ Skype
    if GlobalSkypeSupport then
    begin
      EnableSkype;
      if (not SkypeInit) and (IMClientType = 'Skype') then
      begin
        HistoryMainFormHidden := True;
        CmdHelpStr := GetLangStr('HistoryToDBSyncSkypeInitErr') + #13 +
          GetLangStr('HistoryToDBSyncSkypeNotFound');
        if IMClientType <> 'Unknown' then
          MsgInf(ProgramsName + ' for ' + IMClientType, CmdHelpStr)
        else
          MsgInf(ProgramsName, CmdHelpStr);
        Exit;
      end;
    end
    else
    begin
      LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeOff');
      LSkypeStatus.Hint := 'HistoryToDBSyncSkypeOff';
    end;
    // Œ·‡·‡Ú˚‚‡ÂÏ ‚ÒÂ ËÒÍÎ˛˜ÂÌËˇ Ò‡ÏË
    Forms.Application.OnException := IMExcept;
    // MMF
    if SyncMethod = 0 then
      FMap := TMapStream.CreateEx('HistoryToDB for ' + IMClientType + ' (' + MyAccount + ')',MAXDWORD,2000);
    // œÓ„‡ÏÏ‡ Á‡ÔÛ˘ÂÌ‡
    RunAppDone := True;
    // «‡ÔÛÒÍ Ó·ÌÓ‚ÎÂÌËˇ ¡ƒ
    if not MatchStrings(DBAddress, '*.im-history.ru') then
      CheckDBUpdate(PluginPath);
  end;
  // End
end;

procedure TMainSyncForm.FormShow(Sender: TObject);
begin
  // œÂÂÏÂÌÌ‡ˇ ‰Îˇ ÂÊËÏ‡ ‡ÌÚË-·ÓÒÒ
  Global_MainForm_Showing := True;
  // œÓÁ‡˜ÌÓÒÚ¸ ÓÍÌ‡
  AlphaBlend := AlphaBlendEnable;
  AlphaBlendValue := AlphaBlendEnableValue;
end;

procedure TMainSyncForm.FormKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key = VK_ESCAPE then
  begin
    HistoryToDBSyncTray.HideMainForm;
    HistoryMainFormHidden := True;
    HistoryToDbSyncPopupMenu.Items[0].Caption := GetLangStr('HistoryToDBSyncPopupMenuShow');
    HistoryToDbSyncPopupMenu.Items[0].Hint := 'HistoryToDBSyncPopupMenuShow';
  end;
end;

procedure TMainSyncForm.FormCloseQuery(Sender: TObject; var CanClose: Boolean);
begin
  CanClose := ((HistoryMainFormHidden) or SessionEnding);
  if not CanClose then
  begin
    HistoryToDBSyncTray.HideMainForm;
    HistoryMainFormHidden := True;
    HistoryToDbSyncPopupMenu.Items[0].Caption := GetLangStr('HistoryToDBSyncPopupMenuShow');
    HistoryToDbSyncPopupMenu.Items[0].Hint := 'HistoryToDBSyncPopupMenuShow';
  end;
end;

procedure TMainSyncForm.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  // œÂÂÏÂÌÌ‡ˇ ‰Îˇ ÂÊËÏ‡ ‡ÌÚË-·ÓÒÒ
  Global_MainForm_Showing := False;
end;

procedure TMainSyncForm.FormDestroy(Sender: TObject);
begin
  if RunAppDone then
  begin
    // ¬˚ıÓ‰ ËÁ Skype
    if Global_ExitSkypeOnEnd then
    begin
      if Assigned(Skype) then
      begin
        if Skype.Client.IsRunning then
          Skype.Client.Shutdown;
      end;
    end;
    // ŒÚÍÎ˛˜‡ÂÏ Skype
    DisableSkype;
    // ŒÒ‚Ó·ÓÊ‰‡ÂÏ ÂÒÛÒ˚
    EncryptFree;
    // –‡ÁÂ„ËÒÚ‡ˆËˇ „Ó. ÍÎ‡‚Ë¯
    UnRegisterHotKeys;
    // MMF
    if Assigned(FMap) then
      FMap.Free;
    // «‡‚Â¯‡ÂÏ ÔÓÚÓÍË
    if not SyncThread.Terminated then
      SyncThread.Terminate;
    if not CheckMD5HashThread.Terminated then
      CheckMD5HashThread.Terminate;
    if not UpdateContactListThread.Terminated then
      UpdateContactListThread.Terminate;
    while not (SyncThread.Terminated) do
    begin
      Sleep(10);
      Forms.Application.ProcessMessages;
    end;
    while not (CheckMD5HashThread.Terminated) do
    begin
      Sleep(10);
      Forms.Application.ProcessMessages;
    end;
    while not (UpdateContactListThread.Terminated) do
    begin
      Sleep(10);
      Forms.Application.ProcessMessages;
    end;
  end;
end;

{ œÓÍ‡Á˚‚‡ÂÏ ÓÍÌÓ Œ ÔÓ„‡ÏÏÂ }
procedure TMainSyncForm.AboutClick(Sender: TObject);
begin
  AboutForm.Show;
end;

{ –Â„ËÒÚËÛÂÏ „ÎÓ·‡Î¸Ì˚Â „Óˇ˜ËÂ ÍÎ‡‚Ë¯Ë }
procedure TMainSyncForm.RegisterHotKeys;
begin
  if (SyncHotKey <> '') and GlobalHotKeyEnable then
  begin
    with JvSyncHotKey do
    begin
      HotKey := TextToShortCut(SyncHotKey);
      Active := True;
    end;
  end
  else
    JvSyncHotKey.Active := False;
end;

{ –‡ÁÂ„ËÒÚËÛÂÏ „ÎÓ·‡Î¸Ì˚Â „Óˇ˜ËÂ ÍÎ‡‚Ë¯Ë }
procedure TMainSyncForm.UnRegisterHotKeys;
begin
  if Assigned(JvSyncHotKey) then
    JvSyncHotKey.Free;
end;

{ Œ·‡·ÓÚÍ‡ „Óˇ˜Ëı ÍÎ‡‚Ë¯ }
procedure TMainSyncForm.DoHotKey(Sender:TObject);
begin
  if ShortCutToText((Sender as TJvApplicationHotKey).HotKey) = SyncHotKey then
    SyncButtonClick(SyncButton);
end;

{ ŒÚÍ˚Ú¸ ËÒÚÓË˛ }
procedure TMainSyncForm.HistoryShowClick(Sender: TObject);
var
  WinName: String;
begin
  // »˘ÂÏ ÓÍÌÓ HistoryToDBViewer
  WinName := 'HistoryToDBViewer';
  if not SearchMainWindow(pWideChar(WinName)) then // ≈ÒÎË HistoryToDBViewer ÌÂ Ì‡È‰ÂÌ, ÚÓ Ë˘ÂÏ ‰Û„ÓÂ ÓÍÌÓ
  begin
    WinName := 'HistoryToDBViewer for ' + IMClientType + ' (' + MyAccount + ')';
    if not SearchMainWindow(pWideChar(WinName)) then // ≈ÒÎË HistoryToDBViewer ÌÂ Á‡ÔÛ˘ÂÌ, ÚÓ Á‡ÔÛÒÍ‡ÂÏ
    begin
      if FileExists(PluginPath + 'HistoryToDBViewer.exe') then
        ShellExecute(0, 'open', PWideChar(PluginPath + 'HistoryToDBViewer.exe'), PWideChar(' "'+PluginPath+'" "'+ProfilePath+'"'), nil, SW_SHOWNORMAL)
      else
        ShowBalloonHint(MainSyncForm.Caption, Format(GetLangStr('ERR_NO_FOUND_VIEWER'), [PluginPath + 'HistoryToDBViewer.exe']));
    end
    else
      OnSendMessageToAllComponent('0040');
  end
  else
    OnSendMessageToAllComponent('0040');
end;

{ ŒÚÓ·‡Ê‡ÂÏ Ì‡ÒÚÓÈÍË ÔÓ„‡ÏÏ˚ }
procedure TMainSyncForm.ShowSettingsClick(Sender: TObject);
var
  WinName: String;
begin
  // »˘ÂÏ ÓÍÌÓ HistoryToDBViewer
  WinName := 'HistoryToDBViewer';
  if not SearchMainWindow(pWideChar(WinName)) then // ≈ÒÎË HistoryToDBViewer ÌÂ Ì‡È‰ÂÌ, ÚÓ Ë˘ÂÏ ‰Û„ÓÂ ÓÍÌÓ
  begin
    WinName := 'HistoryToDBViewer for ' + IMClientType + ' (' + MyAccount + ')';
    if not SearchMainWindow(pWideChar(WinName)) then // ≈ÒÎË HistoryToDBViewer ÌÂ Á‡ÔÛ˘ÂÌ, ÚÓ Á‡ÔÛÒÍ‡ÂÏ
    begin
      if FileExists(PluginPath + 'HistoryToDBViewer.exe') then
      begin
        // ŒÚÔ‡‚ÎÂÌ Á‡ÔÓÒ Ì‡ ÔÓÍ‡Á Ì‡ÒÚÓÂÍ
        WriteCustomINI(ProfilePath, 'Main', 'SettingsFormRequestSend', '1');
        ShellExecute(0, 'open', PWideChar(PluginPath + 'HistoryToDBViewer.exe'), PWideChar(' "'+PluginPath+'" "'+ProfilePath+'" 4'), nil, SW_SHOWNORMAL);
      end
      else
        ShowBalloonHint(MainSyncForm.Caption, Format(GetLangStr('ERR_NO_FOUND_VIEWER'), [PluginPath + 'HistoryToDBViewer.exe']));
    end
    else // »Ì‡˜Â ÔÓÒ˚Î‡ÂÏ Á‡ÔÓÒ Ì‡ ÔÓÍ‡Á Ì‡ÒÚÓÂÍ
      OnSendMessageToAllComponent('005');
  end
  else // »Ì‡˜Â ÔÓÒ˚Î‡ÂÏ Á‡ÔÓÒ Ì‡ ÔÓÍ‡Á Ì‡ÒÚÓÂÍ
    OnSendMessageToAllComponent('005');
end;

{ ŒÚÓ·‡Ê‡ÂÏ Ì‡ÒÚÓÈÍË ÒËÌıÓÌËÁ‡ˆËË }
procedure TMainSyncForm.ShowSyncSettings;
begin
    case SyncMethod of
      0: LSyncMethodSet.Caption := GetLangStr('CBSyncMethodAuto');
      1: LSyncMethodSet.Caption := GetLangStr('CBSyncMethodManual');
      2: LSyncMethodSet.Caption := GetLangStr('CBSyncMethodOnSchedule');
    end;
    if (SyncMethod = 0) or (SyncMethod = 1) then
      LSyncIntervalSet.Caption := GetLangStr('HistoryToDBSyncNotSpecified')
    else
    begin
      case SyncInterval of
        0: LSyncIntervalSet.Caption := GetLangStr('CBSyncInterval5Min');
        1: LSyncIntervalSet.Caption := GetLangStr('CBSyncInterval10Min');
        2: LSyncIntervalSet.Caption := GetLangStr('CBSyncInterval20Min');
        3: LSyncIntervalSet.Caption := GetLangStr('CBSyncInterval30Min');
        4: LSyncIntervalSet.Caption := GetLangStr('CBSyncIntervalExitProgram');
        5: LSyncIntervalSet.Caption := GetLangStr('CBSyncInterval10Mes');
        6: LSyncIntervalSet.Caption := GetLangStr('CBSyncInterval20Mes');
        7: LSyncIntervalSet.Caption := GetLangStr('CBSyncInterval30Mes');
        8: LSyncIntervalSet.Caption := GetLangStr('CBSyncIntervalNMin');
        9: LSyncIntervalSet.Caption := GetLangStr('CBSyncIntervalNMes');
      end;
    end;
end;

{  ÎËÍ ÔÓ ÔÛÌÍÚÛ ¬˚ıÓ‰ ÍÓÌÚÂÍÒÚÌÓ„Ó ÏÂÌ˛ ‚ ÚÂÂ }
procedure TMainSyncForm.HistoryExitClick(Sender: TObject);
begin
  HistoryMainFormHidden := True;
  Close;
end;

{  ÎËÍ ÔÓ ÔÛÌÍÚÛ —Í˚Ú¸/œÓÍ‡Á‡Ú¸ ÍÓÌÚÂÍÒÚÌÓ„Ó ÏÂÌ˛ ‚ ÚÂÂ }
procedure TMainSyncForm.HistoryMainFormClick(Sender: TObject);
begin
  if HistoryMainFormHidden then
  begin
    HistoryToDBSyncTray.ShowMainForm;
    HistoryMainFormHidden := False;
    HistoryToDbSyncPopupMenu.Items[0].Caption := GetLangStr('HistoryToDBSyncPopupMenuHide');
    HistoryToDbSyncPopupMenu.Items[0].Hint := 'HistoryToDBSyncPopupMenuHide';
  end
  else
  begin
    Forms.Application.Minimize;
    HistoryToDBSyncTray.HideMainForm;
    HistoryMainFormHidden := True;
    HistoryToDbSyncPopupMenu.Items[0].Caption := GetLangStr('HistoryToDBSyncPopupMenuShow');
    HistoryToDbSyncPopupMenu.Items[0].Hint := 'HistoryToDBSyncPopupMenuShow';
  end;
end;

{ —Ó·˚ÚËÂ ÔÂÂ‰ ÔÓÍ‡ÁÓÏ ÍÓÌÚÂÍÚÒÌÓ„Ó ÏÂÌ˛ ‚ ÚÂÂ }
procedure TMainSyncForm.HistoryToDbSyncPopupMenuPopup(Sender: TObject);
begin
  // ¡ÎÓÍÛÂÏ ÔÛÌÍÚ˚ ÏÂÌ˛
  if (SyncHistoryStartedEnabled) or (CheckMD5HashStartedEnabled) or (UpdateContactListStartedEnabled) then
  begin
    HistoryToDbSyncPopupMenu.Items[2].Enabled := False;
    HistoryToDbSyncPopupMenu.Items[5].Enabled := False;
    HistoryToDbSyncPopupMenu.Items[6].Enabled := False;
    HistoryToDbSyncPopupMenu.Items[7].Enabled := False;
  end
  else
  begin
    HistoryToDbSyncPopupMenu.Items[2].Enabled := True;
    HistoryToDbSyncPopupMenu.Items[5].Enabled := True;
    HistoryToDbSyncPopupMenu.Items[6].Enabled := True;
    HistoryToDbSyncPopupMenu.Items[7].Enabled := True;
  end;
  if FileExists(ProfilePath+ContactListName) and (not SyncHistoryStartedEnabled) and (not CheckMD5HashStartedEnabled) then
    HistoryToDbSyncPopupMenu.Items[7].Enabled := True
  else
    HistoryToDbSyncPopupMenu.Items[7].Enabled := False;
end;

procedure TMainSyncForm.HistoryToDBSyncTrayStartup(Sender: TObject; var ShowMainForm: Boolean);
begin
  ShowMainForm := False;
  HistoryMainFormHidden := True;
end;

{ ŒÒÚ‡Ì‡‚ÎË‚‡ÂÏ ÒËÌıÓÌËÁ‡ˆË˛ ÔÓ ‚ÂÏÂÌË }
procedure TMainSyncForm.StartStopSyncButtonClick(Sender: TObject);
begin
  if SyncTimerEnabled then
  begin
    StartStopSyncButton.Caption := GetLangStr('HistoryToDBSyncStart');
    StartStopSyncButton.Hint := 'HistoryToDBSyncStart';
    StopJvSyncTimer;
  end
  else
  begin
    StartStopSyncButton.Caption := GetLangStr('HistoryToDBSyncStop');
    StartStopSyncButton.Hint := 'HistoryToDBSyncStop';
    StartJvSyncTimer;
  end;
  if SyncTimerEnabled then
  begin
    LSyncStatusSet.Caption := GetLangStr('HistoryToDBSyncStarted');
    LSyncStatusSet.Hint := 'HistoryToDBSyncStarted';
  end
  else
  begin
    LSyncStatusSet.Caption := GetLangStr('HistoryToDBSyncStoped');
    LSyncStatusSet.Hint := 'HistoryToDBSyncStoped';
  end;
end;

{ œÂÂÒ˜ËÚ‡Ú¸ ‚ÒÂ MD5-ı˝¯Ë ‚ ¡ƒ }
procedure TMainSyncForm.StartCheckMD5Click(Sender: TObject);
begin
  if (not SyncHistoryStartedEnabled) and (not CheckMD5HashStartedEnabled) and (not UpdateContactListStartedEnabled) then
  begin
    DeleteDublicate := False;
    StartCheckMD5Hash;
  end;
end;

{ œÂÂÒ˜ËÚ‡Ú¸ ‚ÒÂ MD5-ı˝¯Ë ‚ ¡ƒ Ë Û‰‡ÎËÚ¸ ‰Û·ÎËÍ‡Ú˚ }
procedure TMainSyncForm.StartCheckAndDeleteMD5Click(Sender: TObject);
begin
  if (not SyncHistoryStartedEnabled) and (not CheckMD5HashStartedEnabled) and (not UpdateContactListStartedEnabled) then
  begin
    DeleteDublicate := True;
    StartCheckMD5Hash;
  end;
end;

{ Œ·ÌÓ‚ËÚ¸ ‰‡ÌÌ˚Â ÍÓÌÚ‡ÍÚÓ‚ ‚ ¡ƒ }
procedure TMainSyncForm.StartUpdateContactListsClick(Sender: TObject);
begin
  if (not SyncHistoryStartedEnabled) and (not CheckMD5HashStartedEnabled) and (not UpdateContactListStartedEnabled) then
    StartUpdateContactList;
end;

{ œÓÍ‡Á˚‚‡ÂÏ ÓÍÌÓ ÎÓ„-Ù‡ÈÎÓ‚ }
procedure TMainSyncForm.LogViewButtonClick(Sender: TObject);
begin
  LogForm.Show;
end;

{ ¬˚ÔÓÎÌËÚ¸ ÒËÌıÓÌËÁ‡ˆË˛ }
procedure TMainSyncForm.SyncButtonClick(Sender: TObject);
var
  Status: Integer;
  CurrentEncryptionKeyID: String;
  ImportMsgPath, MsgPath, Path: WideString;
begin
  if (not SyncHistoryStartedEnabled) and (not CheckMD5HashStartedEnabled) and (not UpdateContactListStartedEnabled) then
  begin
    // ¬˚·Ó Ù‡ÈÎ‡ ‰Îˇ ˜ÚÂÌËˇ
    MsgPath := ProfilePath + MesLogName;
    ImportMsgPath := ProfilePath + ImportLogName;
    if FileExists(MsgPath) or FileExists(ImportMsgPath) then
    begin
      // ≈ÒÎË ‚ÍÎ˛˜ÂÌÓ ¯ËÙÓ‚‡ÌËÂ
      if EnableHistoryEncryption then
      begin
        // œÓ‚ÂˇÂÏ ‡ÍÚË‚ÌÓÒÚ¸ ÍÎ˛˜‡ ¯ËÙÓ‚‡ÌËˇ
        CurrentEncryptionKeyID := '0';
        Status := GetCurrentEncryptionKeyID(CurrentEncryptionKeyID);
        if Status = 1 then // ¬ÒÂ ıÓÓ¯Ó
        begin
          if CurrentEncryptionKeyID <> EncryptionKeyID then
            EncryptionKey := '';
        end
        else if Status = 2 then // Œ¯Ë·Í‡ - Õ‡È‰ÂÌÓ ·ÓÎÂÂ 1 ‡ÍÚ. ÍÎ˛˜‡
        begin
          ShowBalloonHint(MainSyncForm.Caption + ' - ' + GetLangStr('HistoryToDBSyncCheckEncKey'), GetLangStr('HistoryToDBSyncMultiActiveKey'));
          EncryptionKey := '';
        end
        else if Status = 3 then // Œ¯Ë·Í‡ - ÕÂ Ì‡È‰ÂÌÓ ‡ÍÚ. ÍÎ˛˜ÂÈ
        begin
          ShowBalloonHint(MainSyncForm.Caption + ' - ' + GetLangStr('HistoryToDBSyncCheckEncKey'), GetLangStr('HistoryToDBSyncErrActiveKey'));
          EncryptionKey := '';
        end
        else // Œ¯Ë·Í‡ - ÕÂÚ ‰ÓÒÚÛÔ‡ Í ¡ƒ
        begin
          ShowBalloonHint(MainSyncForm.Caption + ' - ' + GetLangStr('HistoryToDBSyncCheckEncKey'), GetLangStr('ErrDBConnect'));
          EncryptionKey := '';
        end
      end;
      // ≈ÒÎË ‚ÍÎ˛˜ÂÌÓ ¯ËÙÓ‚‡ÌËÂ, ÚÓ ˜ËÚ‡ÂÏ ÍÎ˛˜, ÒÔ‡¯Ë‚ÂÏ Â„Ó Ô‡ÓÎ¸
      if EnableHistoryEncryption and (EncryptionKey = '') and (Status = 1) and (not Global_KeyPasswdForm_Showing) then
        ReadEncryptionKey;
      // œÓÍ‡ ÓÍÌÓ Ô‡ÓÎˇ ÌÂ Á‡Í˚ÚÓ, ÒËÌıÓÌËÁ‡ˆËË ÌÂ ·Û‰ÂÚ!
      if (not SyncHistoryStartedEnabled) and (not Global_KeyPasswdForm_Showing) then
      begin
        if not SyncThread.Terminated then
          SyncThread.Terminate;
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SyncButtonClick: «‡ÔÛÒÍ HistoryToDBInsertThread', 2);
        SyncThread.Execute(Self);
      end;
    end
    else
    begin
      // ¬˚ıÓ‰ ËÁ ÔÓ„‡ÏÏ˚ ÔÓ ÓÚÎÓÊÂÌÌÓÏÛ Á‡ÔÓÒÛ
      if CloseRequest then
        HistoryExitClick(Self);
    end;
  end;
end;

{ ƒÓ·‡‚ÎˇÂÏ ÒÓÓ·˘ÂÌËˇ ‚ ¡ƒ }
procedure TMainSyncForm.SyncThreadExecute(Sender: TObject; Params: Pointer);
var
  ImportMsgPath, MsgPath, Path: WideString;
  SyncQuery: TZQuery;
  StrList: TStringList;
  ErrStrList: TStringList;
  DublicateMesCount, BadMesCount, StrListIndex: Integer;
  MesCurrentCount, EncMsgCount: Integer;
  StartTime: TDateTime;
  EncryptSQLMsg, ErrStr: String;
begin
  SyncHistoryStartedEnabled := True;
  SyncDone := False;
  // ¬˚·Ó Ù‡ÈÎ‡ ‰Îˇ ˜ÚÂÌËˇ
  MsgPath := ProfilePath + MesLogName;
  ImportMsgPath := ProfilePath + ImportLogName;
  if HistoryImportEnable and FileExists(ImportMsgPath) then
    Path := ImportMsgPath
  else
    Path := MsgPath;
  // End
  if FileExists(Path) then
  begin
    try
      if not ZConnection1.Connected then
        ZConnection1.Connect;
    except
      on e: Exception do
      begin
        if not ReConnectDB then
          Exit;
      end;
    end;
    if ZConnection1.Connected then
    begin
      // ŒÚÍÎ˛˜‡ÂÏ ‚ÒÔÓÏ. ÔÓˆÂ‰Û˚, ‚˚‚Ó‰ËÏ ÒÓÓ·˘ÂÌËˇ Ë Ú.Ô.
      TMainSyncForm(Params).ThreadMsgNum := 1;
      TMainSyncForm(Params).ThreadMsgStr := '';
      //TMainSyncForm(Params).ThreadMsgStr := GetLangStr('HistoryToDBSyncStartTrayMsg');
      SyncThread.Synchronize(TMainSyncForm(Params).SyncThreadShowMessage);
      // ¬ÂÏˇ Ì‡˜‡Î‡
      StartTime := Now();
      // ƒÂÎ‡ÂÏ ‚ÂÎËÍËÈ ËÁ‚‡Ú Ò TStringList
      // ÕÂÔÓÌˇÚÌÓ ÔÓ˜ÂÏÛ, ÌÓ ÂÒÎË „ÛÁËÏ Ù‡ÈÎ ËÁ N ÒÚÓÍ ˜ÂÂÁ SQL.SQL.LoadFromFile(Path)
      // ÚÓ ÔË SQL.Execute ‚ ·‡ÁÛ ÔÓÔ‡‰‡ÂÚ ÚÓÎ¸ÍÓ ÔÂ‚‡ˇ ÒÚÓÍ‡ ËÎË Ë‰ÂÚ Ó¯Ë·Í‡
      StrList := TStringList.Create;
      ErrStrList := TStringList.Create;
      SyncQuery := TZQuery.Create(nil);
      SyncQuery.Connection := ZConnection1;
      SyncQuery.ParamCheck := False;
      // œÂÂËÏÂÌÓ‚˚‚‡ÂÏ ÓÒÌÓ‚ÌÓÈ ÎÓ„ ‚Ó ‚ÂÏÂÌÌ˚È
      if FileExists(Path + '.temp') then
        DeleteFile(Path + '.temp');
      RenameFile(Path, Path + '.temp');
      // ƒÂÎ‡ÂÏ ‚ÂÎËÍËÈ ËÁ‚‡Ú Ò TStringList
      // ÕÂÔÓÌˇÚÌÓ ÔÓ˜ÂÏÛ, ÌÓ ÂÒÎË „ÛÁËÏ Ù‡ÈÎ ËÁ N ÒÚÓÍ ˜ÂÂÁ SQL.SQL.LoadFromFile(Path)
      // ÚÓ ÔË SQL.Execute ‚ ·‡ÁÛ ÔÓÔ‡‰‡ÂÚ ÚÓÎ¸ÍÓ ÔÂ‚‡ˇ ÒÚÓÍ‡ ËÎË Ë‰ÂÚ Ó¯Ë·Í‡
      StrList.Clear;
      ErrStrList.Clear;
      try
        StrList.LoadFromFile(Path + '.temp');
      except
        on e :
          Exception do
          begin
            TMainSyncForm(Params).ThreadMsgNum := 3;
            TMainSyncForm(Params).ThreadMsgStr := Format(LOAD_TEMP_MSG_NOMSGFILE, [ExtractFileNameEx(Path + '.temp', True)]);
            SyncThread.Synchronize(TMainSyncForm(Params).SyncThreadShowMessage);
            if WriteErrLog then
              WriteInLog(ProfilePath, '[' + FormatDateTime('dd.mm.yy hh:mm:ss', Now) + '] Œ¯Ë·Í‡ ‚˚ÁÓ‚‡ StrList.LoadFromFile('+Path + '.temp)', 1);
            if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SyncThreadExecute: «‡‚Â¯ÂÌËÂ ÔÓÚÓÍ‡ SyncThread.', 2);
            SyncQuery.Close;
            SyncQuery.Free;
            StrList.Free;
            ErrStrList.Free;
            // œÂÂËÏÂÌÓ‚˚‚‡ÂÏ Ù‡ÈÎ *.sql.temp ‚ *.sql
            // »ÎË ÂÒÎË Ù‡ÈÎ *.sql ÛÊÂ ÂÒÚ¸, ÚÓ ÔÂÂËÏÂÌÓ‚˚‚‡ÂÏ *.sql.temp ‚ *.sql.DATETIME
            if (FileExists(Path + '.temp')) and (not FileExists(Path)) then
              RenameFile(Path + '.temp', Path)
            else if (FileExists(Path + '.temp')) and (FileExists(Path)) then
              RenameFile(Path + '.temp', Path + '.' + FormatDateTime('ddmmyyhhmmss', Now));
            SyncDone := False;
            Exit;
          end;
      end;
      // Õ‡ÒÚÓÈÍË Ò˜ÂÚ˜ËÍÓ‚
      MesCurrentCount := 0;
      BadMesCount := 0;
      DublicateMesCount := 0;
      EncMsgCount := 0;
      // ¬˚‚Ó‰ËÏ ÁÌ‡˜ÂÌËˇ Ò˜ÂÚ˜ËÍÓ‚
      TMainSyncForm(Params).ThreadMsgNum := 2;
      TMainSyncForm(Params).SyncMesCurrentCount := 0;
      TMainSyncForm(Params).SyncTotalMesCount := StrList.Count;
      TMainSyncForm(Params).SyncBadMesCount := '0';
      TMainSyncForm(Params).SyncDublicateMesCount := '0';
      TMainSyncForm(Params).SyncEncryptMsgCount := 0;
      TMainSyncForm(Params).SyncStartTime := '00:00:00';
      TMainSyncForm(Params).SyncEndTime := '00:00:00';
      SyncThread.Synchronize(TMainSyncForm(Params).SyncThreadShowMessage);
      // End
      for StrListIndex := 0 to StrList.Count-1 do
      begin
        if SyncThread.Terminated then
        begin
          SyncDone := False;
          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SyncThreadExecute: ›ÍÒÚÂÌÌÓÂ Á‡‚Â¯ÂÌËÂ ÔÓÚÓÍ‡ SyncThread.', 2);
          SyncQuery.Close;
          SyncQuery.Free;
          StrList.Free;
          ErrStrList.Free;
          // œÂÂËÏÂÌÓ‚˚‚‡ÂÏ Ù‡ÈÎ *.sql.temp ‚ *.sql
          // »ÎË ÂÒÎË Ù‡ÈÎ *.sql ÛÊÂ ÂÒÚ¸, ÚÓ ÔÂÂËÏÂÌÓ‚˚‚‡ÂÏ *.sql.temp ‚ *.sql.DATETIME
          if (FileExists(Path + '.temp')) and (not FileExists(Path)) then
            RenameFile(Path + '.temp', Path)
          else if (FileExists(Path + '.temp')) and (FileExists(Path)) then
            RenameFile(Path + '.temp', Path + '.' + FormatDateTime('ddmmyyhhmmss', Now));
          Exit;
        end;
        SyncQuery.SQL.Clear;
        // ÿËÙÓ‚‡ÌËÂ ÒÓÓ·˘ÂÌËÈ
        if EnableHistoryEncryption and (EncryptionKey <> '') then
        begin
          EncryptSQLMsg := ParseSQLAndEncrypt(StrList[StrListIndex], EncryptionKeyID, EncryptionKey, EncMsgCount);
          SyncQuery.SQL.Add(EncryptSQLMsg);
        end
        else // ≈ÒÎË ÌÂÚ ˘ËÙÓ‚‡ÌËˇ
          SyncQuery.SQL.Add(StrList[StrListIndex]);
        try
          SyncQuery.ExecSQL;
        except
          on e: Exception do
          begin
            // œË¯ÂÏ ‚ ÎÓ„, ˜ÚÓ Ó¯Ë·Í‡ ÔË ‰Ó·‡‚ÎÂÌËË Á‡ÔËÒË ‚ ¡ƒ
            if WriteErrLog then
              WriteInLog(ProfilePath, Format(ERR_LOAD_MSG_TO_DB, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), 'Class - ' + E.ClassName + ' | Œ¯Ë·Í‡ - ' + Trim(e.Message)]), 1);
            if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
            begin
              ZConnection1.Disconnect;
              if not ReConnectDB then
              begin
                if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SyncThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
                SyncQuery.Close;
                SyncQuery.Free;
                StrList.Free;
                ErrStrList.Free;
                // œÂÂËÏÂÌÓ‚˚‚‡ÂÏ Ù‡ÈÎ *.sql.temp ‚ *.sql
                // »ÎË ÂÒÎË Ù‡ÈÎ *.sql ÛÊÂ ÂÒÚ¸, ÚÓ ÔÂÂËÏÂÌÓ‚˚‚‡ÂÏ *.sql.temp ‚ *.sql.DATETIME
                if (FileExists(Path + '.temp')) and (not FileExists(Path)) then
                  RenameFile(Path + '.temp', Path)
                else if (FileExists(Path + '.temp')) and (FileExists(Path)) then
                  RenameFile(Path + '.temp', Path + '.' + FormatDateTime('ddmmyyhhmmss', Now));
                Exit;
              end
              else
              begin
                try
                  SyncQuery.ExecSQL;
                except
                end;
              end;
            end;
            // ƒÓ·‡‚ÎˇÂÏ ÓÚ·‡ÍÓ‚‡ÌÌÓÂ ÒÓÓ·˘ÂÌËÂ ‚ ErrStrList
            ErrStrList.Add(StrList[StrListIndex]);
            Inc(BadMesCount);
            ErrStr := Trim(e.Message);
            if MatchStrings(DBType, 'firebird*') then
            begin
              if RegExprMatchStrings(ErrStr, '^(.*)violation of PRIMARY or UNIQUE KEY constraint(.*)on table(.*)') then
                Inc(DublicateMesCount);
            end
            else
            begin
              if (MatchStrings(ErrStr, '*Duplicate entry*for key*')) or
                (MatchStrings(ErrStr, '*column*is not unique*')) or
                (MatchStrings(ErrStr, '*duplicate key value violates unique*')) then
              Inc(DublicateMesCount);
            end;
          end;
        end;
        Inc(MesCurrentCount);
        // ¬˚‚Ó‰ ÒÚ‡ÚËÒÚËÍË
        if CheckQueryRecNo(StrList.Count, MesCurrentCount) then
        begin
          TMainSyncForm(Params).ThreadMsgNum := 2;
          TMainSyncForm(Params).SyncMesCurrentCount := MesCurrentCount-BadMesCount;
          TMainSyncForm(Params).SyncTotalMesCount := StrList.Count;
          TMainSyncForm(Params).SyncBadMesCount := IntToStr(BadMesCount);
          TMainSyncForm(Params).SyncDublicateMesCount := IntToStr(DublicateMesCount);
          if EnableHistoryEncryption and (EncryptionKey <> '') then
            TMainSyncForm(Params).SyncEncryptMsgCount := EncMsgCount-BadMesCount
          else
            TMainSyncForm(Params).SyncEncryptMsgCount := 0;
          TMainSyncForm(Params).SyncStartTime := FormatDateTime('hh:mm:ss', Now() - StartTime);
          TMainSyncForm(Params).SyncEndTime := FormatDateTime('hh:mm:ss', ((Now() - StartTime)/MesCurrentCount)*(StrList.Count-MesCurrentCount));
          TMainSyncForm(Params).ThreadMsgStr := '';
          SyncThread.Synchronize(TMainSyncForm(Params).SyncThreadShowMessage);
        end;
      end;
      // ‘ËÌ‡Î¸Ì‡ˇ ÒËÌıÓÌËÁ‡ˆËˇ
      TMainSyncForm(Params).ThreadMsgNum := 2;
      SyncMesCurrentCount := MesCurrentCount-BadMesCount;
      SyncTotalMesCount := StrList.Count;
      SyncBadMesCount := IntToStr(BadMesCount);
      SyncDublicateMesCount := IntToStr(DublicateMesCount);
      SyncEndTime := '';
      if EnableHistoryEncryption and (EncryptionKey <> '') then
        TMainSyncForm(Params).SyncEncryptMsgCount := EncMsgCount-BadMesCount
      else
        TMainSyncForm(Params).SyncEncryptMsgCount := 0;
      TMainSyncForm(Params).SyncEndTime := '00:00:00';
      TMainSyncForm(Params).ThreadMsgStr := Format(LOAD_TEMP_MSG_SCREEN, [IntToStr(StrList.Count), IntToStr(MesCurrentCount), IntToStr(BadMesCount), IntToStr(DublicateMesCount), IntToStr(SyncEncryptMsgCount)]);
      SyncThread.Synchronize(TMainSyncForm(Params).SyncThreadShowMessage);
      // ≈ÒÎË ÂÒÚ¸ ·‡ÍÓ‚‡ÌÌ˚Â ÒÓÓ·˘ÂÌËˇ, ÚÓ ÔË¯ÂÏ Ëı Ì‡Á‡‰ ‚ tempmeslogname ËÎË meslogname
      if ErrStrList.Count > 0 then
      begin
        // œÓ‚ÂˇÂÏ ‡ÁÏÂ ÎÓ„‡ *.sql.bad
        if (GetMyFileSize(Path + '.bad') > MaxErrLogSize*1024) then
          DeleteFile(Path + '.bad');
        // œË¯ÂÏ ÓÚ·‡ÍÓ‚‡Ì˚Â Ì‡Á‡‰ ‚ MesLogName.bad ËÎË ImportLogName.bad
        ErrStrList.SaveToFile(Path + '.bad');
        // ¬˚‚Ó‰ËÏ ÒÓÓ·˘ÂÌËÂ ‚ ÎÓ„
        if WriteErrLog then
          WriteInLog(ProfilePath, Format(LOAD_TEMP_MSG, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), Path, IntToStr(StrList.Count), IntToStr(StrList.Count-ErrStrList.Count), IntToStr(ErrStrList.Count), IntToStr(DublicateMesCount), IntToStr(SyncEncryptMsgCount)]), 1);
      end;
      SyncQuery.Free;
      StrList.Free;
      ErrStrList.Free;
      // ”‰‡ÎˇÂÏ Ù‡ÈÎ .temp
      if FileExists(Path + '.temp') then
        DeleteFile(Path + '.temp');
      SyncDone := True;
    end;
  end
  else
  begin
    TMainSyncForm(Params).ThreadMsgNum := 3;
    TMainSyncForm(Params).ThreadMsgStr := Format(LOAD_TEMP_MSG_NOMSGFILE, [ExtractFileNameEx(Path, True)]);
    SyncThread.Synchronize(TMainSyncForm(Params).SyncThreadShowMessage);
  end;
end;

procedure TMainSyncForm.SyncThreadFinish(Sender: TObject);
begin
  SyncProgressBar.Position := 0;
  SyncHistoryStartedEnabled := False;
  // Œ˜ËÒÚÍ‡ ÍÎ˛˜‡, ÂÒÎË ÌÂ ÒÚÓËÚ ÒÓı‡ÌÂÌËÂ Ì‡ ÒÂÒÒË˛
  if not KeyPasswdSaveOnlySession then
    EncryptionKey := '';
  // ŒÚÍÎ. ÓÚ ¡ƒ
  if (not CheckMD5HashStartedEnabled) and (not UpdateContactListStartedEnabled) then
    ZConnection1.Disconnect;
  // ¬ÍÎ˛˜‡ÂÏ ÍÌÓÔÍË Ë Ú.Ô.
  EnableButton;
  //  ÓÂÍÚËÛÂÏ ÍÓÎË˜ÂÒÚ‚Ó Á‡¯ËÙÓ‚‡ÌÌ˚ı ÒÓÓ·˘ÂÌËÈ
  LEncryptMesCount.Caption := IntToStr(SyncEncryptMsgCount);
  // ¬˚‚Ó‰ËÏ ÒÚ‡ÚÛÒ
  HistoryToDBSyncTray.Hint := MainSyncForm.Caption;
  LSyncStatusSet.Caption := GetLangStr('HistoryToDBSyncDone');
  LSyncStatusSet.Hint := 'HistoryToDBSyncDone';
  // «‡Í‡Ì˜Ë‚‡ÂÏ ÏË„‡Ú¸ ‚ ÚÂÂ
  if not SyncHistoryStartedEnabled then
    StopSyncTrayFlashingTimer;
  if SyncDone then
  begin
    // «‡ÔÛÒÍ ÒËÌıÓÌËÁ‡ˆËË ÔÓ ‚ÂÏÂÌË
    RunTimeSync;
    if SyncTimerEnabled then
    begin
      StartStopSyncButton.Caption := GetLangStr('HistoryToDBSyncStop');
      StartStopSyncButton.Hint := 'HistoryToDBSyncStop';
    end
    else
    begin
      StartStopSyncButton.Caption := GetLangStr('HistoryToDBSyncStart');
      StartStopSyncButton.Hint := 'HistoryToDBSyncStart';
    end;
  end;
  if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SyncThreadFinish: œÓÚÓÍ SyncThread ‚˚ÔÓÎÌÂÌ.', 2);
  // ¬˚ıÓ‰ ËÁ ÔÓ„‡ÏÏ˚ ÔÓ ÓÚÎÓÊÂÌÌÓÏÛ Á‡ÔÓÒÛ
  if CloseRequest and (not CheckMD5HashStartedEnabled) and (not UpdateContactListStartedEnabled) then
    HistoryExitClick(Self);
end;

{ œÓ‚ÂÍ‡ Ì‡ ÒÂ‚ËÒÌ˚È ÂÊËÏ ¡ƒ }
function TMainSyncForm.CheckServiceMode: Boolean;
var
  ServiceModeQuery: TZQuery;
  System_Disable: Integer;
begin
  if ZConnection1.Connected then
  begin
    ServiceModeQuery := TZQuery.Create(nil);
    ServiceModeQuery.Connection := ZConnection1;
    ServiceModeQuery.ParamCheck := False;
    try
      ServiceModeQuery.SQL.Clear;
      ServiceModeQuery.SQL.Text := 'select config_value from config where config_name = ''system_disable''';
      ServiceModeQuery.Open;
      System_Disable := ServiceModeQuery.FieldByName('config_value').AsInteger;
      ServiceModeQuery.Close;
      if System_Disable = 1 then
      begin
        ShowBalloonHint(MainSyncForm.Caption, GetLangStr('ERR_DB_SERVICE_MODE'));
        if WriteErrLog then
          WriteInLog(ProfilePath, Format(ERR_READ_DB_SERVICE_MODE, [FormatDateTime('dd.mm.yy hh:mm:ss', Now)]), 1);
        Result := True;
      end
      else
        Result := False;
    finally
      ServiceModeQuery.Free;
    end;
  end;
end;

{ «‡ÔÛÒÍ ÔÓ‚ÂÍË Ó·ÌÓ‚ÎÂÌËÈ }
procedure TMainSyncForm.CheckUpdateClick(Sender: TObject);
var
  WinName: String;
begin
  // »˘ÂÏ ÓÍÌÓ HistoryToDBUpdater
  WinName := 'HistoryToDBUpdater';
  if not SearchMainWindow(pWideChar(WinName)) then // ≈ÒÎË HistoryToDBUpdater ÌÂ Ì‡È‰ÂÌ, ÚÓ Ë˘ÂÏ ‰Û„ÓÂ ÓÍÌÓ
  begin
    WinName := 'HistoryToDBUpdater for ' + IMClientType + ' (' + MyAccount + ')';
    if not SearchMainWindow(pWideChar(WinName)) then // ≈ÒÎË HistoryToDBUpdater ÌÂ Á‡ÔÛ˘ÂÌ, ÚÓ Á‡ÔÛÒÍ‡ÂÏ
    begin
      if FileExists(PluginPath + 'HistoryToDBUpdater.exe') then
      begin
        // ŒÚÔ‡‚ÎÂÌ Á‡ÔÓÒ
        ShellExecute(0, 'open', PWideChar(PluginPath + 'HistoryToDBUpdater.exe'), PWideChar(' "'+ProfilePath+'"'), nil, SW_SHOWNORMAL);
      end
      else
        ShowBalloonHint(MainSyncForm.Caption, Format(GetLangStr('ERR_NO_FOUND_UPDATER'), [PluginPath + 'HistoryToDBUpdater.exe']));
    end
    else // »Ì‡˜Â ÔÓÒ˚Î‡ÂÏ Á‡ÔÓÒ
      OnSendMessageToOneComponent(WinName, '0040');
  end
  else // »Ì‡˜Â ÔÓÒ˚Î‡ÂÏ Á‡ÔÓÒ
    OnSendMessageToOneComponent(WinName, '0040');
end;

{ œ‡ÒËÌ„ SQL Insert Á‡ÔÓÒÓ‚ Ë ¯ËÙÓ‚‡ÌËÂ ÔÓÎˇ ÒÓÓ·˘ÂÌËˇ }
function TMainSyncForm.ParseSQLAndEncrypt(SQLStr, EncryptKeyID, EncryptKey: String; var EncryptMsgCount: Integer): WideString;
var
  RegExpMsgType, RegExpChatMsgType, RegExpMsg, RegExpChatMsg: TRegExpr;
  Cipher: TDCP_3des;
  Digest: Array[0..19] of Byte;
  Hash: TDCP_sha1;
  StrReplace, SQLStrTmp: WideString;
begin
  // »ÌËˆË‡ÎËÁ‡ˆËˇ ÙÛÌÍˆËË ıÂ¯ËÓ‚‡ÌËˇ SHA1
  Hash:= TDCP_sha1.Create(Self);
  Hash.Init;
  Hash.UpdateStr(EncryptKey);
  Hash.Final(Digest);
  Hash.Free;
  // »ÌËˆË‡ÎËÁ‡ˆËˇ ÙÛÌÍˆËË ¯ËÙÓ‚‡ÌËˇ 3DES
  Cipher := TDCP_3des.Create(Self);
  Cipher.Init(Digest, Sizeof(Digest)*8, nil);
  // End
  RegExpMsgType := TRegExpr.Create;
  RegExpChatMsgType := TRegExpr.Create;
  RegExpMsg := TRegExpr.Create;
  RegExpChatMsg := TRegExpr.Create;
  try
    // ŒÔÂ‰ÂÎˇÂÏ ÚËÔ ÒÓÓ·˘ÂÌËˇ
    RegExpMsgType.Expression := '^insert into uin_([\w\d\_\-]{1,})';
    RegExpChatMsgType.Expression := '^insert into uin_chat_([\w\d\_\-]{1,})';
    // RegExpr ‰Îˇ ÒÓÓ·˘ÂÌËÈ
    RegExpMsg.Expression := '^insert into uin_([\w\d\_\-]{1,}) values \(null\, ([\d]{1,2})\, ''(.*)''\, ''(.*)''\, '+'''(.*)''\, ' + '''(.*)''\, ([\d]{1})\, ''([\d\-\:\s]{1,})''\, ''(.*)''\, ' + '''([\w\d]{1,})''\, (.*)\)';
    // RegExpr ‰Îˇ ˜‡ÚÓ‚
    RegExpChatMsg.Expression := '^insert into uin_chat_([\w\d\_\-]{1,}) values \(null\, ([\d]{1})\, ''([\d\-\:\s]{1,})''\, ' + '''(.*)''\, ''(.*)''\, ''(.*)''\, ' + '([\d]{1})\, ([\d]{1})\, ([\d]{1})\, ''(.*)''\, ''([\w\d]{1,})''\, (.*)\)';
    SQLStrTmp := UTF8ToWideString(SQLStr);
    if RegExpMsgType.Exec(SQLStr) then
    begin
      if RegExpMsg.Exec(SQLStrTmp) then
      begin
        Cipher.Reset;
        if (MatchStrings(DBType, 'oracle*')) then
          Result := Format(MSG_LOG_ORACLE, [RegExpMsg.Match[1], RegExpMsg.Match[2], WideStringToUTF8(RegExpMsg.Match[3]), WideStringToUTF8(RegExpMsg.Match[4]), WideStringToUTF8(RegExpMsg.Match[5]), WideStringToUTF8(RegExpMsg.Match[6]), RegExpMsg.Match[7], RegExpMsg.Match[8], Cipher.EncryptString(RegExpMsg.Match[9]), RegExpMsg.Match[10], EncryptKeyID])
        else
          Result := Format(MSG_LOG, [RegExpMsg.Match[1], RegExpMsg.Match[2], WideStringToUTF8(RegExpMsg.Match[3]), WideStringToUTF8(RegExpMsg.Match[4]), WideStringToUTF8(RegExpMsg.Match[5]), WideStringToUTF8(RegExpMsg.Match[6]), RegExpMsg.Match[7], RegExpMsg.Match[8], Cipher.EncryptString(RegExpMsg.Match[9]), RegExpMsg.Match[10], EncryptKeyID]);
        Inc(EncryptMsgCount);
      end
      else // ≈ÒÎË ÌÂ ÒÏÓ„ÎË ‡ÒÔ‡ÒËÚ¸ insert-ÒÚÓÍÛ, ÚÓ ÌË˜Â„Ó ÌÂ ¯ËÙÛÂÏ
        Result := SQLStr;
    end;
    {else
      Result := SQLStr;}
    if RegExpChatMsgType.Exec(SQLStr) then
    begin
      if RegExpChatMsg.Exec(SQLStrTmp) then
      begin
        Cipher.Reset;
        if (MatchStrings(DBType, 'oracle*')) then
          Result := Format(CHAT_MSG_LOG_ORACLE, [RegExpChatMsg.Match[1], RegExpChatMsg.Match[2], RegExpChatMsg.Match[3], WideStringToUTF8(RegExpChatMsg.Match[4]), WideStringToUTF8(RegExpChatMsg.Match[5]), WideStringToUTF8(RegExpChatMsg.Match[6]), RegExpChatMsg.Match[7], RegExpChatMsg.Match[8], RegExpChatMsg.Match[9], Cipher.EncryptString(RegExpChatMsg.Match[10]), RegExpChatMsg.Match[11], EncryptKeyID])
        else
          Result := Format(CHAT_MSG_LOG, [RegExpChatMsg.Match[1], RegExpChatMsg.Match[2], RegExpChatMsg.Match[3], WideStringToUTF8(RegExpChatMsg.Match[4]), WideStringToUTF8(RegExpChatMsg.Match[5]), WideStringToUTF8(RegExpChatMsg.Match[6]), RegExpChatMsg.Match[7], RegExpChatMsg.Match[8], RegExpChatMsg.Match[9], Cipher.EncryptString(RegExpChatMsg.Match[10]), RegExpChatMsg.Match[11], EncryptKeyID]);
        Inc(EncryptMsgCount);
      end
      else // ≈ÒÎË ÌÂ ÒÏÓ„ÎË ‡ÒÔ‡ÒËÚ¸ insert-ÒÚÓÍÛ, ÚÓ ÌË˜Â„Ó ÌÂ ¯ËÙÛÂÏ
        Result := SQLStr;
    end;
    {else
      Result := SQLStr;}
  finally
    RegExpMsgType.Free;
    RegExpChatMsgType.Free;
    RegExpMsg.Free;
    RegExpChatMsg.Free;
  end;
  Cipher.Burn;
  Cipher.Free;
end;

{ ”ÒÚ‡Ì‡‚ÎË‚‡ÂÏ Ì‡ÒÚÓÈÍË ÔÓ‰ÍÎ˛˜ÂÌËˇ Í ¡ƒ }
procedure TMainSyncForm.LoadDBSettings;
begin
  ZConnection1.Protocol := DBType;
  if (DBType = 'sqlite') or (DBType = 'sqlite-3') then
  begin
    ZConnection1.HostName := '';
    ZConnection1.Port := 0;
    ZConnection1.User := '';
    ZConnection1.Password := '';
    ZConnection1.Properties.Clear;
  end
  else // MySQL, PostgreSQL, Oracle Ë Ú.Ô.
  begin
    ZConnection1.HostName := DBAddress;
    ZConnection1.Port := StrToInt(DBPort);
    ZConnection1.User := DBUserName;
    ZConnection1.Password := DBPasswd;
    ZConnection1.Properties.Clear;
    ZConnection1.Properties.Add('codepage=UTF8');
  end;
  // «‡ÏÂÌ‡ ÔÓ‰ÒÚÓÍË ‚ ÒÚÓÍÂ DBName
  if MatchStrings(DBName,'<ProfilePluginPath>*') then
    DBName := StringReplace(DBName,'<ProfilePluginPath>',ProfilePath,[RFReplaceall])
  else if MatchStrings(DBName,'<PluginPath>*') then
    DBName := StringReplace(DBName,'<PluginPath>',ExtractFileDir(PluginPath),[RFReplaceall]);
  // End
  ZConnection1.Database := DBName;
  ZConnection1.LoginPrompt := false;
end;

{ Œ·‡·ÓÚ˜ËÍ Á‡ÔÓÒ‡ Í ¡ƒ }
procedure TMainSyncForm.SQL_Zeos_Key(Sql: WideString);
begin
  try
    if ZConnection1.Connected then
    begin
      KeyQuery.Connection := ZConnection1;
      try
        KeyQuery.Close;
        KeyQuery.SQL.Clear;
        KeyQuery.SQL.Text := Sql;
        KeyQuery.Open;
      except
        on e :
          Exception do
          begin
            if WriteErrLog then
              WriteInLog(ProfilePath, Format(ERR_READ_DB_CONNECT_ERR, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), Trim(e.Message)]), 1);
            MsgInf(MainSyncForm.Caption + ' - ' + GetLangStr('ErrCaption'), GetLangStr('ErrSQLQuery') + #13 + Trim(e.Message));
          end;
      end;
    end;
  except
    on e: Exception do
    begin
      if not ZConnection1.Connected then
        ReConnectDB;
    end;
  end;
end;

{ Œ·‡·ÓÚ˜ËÍ Á‡ÔÓÒ‡ Í ¡ƒ }
procedure TMainSyncForm.SQL_Zeos(Sql: WideString);
begin
  try
    if ZConnection1.Connected then
    begin
      MainSyncQuery.Connection := ZConnection1;
      try
        MainSyncQuery.Close;
        MainSyncQuery.SQL.Clear;
        MainSyncQuery.SQL.Text := Sql;
        MainSyncQuery.Open;
      except
        on e :
          Exception do
          begin
            if WriteErrLog then
              WriteInLog(ProfilePath, Format(ERR_READ_DB_CONNECT_ERR, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), Trim(e.Message)]), 1);
            MsgInf(MainSyncForm.Caption + ' - ' + GetLangStr('ErrCaption'), GetLangStr('ErrSQLQuery') + #13 + Trim(e.Message));
          end;
        end;
    end;
  except
    on e: Exception do
    begin
      if not ZConnection1.Connected then
      begin
        ReConnectDB;
      end;
    end;
  end;
end;

{ Œ·‡·ÓÚ˜ËÍ Á‡ÔÓÒ‡ Í ¡ƒ }
procedure TMainSyncForm.SQL_Zeos_Exec(Sql: WideString);
begin
  try
    if ZConnection1.Connected then
    begin
      MainSyncQuery.Connection := ZConnection1;
      if MatchStrings(DBType, 'firebird*') then
        ZConnection1.StartTransaction;
      try
        MainSyncQuery.Close;
        MainSyncQuery.SQL.Clear;
        MainSyncQuery.SQL.Text := Sql;
        MainSyncQuery.ExecSQL;
      except
        on e :
          Exception do
          begin
            if MatchStrings(DBType, 'firebird*') then
              ZConnection1.Rollback;
            if WriteErrLog then
              WriteInLog(ProfilePath, Format(ERR_READ_DB_CONNECT_ERR, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), Trim(e.Message)]), 1);
            MsgInf(MainSyncForm.Caption + ' - ' + GetLangStr('ErrCaption'), GetLangStr('ErrSQLExecQuery') + #13 + Trim(e.Message));
          end;
        end;
      if MatchStrings(DBType, 'firebird*') then
        ZConnection1.Commit;
    end;
  except
    on e: Exception do
    begin
      if not ZConnection1.Connected then
      begin
        ReConnectDB;
      end;
    end;
  end;
end;

{ ¬˚ÔÓÎÌˇÂÚÒˇ ÔÓÒÎÂ ZConnection1.Connection ‰Îˇ ÒÏÂÌ˚ ÒıÂÏ˚ ‚ ¡ƒ Oracle }
procedure TMainSyncForm.ZConnection1AfterConnect(Sender: TObject);
begin
  if MatchStrings(DBType, 'oracle*') then
    SQL_Zeos_Exec('alter session set current_schema='+DBSchema);
  // œÓ‚ÂÍ‡ Ì‡ ÒÂ‚ËÒÌ˚È ÂÊËÏ
  if CheckServiceMode then
  begin
    HistoryToDBSyncTray.IconIndex := 1;
    ZConnection1.Disconnect;
  end
  else
    HistoryToDBSyncTray.IconIndex := 0;
end;

{ ÀÓ„„ËÓ‚‡ÌËÂ SQL Á‡ÔÓÒÓ‚ ‰Îˇ ÓÚÎ‡‰ÍË }
procedure TMainSyncForm.ZSQLMonitor1Trace(Sender: TObject; Event: TZLoggingEvent; var LogTrace: Boolean);
begin
  if Trim(Event.Error) > '' then
    WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Event.Timestamp) + ' - œÓˆÂ‰Û‡ ZSQLMonitor1Trace: ' + UTF8ToString(Trim(Event.Message)) + ' | Error: ' + Event.Error, 2)
  else
    WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Event.Timestamp) + ' - œÓˆÂ‰Û‡ ZSQLMonitor1Trace: ' + UTF8ToString(Trim(Event.Message)), 2);
end;

{ œÓÍ‡Á˚‚‡ÂÏ ‚ÒÔÎ˚‚‡˛˘Â ÒÓÓ·˘ÂÌËÂ ‚ ÚÂÂ }
procedure TMainSyncForm.ShowBalloonHint(BalloonTitle, BalloonMsg: WideString);
var
  DA: TJvDesktopAlert;
begin
  if AniEvents then
  begin
    DA := TJvDesktopAlert.Create(Self);
    DA.AutoFree := True;
    DA.Image := PopupImage.Picture;
    DA.HeaderText := Format('%s (%d)', [BalloonTitle, FCount]);
    DA.MessageText := BalloonMsg;
    DA.OnShow := DoAlertShow;
    DA.OnClose := DoAlertClose;
    DA.Location.AlwaysResetPosition := False;
    DA.Location.Position := dapBottomRight;
    DA.Location.Width := 350;
    DA.Location.Height := 80;
    DA.AlertStyle := asFade;
    DA.StyleHandler.StartInterval := 25;
    DA.StyleHandler.StartSteps := 10;
    DA.StyleHandler.DisplayDuration  := 1400;
    DA.StyleHandler.EndInterval := 50;
    DA.StyleHandler.EndSteps := 10;
    DA.Execute;
  end;
end;

procedure TMainSyncForm.DoAlertShow(Sender: TObject);
begin
  Inc(FCount);
end;

procedure TMainSyncForm.DoAlertClose(Sender: TObject);
begin
  Dec(FCount);
end;

{ œËÂÏ ÛÔ‡‚Îˇ˛˘Ëı ÍÓÏ‡Ì‰ ÓÚ ÔÎ‡„ËÌ‡ ÔÓ ÒÓ·˚ÚË˛ WM_COPYDATA }
procedure TMainSyncForm.OnControlReq(var Msg : TWMCopyData);
var
  ControlStr, EncryptControlStr: String;
  copyDataType : TCopyDataType;
begin
  copyDataType := TCopyDataType(Msg.CopyDataStruct.dwData);
  if copyDataType = cdtString then
  begin
    EncryptControlStr := PChar(Msg.CopyDataStruct.lpData);
    Delete(EncryptControlStr, (Integer(Msg.CopyDataStruct.cbData) div 2)+1, Length(EncryptControlStr));
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ OnControlReq: œÓÎÛ˜ÂÌÓ ¯ËÙÓ‚‡ÌÌÓÂ ÛÔ‡‚Îˇ˛˘ÂÂ ÒÓÓ·˘ÂÌËÂ: ' + EncryptControlStr, 2);
    ControlStr := DecryptStr(EncryptControlStr);
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ OnControlReq: ”Ô‡‚Îˇ˛˘ÂÂ ÒÓÓ·˘ÂÌËÂ ‡Ò¯ËÙÓ‚‡ÌÓ: ' + ControlStr, 2);
    Msg.Result := 2006;
    if ControlStr = 'Russian' then
    begin
      FLanguage := 'Russian';
      CoreLanguageChanged;
    end
    else if ControlStr = 'English' then
    begin
      FLanguage := 'English';
      CoreLanguageChanged;
    end;
    // 001 - œÂÂ˜ËÚ‡Ú¸ Ì‡ÒÚÓÈÍË ËÁ Ù‡ÈÎ‡ HistoryToDB.ini
    if ControlStr = '001' then
    begin
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ OnControlReq: ”Ô‡‚Îˇ˛˘ÂÂ ÒÓÓ·˘ÂÌËÂ ' + ControlStr + ' - ÔÂÂ˜ËÚ˚‚‡ÂÏ Ì‡ÒÚÓÈÍË.', 2);
      // ◊ËÚ‡ÂÏ Ì‡ÒÚÓÈÍË
      LoadINI(ProfilePath, True);
      HistoryToDBSyncTray.IconVisible := not HideSyncIcon;
      // ”ÒÚ‡Ì‡‚ÎË‚‡ÂÏ Ì‡ÒÚÓÈÍË ÒÓÂ‰ËÌÂÌËˇ Ò ¡ƒ
      LoadDBSettings;
      // «‡„ÛÊ‡ÂÏ Ì‡ÒÚÓÈÍË ÎÓÍ‡ÎËÁ‡ˆËË
      FLanguage := DefaultLanguage;
      CoreLanguageChanged;
      // ŒÚÓ·‡Ê‡ÂÏ Ì‡ÒÚÓÈÍË ÒËÌıÓÌËÁ‡ˆËË
      ShowSyncSettings;
      // «‡ÔÛÒÍ ÒËÌıÓÌËÁ‡ˆËË ÔÓ ‚ÂÏÂÌË ÚÓÎ¸ÍÓ ÂÒÎË ÌÂÚ ‰. Á‡‰‡˜
      if (not SyncHistoryStartedEnabled) and (not CheckMD5HashStartedEnabled) and (not UpdateContactListStartedEnabled) then
        RunTimeSync;
      // MMF
      if SyncMethod = 0 then
      begin
        if not Assigned(FMap) then
        begin
          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ OnControlReq: —ÓÁ‰‡ÂÏ TMapStream', 2);
          FMap := TMapStream.CreateEx('HistoryToDB for ' + IMClientType + ' (' + MyAccount + ')',MAXDWORD,2000);
        end;
      end
      else
      begin
        if Assigned(FMap) then
        begin
          FMap.Free;
          FMap := nil;
        end;
      end;
      // œÓ‰‰ÂÊÍ‡ Skype
      if GlobalSkypeSupportOnRun <> GlobalSkypeSupport then
      begin
        GlobalSkypeSupportOnRun := GlobalSkypeSupport;
        if GlobalSkypeSupport then
        begin
          if Assigned(Skype) then
            DisableSkype;
          EnableSkype;
        end
        else
        begin
          if Assigned(Skype) then
          begin
            DisableSkype;
            LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeOff');
            LSkypeStatus.Hint := 'HistoryToDBSyncSkypeOff';
          end;
        end;
      end;
    end;
    // 002 - —ËÌıÓÌËÁ‡ˆËˇ ËÒÚÓËË
    if (ControlStr = '002') and (not SyncHistoryStartedEnabled) and (not CheckMD5HashStartedEnabled) and (not UpdateContactListStartedEnabled) then
    begin
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ OnControlReq: ”Ô‡‚Îˇ˛˘ÂÂ ÒÓÓ·˘ÂÌËÂ ' + ControlStr + ' - ‚˚ÔÓÎÌˇÂÏ ÒËÌıÓÌËÁ‡ˆË˛ ËÒÚÓËË.', 2);
      SyncButtonClick(Self);
    end;
    // 003 - ¬˚ıÓ‰ ËÁ ÔÓ„‡ÏÏ˚
    // ¬˚ıÓ‰ ÂÒÎË ÌÂ Á‡ÔÛ˘ÂÌ‡ ÒËÌıÓÌËÁ‡ˆËˇ ËÎË ÔÂÂ‡Ò˜ÂÚ MD5
    if (ControlStr = '003') and (not Global_AutoRunHistoryToDBSync) then
    begin
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ OnControlReq: ”Ô‡‚Îˇ˛˘ÂÂ ÒÓÓ·˘ÂÌËÂ ' + ControlStr + ' - ‚˚ÔÓÎÌˇÂÏ ‚˚ıÓ‰ ËÁ ÔÓ„‡ÏÏ˚.', 2);
      if SyncHistoryStartedEnabled or CheckMD5HashStartedEnabled or UpdateContactListStartedEnabled then
        CloseRequest := True
      else if (SyncMethod = 2) and (SyncInterval = 4) then // ≈ÒÎË ÒËÌıÓÌËÁ‡ˆËˇ ÔË ‚˚ıÓ‰Â
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ OnControlReq: «‡ÔÛÒÍ ÒËÌıÓÌËÁ‡ˆËË ÔÂÂ‰ ‚˚ıÓ‰ÓÏ ËÁ ÔÓ„‡ÏÏ˚.', 2);
        CloseRequest := True;
        SyncButtonClick(Self);
      end
      else if SyncWhenExit then // ≈ÒÎË ‰ÓÔ. ÒËÌı-ˇ ÔË ‚˚ıÓ‰Â
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ OnControlReq: «‡ÔÛÒÍ ‰ÓÔ. ÒËÌıÓÌËÁ‡ˆËË ÔÂÂ‰ ‚˚ıÓ‰ÓÏ ËÁ ÔÓ„‡ÏÏ˚.', 2);
        CloseRequest := True;
        SyncButtonClick(Self);
      end
      else
        HistoryExitClick(Self);
    end;
    // 0040 - œÓÍ‡Á‡Ú¸ ‚ÒÂ ÓÍÌ‡ ÔÎ‡„ËÌ‡ (–ÂÊËÏ AntiBoss)
    if ControlStr = '0040' then
      AntiBoss(False);
    // 0041 - —Í˚Ú¸ ‚ÒÂ ÓÍÌ‡ ÔÎ‡„ËÌ‡ (–ÂÊËÏ AntiBoss)
    if ControlStr = '0041' then
      AntiBoss(True);
    // 0050  - «‡ÔÛÒÚËÚ¸ ÔÂÂ‡Ò˜ÂÚ MD5-ıÂ¯ÂÈ
    if (ControlStr = '0050') and (not SyncHistoryStartedEnabled) and (not CheckMD5HashStartedEnabled) and (not UpdateContactListStartedEnabled) then
    begin
      DeleteDublicate := False;
      StartCheckMD5Hash;
    end;
    // 0051  - «‡ÔÛÒÚËÚ¸ ÔÂÂ‡Ò˜ÂÚ MD5-ıÂ¯ÂÈ Ë Û‰‡ÎÂÌËÂ ‰Û·ÎËÍ‡ÚÓ‚
    if (ControlStr = '0051') and (not SyncHistoryStartedEnabled) and (not CheckMD5HashStartedEnabled) and (not UpdateContactListStartedEnabled) then
    begin
      DeleteDublicate := True;
      StartCheckMD5Hash;
    end;
    // 0060 - «‡ÔÂÚËÚ¸ ÒËÌıÓÌËÁ‡ˆË˛ ËÁ Ù‡ÈÎ‡ HistoryToDBImport.sql
    if ControlStr = '0060' then
      HistoryImportEnable := False;
    // 0061 - –‡ÁÂ¯ËÚ¸ ÒËÌıÓÌËÁ‡ˆË˛ ËÁ Ù‡ÈÎ‡ HistoryToDBImport.sql
    if ControlStr = '0061' then
      HistoryImportEnable := True;
    // 007  - «‡ÔÛÒÚËÚ¸ Ó·ÌÓ‚ÎÂÌËÂ ÒÔËÒÍ‡ ÍÓÌÚ‡ÍÚÓ‚
    if (ControlStr = '007') and (not SyncHistoryStartedEnabled) and (not CheckMD5HashStartedEnabled) and (not UpdateContactListStartedEnabled) then
      StartUpdateContactList;
    // 009 - ›ÍÒÚÂÌÌÓÂ Á‡‚Â¯ÂÌËÂ ‡·ÓÚ˚
    if ControlStr = '009' then
    begin
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ OnControlReq: ”Ô‡‚Îˇ˛˘ÂÂ ÒÓÓ·˘ÂÌËÂ ' + ControlStr + ' - ‚˚ÔÓÎÌˇÂÏ ÔËÌÛ‰ËÚÂÎ¸Ì˚È ‚˚ıÓ‰ ËÁ ÔÓ„‡ÏÏ˚.', 2);
      HistoryExitClick(Self);
    end;
    // 010 - —Ë„Ì‡Î Ó Ì‡ÎË˜ËË ‚ Ô‡ÏˇÚË ÒÓÓ·˘ÂÌËˇ ÓÚ ÔÎ‡„ËÌ‡
    if ControlStr = '010' then
    begin
      JvThreadTimerAutoSync.Enabled := False;
      ReadMappedText;
      JvThreadTimerAutoSync.Enabled := True;
    end;
  end;
end;

{ —‡·ÓÚÍ‡ Ú‡ÈÏÂ‡ SyncViewTimer ‰Îˇ ÓÚÓ·‡ÊÂÌËˇ ÔÓˆÂÒÒ‡ ÓÚÒ˜ÂÚ‡ ÓÒÌÓ‚ÌÓ„Ó SyncTimer }
procedure TMainSyncForm.SyncViewTimerTimer(Sender: TObject);
var
  CurrentSyncTimer: Longint;
begin
  if MainSyncForm.Showing then
  begin
    CurrentSyncTimer := (timeGetTime() - SyncTimerStartTime);
    LSyncStatusSet.Caption := Format(GetLangStr('HistoryToDBSyncStartCount'), [IntToStr(Round((SetSyncInterval-CurrentSyncTimer)/1000))]);
  end;
end;

{ «‡ÔÛÒÍ JvThreadTimer ÒËÌıÓÌËÁ‡ˆËË ÒÓÓ·˘ÂÌËÈ }
procedure TMainSyncForm.StartJvSyncTimer;
begin
  if SyncInterval = 0 then
    SetSyncInterval := 5*60*1000
  else if SyncInterval = 1 then
    SetSyncInterval := 10*60*1000
  else if SyncInterval = 2 then
    SetSyncInterval := 20*60*1000
  else if SyncInterval = 3 then
    SetSyncInterval := 30*60*1000
  else if SyncInterval = 8 then
    SetSyncInterval := SyncTimeCount*60*1000
  else
    Exit;
  JvThreadTimerSync.Interval := SetSyncInterval;
  JvThreadTimerSync.Enabled := True;
  SyncTimerEnabled := True;
  MainSyncForm.LSyncStatusSet.Caption := Format(GetLangStr('HistoryToDBSyncStartCount'), ['0']);
  // «‡ÔÛÒÍ‡ÂÏ Ú‡ÈÏÂ SyncViewTimer ‰Îˇ ÓÚÓ·‡ÊÂÌËˇ ÔÓˆÂÒÒ‡ ÓÚÒ˜ÂÚ‡ SyncTimer
  SyncTimerStartTime := timeGetTime();
  SyncViewTimer.Enabled := True;
end;

procedure TMainSyncForm.StopJvSyncTimer;
begin
  // ŒÒÚ‡Ì‡‚ÎË‚‡ÂÏ Ú‡ÈÏÂ
  SyncTimerEnabled := False;
  JvThreadTimerSync.Enabled := False;
  // ŒÒÚ‡Ì‡‚ÎË‚‡ÂÏ Ú‡ÈÏÂ SyncViewTimer ‰Îˇ ÓÚÓ·‡ÊÂÌËˇ ÔÓˆÂÒÒ‡ ÓÚÒ˜ÂÚ‡ SyncTimer
  SyncViewTimer.Enabled := False;
  LSyncStatusSet.Caption := GetLangStr('HistoryToDBSyncWaitReq');
  LSyncStatusSet.Hint := 'HistoryToDBSyncWaitReq';
end;

{ —‡·ÓÚÍ‡ JvThreadTimerSync Ú‡ÈÏÂ‡ ÒËÌıÓÌËÁ‡ˆËË }
procedure TMainSyncForm.JvThreadTimerSyncTimer(Sender: TObject);
begin
  // ”ÒÚ‡ÌÓ‚ËÏ ÌÓ‚ÓÂ ‚ÂÏˇ Ì‡˜‡Î‡ ÒËÌıÓÌËÁ‡ˆËË
  SyncTimerStartTime := timeGetTime();
  // ŒÒÚ‡Ì‡‚Î‚‡ÂÏ Ú‡ÈÏÂ
  StopJvSyncTimer;
  // «‡ÔÛÒÍ ‰Ó·‡‚ÎÂÌËˇ ‰‡ÌÌ˚ı ËÁ sql-Ù‡ÈÎ‡ ‚ ¡ƒ
  SyncButtonClick(Self);
  // «‡ÔÛÒÍ Ú‡ÈÏÂ‡
  StartJvSyncTimer;
end;

{ «‡ÔÛÒÍ Ú‡ÈÏÂ‡ ÏË„‡ÌËˇ ËÍÓÌÓÍ ‚ ÚÂÂ }
procedure StartSyncTrayFlashingTimer;
begin
  SyncTrayFlashingTimer := TimeSetEvent(600000,1000,@SyncTrayFlashingTimerCallBack,100,TIME_PERIODIC);
  SyncTrayFlashingTimerEnabled := True;
  MainSyncForm.HistoryToDBSyncTray.IconList := MainSyncForm.TrayAniImageList;
  MainSyncForm.HistoryToDBSyncTray.CycleInterval := 400;
  MainSyncForm.HistoryToDBSyncTray.CycleIcons := True;
end;

{ ŒÒÚ‡ÌÓ‚Í‡ Ú‡ÈÏÂ‡ ÏË„‡ÌËˇ ËÍÓÌÓÍ ‚ ÚÂÂ }
procedure StopSyncTrayFlashingTimer;
begin
  if SyncTrayFlashingTimerEnabled then
  begin
    SyncTrayFlashingTimerEnabled := False;
    timeKillEvent(SyncTrayFlashingTimer);
    MainSyncForm.HistoryToDBSyncTray.CycleIcons := False;
    MainSyncForm.HistoryToDBSyncTray.IconList := MainSyncForm.TrayImageList;
  end;
end;

{ —‡·ÓÚÍ‡ Ú‡ÈÏÂ‡ ÏË„‡ÌËˇ ËÍÓÌÓÍ ‚ ÚÂÂ }
procedure SyncTrayFlashingTimerCallBack(uTimerID, uMessage: UINT; dwUser, dw1, dw2: DWORD); stdcall;
begin
  StopSyncTrayFlashingTimer;
end;

{ œÓˆÂ‰Û‡ ÔÓ‚ÂÍË ‚ÂÒËË ¡ƒ Ë Â∏ Ó·ÌÓ‚ÎÂÌËˇ }
procedure TMainSyncForm.CheckDBUpdate(PluginDllPath: String);
var
  Query: TZQuery;
  SQLVersion, SQLClientType, TempProgramsVer: String;
begin
  if DBUserName <> 'username' then
    ConnectDB; // œÓ‰ÍÎ˛˜‡ÂÏÒˇ Í ·‡ÁÂ
  if ZConnection1.Connected then
  begin
    HistoryToDBSyncTray.IconIndex := 3;
    if IMClientType = 'ICQ' then
      SQLClientType := 'icq_version'
    else if IMClientType = 'QIP' then
      SQLClientType := 'qip_version'
    else if IMClientType = 'RnQ' then
      SQLClientType := 'rnq_version'
    else if IMClientType = 'Miranda' then
      SQLClientType := 'miranda_version'
    else if IMClientType = 'Skype' then
      SQLClientType := 'skype_version'
    else
    begin
      ShowBalloonHint(MainSyncForm.Caption, GetLangStr('HistoryToDBSyncUnknownIMClient'));
      Exit;
    end;
    Query := TZQuery.Create(nil);
    Query.Connection := ZConnection1;
    Query.ParamCheck := False;
    try
      Query.SQL.Clear;
      Query.SQL.Text := 'select config_value from config where config_name = '''+SQLClientType+'''';
      Query.Open;
      SQLVersion := Query.FieldByName('config_value').AsString;
      Query.Close;
      // Œ·ÌÓ‚ÎÂÌËÂ ÒÚÛÍÚÛ˚ ¡ƒ ‰Îˇ Skype Ò ‚ÂÒËË ÌËÊÂ 2.3.0.0
      TempProgramsVer := StringReplace(ProgramsVer, '.', '', [RFReplaceall]);
      if IsNumber(TempProgramsVer) then
      begin
        if (StrToInt(TempProgramsVer) = 2300) and (SQLVersion = '') and (IMClientType = 'Skype') then
          SQLVersion := '2.2'
      end;
      // End
      if MatchStrings(DBType, 'mysql*') then
      begin
        {if (SQLVersion = '1.0') and (ProgramsVer = '1.1.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-10-to-11.sql');
        if (SQLVersion = '1.0') and (ProgramsVer = '1.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-10-to-12.sql');}
        if (SQLVersion = '1.0') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-10-to-20.sql');
        {if (SQLVersion = '1.1') and (ProgramsVer = '1.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-11-to-12.sql');}
        if (SQLVersion = '1.1') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-11-to-20.sql');
        if (SQLVersion = '1.2') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-12-to-20.sql');
        if (SQLVersion = '1.3') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-13-to-20.sql');
        if (SQLVersion = '2.0') and (ProgramsVer = '2.1.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-20-to-21.sql');
        if (SQLVersion = '2.0') and (ProgramsVer = '2.2.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-21-to-22.sql');
        end;
        if (SQLVersion = '2.0') and (ProgramsVer = '2.3.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-22-to-23.sql');
        end;
        if (SQLVersion = '2.0') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.3.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-22-to-23.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-21-to-22.sql');
        if (SQLVersion = '2.2') and (ProgramsVer = '2.3.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-22-to-23.sql');
        if (SQLVersion = '2.2') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.3') and (ProgramsVer = '2.4.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'mysql-update-23-to-24.sql');
      end
      else if MatchStrings(DBType, 'postgresql*') then
      begin
        {if (SQLVersion = '1.0') and (ProgramsVer = '1.1.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-10-to-11.sql');
        if (SQLVersion = '1.0') and (ProgramsVer = '1.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-10-to-12.sql');}
        if (SQLVersion = '1.0') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-10-to-20.sql');
        {if (SQLVersion = '1.1') and (ProgramsVer = '1.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-11-to-12.sql');}
        if (SQLVersion = '1.1') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-11-to-20.sql');
        if (SQLVersion = '1.2') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-12-to-20.sql');
        if (SQLVersion = '1.3') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-13-to-20.sql');
        if (SQLVersion = '2.0') and (ProgramsVer = '2.1.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-20-to-21.sql');
        if (SQLVersion = '2.0') and (ProgramsVer = '2.2.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-21-to-22.sql');
        end;
        if (SQLVersion = '2.0') and (ProgramsVer = '2.3.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-22-to-23.sql');
        end;
        if (SQLVersion = '2.0') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.3.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-22-to-23.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-21-to-22.sql');
        if (SQLVersion = '2.2') and (ProgramsVer = '2.3.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-22-to-23.sql');
        if (SQLVersion = '2.2') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.3') and (ProgramsVer = '2.4.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'postgresql-update-23-to-24.sql');
      end
      else if MatchStrings(DBType, 'oracle*') then
      begin
        {if (SQLVersion = '1.0') and (ProgramsVer = '1.1.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-10-to-11.sql');
        if (SQLVersion = '1.0') and (ProgramsVer = '1.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-10-to-12.sql');}
        if (SQLVersion = '1.0') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-10-to-20.sql');
        {if (SQLVersion = '1.1') and (ProgramsVer = '1.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-11-to-12.sql');}
        if (SQLVersion = '1.1') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-11-to-20.sql');
        if (SQLVersion = '1.2') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-12-to-20.sql');
        if (SQLVersion = '1.3') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-13-to-20.sql');
        if (SQLVersion = '2.0') and (ProgramsVer = '2.1.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-20-to-21.sql');
        if (SQLVersion = '2.0') and (ProgramsVer = '2.2.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-21-to-22.sql');
        end;
        if (SQLVersion = '2.0') and (ProgramsVer = '2.3.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-22-to-23.sql');
        end;
        if (SQLVersion = '2.0') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.3.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-22-to-23.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-21-to-22.sql');
        if (SQLVersion = '2.2') and (ProgramsVer = '2.3.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-22-to-23.sql');
        if (SQLVersion = '2.2') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.3') and (ProgramsVer = '2.4.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'oracle-update-23-to-24.sql');
      end
      else if MatchStrings(DBType, 'sqlite*') then
      begin
        {if (SQLVersion = '1.0') and (ProgramsVer = '1.1.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-10-to-11.sql');
        if (SQLVersion = '1.0') and (ProgramsVer = '1.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-10-to-12.sql');}
        if (SQLVersion = '1.0') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-10-to-20.sql');
        {if (SQLVersion = '1.1') and (ProgramsVer = '1.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-11-to-12.sql');}
        if (SQLVersion = '1.1') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-11-to-20.sql');
        if (SQLVersion = '1.2') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-12-to-20.sql');
        if (SQLVersion = '1.3') and (ProgramsVer = '2.0.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-13-to-20.sql');
        if (SQLVersion = '2.0') and (ProgramsVer = '2.1.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-20-to-21.sql');
        if (SQLVersion = '2.0') and (ProgramsVer = '2.2.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-21-to-22.sql');
        end;
        if (SQLVersion = '2.0') and (ProgramsVer = '2.3.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-22-to-23.sql');
        end;
        if (SQLVersion = '2.0') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.3.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-22-to-23.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-21-to-22.sql');
        if (SQLVersion = '2.2') and (ProgramsVer = '2.3.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-22-to-23.sql');
        if (SQLVersion = '2.2') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.3') and (ProgramsVer = '2.4.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'sqlite-update-23-to-24.sql');
      end
      else if MatchStrings(DBType, 'firebird*') then
      begin
        if (SQLVersion = '2.0') and (ProgramsVer = '2.1.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-20-to-21.sql');
        if (SQLVersion = '2.0') and (ProgramsVer = '2.2.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-21-to-22.sql');
        end;
        if (SQLVersion = '2.0') and (ProgramsVer = '2.3.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-22-to-23.sql');
        end;
        if (SQLVersion = '2.0') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-20-to-21.sql');
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.3.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-22-to-23.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-21-to-22.sql');
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.1') and (ProgramsVer = '2.2.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-21-to-22.sql');
        if (SQLVersion = '2.2') and (ProgramsVer = '2.3.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-22-to-23.sql');
        if (SQLVersion = '2.2') and (ProgramsVer = '2.4.0.0') then
        begin
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-22-to-23.sql');
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-23-to-24.sql');
        end;
        if (SQLVersion = '2.3') and (ProgramsVer = '2.4.0.0') then
          DBUpdate(PluginDllPath + 'update\' + 'firebird-update-23-to-24.sql');
      end;
    finally
      Query.Free;
    end;
    HistoryToDBSyncTray.IconIndex := 0;
  end;
  ZConnection1.Disconnect;
end;

{ Œ·ÌÓ‚ÎÂÌËÂ ·‡Á˚ ËÁ Ù‡ÈÎ‡ }
procedure TMainSyncForm.DBUpdate(SQLUpdateFile: String);
var
  StrList: TStringList;
  StrListIndex: Integer;
  ErrCount: Integer;
  StrReplace: String;
begin
  if ZConnection1.Connected then
  begin
    if FileExists(SQLUpdateFile) then
    begin
      ErrCount := 0;
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ DBUpdate: «‡ÔÛ˘ÂÌÓ Ó·ÌÓ‚ÎÂÌËÂ ¡ƒ ËÁ Ù‡ÈÎ‡ ' + SQLUpdateFile, 2);
      StrList := TStringList.Create;
      StrList.Clear;
      StrList.LoadFromFile(SQLUpdateFile);
      DBUpdateProcessor.Script.Clear;
      if MatchStrings(DBType, 'firebird*') then
        ZConnection1.StartTransaction;
      for StrListIndex := 0 to StrList.Count-1 do
      begin
        StrReplace := StrList[StrListIndex];
        StrReplace := StringReplace(StrReplace, 'username', DBUserName, [RFReplaceall]);
        DBUpdateProcessor.Script.Add(StrReplace);
      end;
      try
        DBUpdateProcessor.Execute;
      except
        on e :
          Exception do
          begin
            Inc(ErrCount);
            if WriteErrLog then
              WriteInLog(ProfilePath, Format(ERR_READ_DB_CONNECT_ERR, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), StringReplace(e.Message,#13#10,'',[RFReplaceall])]), 1);
          end;
      end;
      if MatchStrings(DBType, 'firebird*') then
        ZConnection1.Commit;
      StrList.Free;
      if ErrCount = 0 then
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ DBUpdate: Œ·ÌÓ‚ÎÂÌËÂ ¡ƒ ÛÒÔÂ¯ÌÓ Á‡‚Â¯ÂÌÓ.', 2);
        ShowBalloonHint(MainSyncForm.Caption, GetLangStr('HistoryToDBSyncUpdateDone'))
      end
      else
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ DBUpdate: Œ·ÌÓ‚ÎÂÌËÂ ¡ƒ Á‡‚Â¯ÂÌÓ Ò Ó¯Ë·Í‡ÏË.', 2);
        ShowBalloonHint(MainSyncForm.Caption, GetLangStr('HistoryToDBSyncUpdateErr'));
      end;
    end;
  end;
end;

{ œÓ‰‰ÂÊÍ‡ ÂÊËÏ‡ ¿ÌÚË-·ÓÒÒ }
procedure TMainSyncForm.AntiBoss(HideAllForms: Boolean);
begin
  if not Assigned(MainSyncForm) then Exit;
  if not Assigned(LogForm) then Exit;
  if not Assigned(KeyPasswdForm) then Exit;
  if not Assigned(AboutForm) then Exit;
  if HideAllForms then
  begin
    ShowWindow(MainSyncForm.Handle, SW_HIDE);
    MainSyncForm.Hide;
    ShowWindow(LogForm.Handle, SW_HIDE);
    LogForm.Hide;
    ShowWindow(KeyPasswdForm.Handle, SW_HIDE);
    KeyPasswdForm.Hide;
    ShowWindow(AboutForm.Handle, SW_HIDE);
    AboutForm.Hide;
    if HistoryToDBSyncTray.IconVisible = True then
      HistoryToDBSyncTray.IconVisible := False;
  end
  else
  begin
    // ≈ÒÎË ÙÓÏ‡ ·˚Î‡ ‡ÌÂÂ ÓÚÍ˚Ú‡, ÚÓ ÔÓÍ‡Á˚‚‡ÂÏ Â∏
    if Global_MainForm_Showing then
    begin
      if HistoryMainFormHidden then
        HistoryToDBSyncTray.HideMainForm
      else
      begin
        ShowWindow(MainSyncForm.Handle, SW_SHOW);
        MainSyncForm.Show;
      end;
    end;
    if Global_LogForm_Showing then
    begin
      ShowWindow(LogForm.Handle, SW_SHOW);
      LogForm.Show;
    end;
    if Global_KeyPasswdForm_Showing then
    begin
      ShowWindow(KeyPasswdForm.Handle, SW_SHOW);
      KeyPasswdForm.Show;
    end;
    if Global_AboutForm_Showing then
    begin
      ShowWindow(AboutForm.Handle, SW_SHOW);
      AboutForm.Show;
    end;
    HistoryToDBSyncTray.IconVisible := not HideSyncIcon;
  end;
end;

{ œÓˆÂ‰Û‡ Á‡ÔÛÒÍ‡ Ó·ÌÓ‚ÎÂÌËˇ ÒÔËÒÍ‡ ÍÓÌÚ‡ÍÚÓ‚ }
procedure TMainSyncForm.StartUpdateContactList;
begin
  if not UpdateContactListStartedEnabled then
  begin
    if not UpdateContactListThread.Terminated then
      UpdateContactListThread.Terminate;
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ StartUpdateContactList: «‡ÔÛÒÍ UpdateContactListThread', 2);
    UpdateContactListThread.Execute(Self);
  end;
end;

{ œÓÚÓÍ Ó·ÌÓ‚ÎÂÌËˇ ÒÔËÒÍ‡ ÍÓÌÚ‡ÍÚÓ‚ }
procedure TMainSyncForm.UpdateContactListThreadExecute(Sender: TObject; Params: Pointer);
var
  Query: TZQuery;
  TSG_Proto, TSG_Contact: TStringGrid;
  Str1, Str2, FoundProto, FoundMyUserID: String;
  TF: TextFile;
  I, J, K, ProtoType: Integer;
begin
  UpdateContactListStartedEnabled := True;
  UpdateContactListDone := False;
  try
    if not ZConnection1.Connected then
      ZConnection1.Connect;
  except
    on e: Exception do
    begin
      if not ReConnectDB then
        Exit;
    end;
  end;
  if ZConnection1.Connected then
  begin
    if (FileExists(ProfilePath+ContactListName)) and (FileExists(ProfilePath+ProtoListName)) then
    begin
      // Õ‡˜‡ÎÓ Ó·ÌÓ‚ÎÂÌËˇ  À - ŒÚÍÎ˛˜ÂÌËÂ ‚ÒÔÓÏÓ„‡ÚÂÎ¸Ì˚ı ÔÓˆÂ‰Û Ë Ú.‰.
      TMainSyncForm(Params).ThreadMsgNum := 1;
      TMainSyncForm(Params).ThreadMsgStr := GetLangStr('HistoryToDBSyncStartUpdateCL');
      UpdateContactListThread.Synchronize(TMainSyncForm(Params).CLThreadShowMessage);
      // —ÓÁ‰‡ÂÏ TZQuery
      Query := TZQuery.Create(nil);
      Query.Connection := ZConnection1;
      Query.ParamCheck := False;
      // √ÛÁËÏ ÒÔËÒÓÍ ÔÓÚÓÍÓÎÓ‚ ‚ StringGrid
      // ƒÂÎ‡ÂÏ Ú‡ÍÓÈ ËÁ‚‡Ú ÎË¯¸ Ò Ó‰ÌÓÈ ˆÂÎ¸˛ - ÎÂ„ÍÓ Â‡ÎËÁÛÂÏ˚È ÔÓËÒÍ ÔÓ ÍÓÎÓÌÍ‡Ï
      I := 0;
      TSG_Proto := TStringGrid.Create(nil);
      AssignFile(TF, ProfilePath+ProtoListName);
      Reset(TF);
      while not eof(TF) do
      begin
        Readln(TF, Str1);
        Inc(I);
        J := 0;
        while Pos(';', Str1)<>0 do
        begin
          Str2 := Copy(Str1,1,Pos(';', Str1)-1);
          Inc(J);
          Delete(Str1, 1, Pos(';', Str1));
          TSG_Proto.Cells[J-1, I-1] := Str2;
        end;
        if Pos(';', Str1) = 0 then
        begin
          Inc(J);
          TSG_Proto.Cells[J-1, I-1] := Str1;
        end;
        TSG_Proto.ColCount := J;
        TSG_Proto.RowCount := I+1;
      end;
      CloseFile(TF);
      // √ÛÁËÏ ÒÔËÒÓÍ ÍÓÌÚ‡ÍÚÓ‚ ‚ StringGrid
      I := 0;
      TSG_Contact := TStringGrid.Create(nil);
      AssignFile(TF, ProfilePath+ContactListName);
      Reset(TF);
      while not eof(TF) do
      begin
        Readln(TF, Str1);
        Inc(I);
        J := 0;
        while Pos(';', Str1)<>0 do
        begin
          Str2 := Copy(Str1,1,Pos(';', Str1)-1);
          Inc(J);
          Delete(Str1, 1, Pos(';', Str1));
          TSG_Contact.Cells[J-1, I-1] := Str2;
        end;
        if Pos(';', Str1) = 0 then
        begin
          Inc(J);
          TSG_Contact.Cells[J-1, I-1] := Str1;
        end;
        TSG_Contact.ColCount := J;
        TSG_Contact.RowCount := I+1;
      end;
      CloseFile(TF);
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ UpdateContactListThreadExecute: —ÔËÒÓÍ TSG_Proto: ColCount - ' + IntToStr(TSG_Proto.ColCount)+', RowCount - '+IntToStr(TSG_Proto.RowCount), 2);
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ UpdateContactListThreadExecute: —ÔËÒÓÍ TSG_Contact: ColCount - ' + IntToStr(TSG_Contact.ColCount)+', RowCount - '+IntToStr(TSG_Contact.RowCount), 2);
      for I := 0 to TSG_Contact.RowCount-2 do
      begin
        // —ËÌıÓÌËÁ‡ˆËˇ
        TMainSyncForm(Params).ThreadMsgNum := 2;
        TMainSyncForm(Params).CheckTotalHashMsg—ount := TSG_Contact.RowCount-2;
        TMainSyncForm(Params).ProgressBarCount := I;
        UpdateContactListThread.Synchronize(TMainSyncForm(Params).CLThreadShowMessage);
        // »˘ÂÏ ËÏˇ ÔÓÚÓÍÓÎ‡ (1 ÔÓÎÂ) ‚ ÒÔËÒÍÂ ÔÓÚÓÍÓÎÓ‚ ‚ 3 ÍÓÎÓÌÍÂ (œÓÚÓÍÓÎ) ÔÓ 4 ÔÓÎ˛ (œÓÚÓÍÓÎ) ËÁ ÒÔËÒÍ‡ ÍÓÌÚ‡ÍÚÓ‚
        K := TSG_Proto.Cols[2].IndexOf(TSG_Contact.Cells[3, I]);
        if K <> -1 then // Õ‡¯ÎË! K - ÒÚÓÍ‡
        begin
          // ›ÍÒÚ. Á‡‚Â¯ÂÌËÂ ÔÓÚÓÍ‡
          if UpdateContactListThread.Terminated then
          begin
            if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ UpdateContactListThreadExecute: ›ÍÒÚÂÌÌÓÂ Á‡‚Â¯ÂÌËÂ ÔÓÚÓÍ‡ UpdateContactListThread.', 2);
            UpdateContactListDone := False;
            TSG_Contact.Free;
            TSG_Proto.Free;
            Query.Free;
            Exit;
          end;
          // œÓÚÓÍÓÎ˚ Ë Ú.Ô.
          FoundProto := TSG_Proto.Cells[0,K];
          FoundMyUserID := TSG_Proto.Cells[1,K];
          ProtoType := StrContactProtoToInt(FoundProto);
          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ UpdateContactListThreadExecute: ƒÎˇ UserID = ' + TSG_Contact.Cells[0, I] + ' Ì‡È‰ÂÌ: œÓÚÓÍÓÎ = ' + FoundProto + ' (' + IntToStr(ProtoType) + ') | UserID ÒÓ·ÂÒÂ‰ÌËÍ‡ = ' + FoundMyUserID, 2);
          Query.SQL.Clear;
          Query.SQL.Text := 'update uin_'+ DBUserName + ' set nick = '''+ AnsiStringToUTF8(PrepareString(PWideChar(TSG_Contact.Cells[1, I]))) + ''' where uin = ''' + AnsiStringToUTF8(TSG_Contact.Cells[0, I]) + ''';';
          try
            Query.ExecSQL;
          except
            on e :
              Exception do
              begin // –ÂÍÓÌÂÍÚ ‚ ÒÎÛ˜‡Â ÔÓÚÂË Ò‚ˇÁË
                if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - Exception ‚ ÔÓˆÂ‰ÛÂ UpdateContactListThreadExecute: ' + Trim(e.Message), 2);
                if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
                begin
                  ZConnection1.Disconnect;
                  if not ReConnectDB then
                  begin
                    UpdateContactListDone := False;
                    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ UpdateContactListThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
                    TSG_Contact.Free;
                    TSG_Proto.Free;
                    Query.Free;
                    Exit;
                  end;
                end;
                if WriteErrLog then
                  WriteInLog(ProfilePath, Format(ERR_SEND_UPDATE, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), Trim(e.Message)]), 1);
              end;
          end;
          Query.SQL.Clear;
          Query.SQL.Text := 'update uin_'+ DBUserName + ' set proto_name = ' + IntToStr(ProtoType) + ' where uin = ''' + AnsiStringToUTF8(TSG_Contact.Cells[0, I]) + ''';';
          try
            Query.ExecSQL;
          except
            on e :
              Exception do
              begin // –ÂÍÓÌÂÍÚ ‚ ÒÎÛ˜‡Â ÔÓÚÂË Ò‚ˇÁË
                if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - Exception ‚ ÔÓˆÂ‰ÛÂ UpdateContactListThreadExecute: ' + Trim(e.Message), 2);
                if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
                begin
                  ZConnection1.Disconnect;
                  if not ReConnectDB then
                  begin
                    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ UpdateContactListThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
                    UpdateContactListDone := False;
                    TSG_Contact.Free;
                    TSG_Proto.Free;
                    Query.Free;
                    Exit;
                  end;
                end;
                if WriteErrLog then
                  WriteInLog(ProfilePath, Format(ERR_SEND_UPDATE, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), Trim(e.Message)]), 1);
              end;
          end;
        end;
      end;
      TSG_Contact.Free;
      TSG_Proto.Free;
      Query.Free;
      UpdateContactListDone := True;
    end
    else
    begin
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ UpdateContactListThreadExecute: ÕÂ Ì‡È‰ÂÌ˚ Ù‡ÈÎ ÒÓ ÒÔËÒÍÓÏ ÔÓÚÓÍÓÎÓ‚ Ë ÍÓÌÚ‡ÍÚÓ‚. ('+ProfilePath+')', 2);
      // ¬˚‚Ó‰ËÏ ÒÓÓ·˘ÂÌËÂ
      TMainSyncForm(Params).ThreadMsgNum := 3;
      TMainSyncForm(Params).ThreadMsgStr := GetLangStr('HistoryToDBSyncCLFileNotFound');
      UpdateContactListThread.Synchronize(TMainSyncForm(Params).CLThreadShowMessage);
    end;
  end;
end;

{ œÓÚÓÍ Ó·ÌÓ‚ÎÂÌËˇ ÒÔËÒÍ‡ ÍÓÌÚ‡ÍÚÓ‚ Á‡‚Â¯ÂÌ }
procedure TMainSyncForm.UpdateContactListThreadFinish(Sender: TObject);
begin
  SyncProgressBar.Position := 0;
  UpdateContactListStartedEnabled := False;
  if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ UpdateContactListThreadFinish: œÓÚÓÍ UpdateContactListThread ‚˚ÔÓÎÌÂÌ.', 2);
  // ŒÚÍÎ˛˜‡ÂÏÒˇ ÓÚ ¡ƒ
  if (not SyncHistoryStartedEnabled) and (not CheckMD5HashStartedEnabled) then
    ZConnection1.Disconnect;
  // «‡Í‡Ì˜Ë‚‡ÂÏ ÏË„‡Ú¸ ‚ ÚÂÂ
  if not SyncHistoryStartedEnabled then
    StopSyncTrayFlashingTimer;
  // ¬ÍÎ˛˜‡ÂÏ ÍÌÓÔÍË Ë Ú.Ô.
  EnableButton;
  // «‡ÔÛÒÍ Ú‡ÈÏÂ‡ ÒËÌıÓÌËÁ‡ˆËË ÔÓ ‚ÂÏÂÌË
  if (StartStopSyncButton.Visible) and (not SyncTimerEnabled) and (not SyncHistoryStartedEnabled) then
    StartStopSyncButtonClick(StartStopSyncButton);
  // œÓ‰ÒÍ‡ÁÍ‡ ‚ ÚÂÂ
  if SyncHistoryStartedEnabled then
    HistoryToDBSyncTray.Hint := Caption + ' - ' + GetLangStr('HistoryToDBSyncStarted')
  else
    HistoryToDBSyncTray.Hint := Caption;
  // ≈ÒÎË Ó·ÌÓ‚ÎÂÌËÂ  À ÔÓ¯ÎÓ ·ÂÁ Ó¯Ë·ÓÍ
  if UpdateContactListDone then
  begin
    // ”‰‡ÎˇÂÏ ÒÔËÒÍË ÍÓÌÚ‡ÍÚÓ‚ Ë ÔÓÚÓÍÓÎÓ‚
    if FileExists(ProfilePath+ProtoListName) then
      DeleteFile(ProfilePath+ProtoListName);
    if FileExists(ProfilePath+ContactListName) then
      DeleteFile(ProfilePath+ContactListName);
    ShowBalloonHint(MainSyncForm.Caption, GetLangStr('HistoryToDBSyncCLUpdateDone'));
  end
  else
    ShowBalloonHint(MainSyncForm.Caption, GetLangStr('HistoryToDBSyncCLUpdateErr') + #13#10 + GetLangStr('SeeErrLog'));
  // ¬˚ıÓ‰ ËÁ ÔÓ„‡ÏÏ˚ ÔÓ ÓÚÎÓÊÂÌÌÓÏÛ Á‡ÔÓÒÛ
  if CloseRequest and (not SyncHistoryStartedEnabled) and (not CheckMD5HashStartedEnabled) then
    HistoryExitClick(Self);
end;

{ œÓˆÂ‰Û‡ Á‡ÔÛÒÍ‡ ÔÂÂ‡Ò˜ÂÚ‡ MD5-ıÂ¯ÂÈ }
procedure TMainSyncForm.StartCheckMD5Hash;
begin
  if not CheckMD5HashStartedEnabled then
  begin
    if not CheckMD5HashThread.Terminated then
      CheckMD5HashThread.Terminate;
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ StartCheckMD5Hash: «‡ÔÛÒÍ CheckMD5HashThread', 2);
    CheckMD5HashThread.Execute(Self);
  end;
end;

{ œÓÚÓÍ ÔÂÂ‡Ò˜ÂÚ‡ MD5-ıÂ¯ÂÈ }
procedure TMainSyncForm.CheckMD5HashThreadExecute(Sender: TObject; Params: Pointer);
var
  Query: TZQuery;
  ChangeQuery: TZQuery;
  DublicateQuery: TZQuery;
  TotalMD5Hash, MsgMD5Cnt, ErrMsgMD5Cnt, ErrMD5DublicateMesCount, DeletedMD5DublicateMesCount: Integer;
  MD5String: WideString;
  DublicateMD5Hash: String;
  NextTable: Boolean;
  QueryRecNo, DublicateRecNo: Integer;
begin
  CheckMD5HashStartedEnabled := True;
  CheckMD5HashDone := False;
  TotalMD5Hash := 0;
  QueryRecNo := 0;
  try
    if not ZConnection1.Connected then
      ZConnection1.Connect;
  except
    on e: Exception do
    begin
      if not ReConnectDB then
        Exit;
    end;
  end;
  if ZConnection1.Connected then
  begin
    // Õ‡˜‡ÎÓ ÔÂÂ‡Ò˜ÂÚ‡ MD5-ıÂ¯ÂÈ - ŒÚÍÎ˛˜ÂÌËÂ ‚ÒÔÓÏÓ„‡ÚÂÎ¸Ì˚ı ÔÓˆÂ‰Û Ë Ú.‰.
    TMainSyncForm(Params).ThreadMsgNum := 1;
    TMainSyncForm(Params).ThreadMsgStr := GetLangStr('HistoryToDBSyncStartMD5');
    CheckMD5HashThread.Synchronize(TMainSyncForm(Params).MD5ThreadShowMessage);
    // —ÓÁ‰‡ÂÏ Ó·˙ÂÍÚ˚ TZQuery
    Query := TZQuery.Create(nil);
    ChangeQuery := TZQuery.Create(nil);
    DublicateQuery := TZQuery.Create(nil);
    Query.Connection := ZConnection1;
    ChangeQuery.Connection := ZConnection1;
    DublicateQuery.Connection := ZConnection1;
    Query.ParamCheck := False;
    ChangeQuery.ParamCheck := False;
    DublicateQuery.ParamCheck := False;
    // ”‰‡ÎˇÂÏ ÎÓ„ HistoryToDBDublicate.log
    if DeleteDublicate then
    begin
      if FileExists(ProfilePath + DublicateLogName) then
        DeleteFile(ProfilePath + DublicateLogName);
    end;
    try
      // »˘ÂÏ ‰Û·ÎËÍ‡Ú˚ ‚ Ú‡·ÎËˆÂ uin_username
      NextTable := False;
      Query.SQL.Clear;
      Query.SQL.Text := 'select count(*) as cnt from uin_'+ DBUserName + ';';
      try
        Query.Open;
      except
        on e: Exception do
        begin // –ÂÍÓÌÂÍÚ ‚ ÒÎÛ˜‡Â ÔÓÚÂË Ò‚ˇÁË
          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - Exception ‚ ÔÓˆÂ‰ÛÂ CheckMD5HashThreadExecute (Query): ' + Trim(e.Message), 2);
          if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
          begin
            ZConnection1.Disconnect;
            if not ReConnectDB then
            begin
              CheckMD5HashDone := False;
              if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
              Query.Close;
              Exit;
              end;
            end
            else
              try
                Query.Open;
              except
              end;
          end;
        end;
      TotalMD5Hash := Query.FieldByName('cnt').AsInteger;
      Query.Close;
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: —ÔËÒÓÍ TSG_Proto: ¬ÒÂ„Ó Á‡ÔËÒÂÈ ‚ Ú‡·ÎËˆÂ uin_' + DBUserName + ' = ' + IntToStr(TotalMD5Hash), 2);
      // ¬˚‚Ó‰ Ì‡˜‡Î¸ÌÓÈ ÒÚ‡ÚËÒÚËÍË ÔÓ MD5 ı˝¯‡Ï
      TMainSyncForm(Params).ThreadMsgNum := 2;
      TMainSyncForm(Params).CheckTotalBrokenMD5Hash—ount := '0';
      TMainSyncForm(Params).CheckTotalChangeMD5Hash—ount := '0';
      TMainSyncForm(Params).CheckTotalMD5DublicateMesCount := '0';
      TMainSyncForm(Params).CheckTotalDeletedMD5DublicateMesCount := '0';
      TMainSyncForm(Params).CheckTotalHashMsg—ount := TotalMD5Hash;
      TMainSyncForm(Params).ProgressBarCount := 0;
      CheckMD5HashThread.Synchronize(TMainSyncForm(Params).MD5ThreadShowMessage);
      // End
      if TotalMD5Hash = 0 then
        NextTable := True;
      if not NextTable then
      begin
        Query.SQL.Clear;
        Query.SQL.Text := 'select id,uin,msg_time,msg_text,md5hash from uin_'+ DBUserName + ';';
        try
          Query.Open;
        except
          on e: Exception do
          begin // –ÂÍÓÌÂÍÚ ‚ ÒÎÛ˜‡Â ÔÓÚÂË Ò‚ˇÁË
            if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - Exception ‚ ÔÓˆÂ‰ÛÂ CheckMD5HashThreadExecute (Query): ' + Trim(e.Message), 2);
            if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
            begin
              ZConnection1.Disconnect;
              if not ReConnectDB then
              begin
                CheckMD5HashDone := False;
                if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
                Query.Close;
                Exit;
              end
              else
                try
                  Query.Open;
                except
                end;
            end;
          end;
        end;
        MsgMD5Cnt := 0;
        ErrMsgMD5Cnt := 0;
        ErrMD5DublicateMesCount := 0;
        DeletedMD5DublicateMesCount := 0;
        repeat
          QueryRecNo := Query.RecNo;
          MD5String := EncryptMD5(Query.FieldByName('uin').AsString + FormatDateTime('YYYY-MM-DD HH:MM:SS', StrToDateTime(StringReplace(Query.FieldByName('msg_time').AsString, '-', '/', [RFReplaceall]))) + Query.FieldByName('msg_text').AsString);
          // œÂ˚‚‡ÌËÂ ÔÓÚÓÍ‡
          if CheckMD5HashThread.Terminated then
          begin
            if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ›ÍÒÚÂÌÌÓÂ Á‡‚Â¯ÂÌËÂ ÔÓÚÓÍ‡ CheckMD5HashThread.', 2);
            CheckMD5HashDone := False;
            Query.Close;
            ChangeQuery.Close;
            DublicateQuery.Close;
            Exit;
          end;
          //if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: —ÔËÒÓÍ TSG_Proto: MD5String = ' + MD5String + ' | Query.FieldByName(''md5hash'') = ' + Query.FieldByName('md5hash').AsString, 2);
          if MD5String <> Query.FieldByName('md5hash').AsString then
          begin
            //WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ': ' + Query.FieldByName('uin').AsString + ' | ' + IntToStr(DateTimeToUnix(StrToDateTime(StringReplace(Query.FieldByName('msg_time').AsString, '-', '/', [RFReplaceall])))) + ' | ' + PrepareString(PWideChar(Query.FieldByName('msg_text').AsString)) + ' | ' + Query.FieldByName('md5hash').AsString + ' | '+ MD5String + #13#10 + '---------------------', 2);
            ChangeQuery.SQL.Clear;
            ChangeQuery.SQL.Text := 'update uin_'+ DBUserName + ' set md5hash = '''+ MD5String + ''' where id = ' + Query.FieldByName('id').AsString + ';';
            try
              ChangeQuery.ExecSQL;
            except
              on e: Exception do
              begin
                // ≈ÒÎË ÌÂÚ ÍÓÌÌÂÍÚ‡ ËÎË ÓÌ ‡ÁÓ‚‡ÎÒˇ, ÚÓ ÂÍÓÌÂÍÚËÏÒˇ
                if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
                begin
                  ZConnection1.Disconnect;
                  if not ReConnectDB then
                  begin
                    CheckMD5HashDone := False;
                    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
                    Query.Close;
                    ChangeQuery.Close;
                    DublicateQuery.Close;
                    Exit;
                  end
                  else
                  begin
                    Query.Open;
                    Query.RecNo := QueryRecNo;
                    ChangeQuery.ExecSQL;
                  end;
                end;
                Inc(ErrMsgMD5Cnt);
                if MatchStrings(StringReplace(e.Message,#13#10,'',[RFReplaceall]), '*Duplicate entry*for key*') or
                  MatchStrings(StringReplace(e.Message,#13#10,'',[RFReplaceall]), '*column*is not unique*') or
                  MatchStrings(StringReplace(e.Message,#13#10,'',[RFReplaceall]), '*duplicate key value violates unique*') then
                begin
                  Inc(ErrMD5DublicateMesCount);
                  DublicateQuery.SQL.Clear;
                  DublicateQuery.SQL.Text := 'select id,uin,msg_time,msg_text,md5hash from uin_'+ DBUserName + ' where md5hash = '''+ MD5String + ''';';
                  try
                    DublicateQuery.Open;
                  except
                    on e: Exception do
                    begin
                      // ≈ÒÎË ÌÂÚ ÍÓÌÌÂÍÚ‡ ËÎË ÓÌ ‡ÁÓ‚‡ÎÒˇ, ÚÓ ÂÍÓÌÂÍÚËÏÒˇ
                      if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
                      begin
                        ZConnection1.Disconnect;
                        if not ReConnectDB then
                        begin
                          CheckMD5HashDone := False;
                          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
                          Query.Close;
                          ChangeQuery.Close;
                          DublicateQuery.Close;
                          Exit;
                        end
                        else
                        begin
                          Query.Open;
                          Query.RecNo := QueryRecNo;
                          DublicateQuery.Open;
                        end;
                      end;
                    end;
                  end;
                  if DublicateQuery.FieldByName('md5hash').IsNull  then
                    DublicateMD5Hash := 'NULL_MD5_HASH'
                  else
                    DublicateMD5Hash := DublicateQuery.FieldByName('md5hash').AsString;
                  WriteInLog(ProfilePath, 'Original (table uin_'+ DBUserName +'): ' + DublicateQuery.FieldByName('id').AsString + ' | ' + DublicateQuery.FieldByName('uin').AsString + ' | ' + DublicateQuery.FieldByName('msg_time').AsString + ' | ' + StringReplace(UTF8ToWideString(DublicateQuery.FieldByName('msg_text').AsString),#13#10,'\n\r',[RFReplaceall]) + ' | ' + DublicateMD5Hash, 3);
                  DublicateQuery.Close;
                  DublicateQuery.SQL.Clear;
                  DublicateQuery.SQL.Text := 'select id,uin,msg_time,msg_text,md5hash from uin_'+ DBUserName + ' where id = '+ Query.FieldByName('id').AsString + ';';
                  try
                    DublicateQuery.Open;
                  except
                    on e: Exception do
                    begin
                      // ≈ÒÎË ÌÂÚ ÍÓÌÌÂÍÚ‡ ËÎË ÓÌ ‡ÁÓ‚‡ÎÒˇ, ÚÓ ÂÍÓÌÂÍÚËÏÒˇ
                      if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
                      begin
                        ZConnection1.Disconnect;
                        if not ReConnectDB then
                        begin
                          CheckMD5HashDone := False;
                          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
                          Query.Close;
                          ChangeQuery.Close;
                          DublicateQuery.Close;
                          Exit;
                        end
                        else
                        begin
                          Query.Open;
                          Query.RecNo := QueryRecNo;
                          DublicateQuery.Open;
                        end;
                      end;
                    end;
                  end;
                  if DublicateQuery.FieldByName('md5hash').IsNull  then
                    DublicateMD5Hash := 'NULL_MD5_HASH'
                  else
                    DublicateMD5Hash := DublicateQuery.FieldByName('md5hash').AsString;
                  WriteInLog(ProfilePath, 'Duplicate (table uin_'+ DBUserName +'): ' + DublicateQuery.FieldByName('id').AsString + ' | ' + DublicateQuery.FieldByName('uin').AsString + ' | ' + DublicateQuery.FieldByName('msg_time').AsString + ' | ' + StringReplace(UTF8ToWideString(DublicateQuery.FieldByName('msg_text').AsString),#13#10,'\n\r',[RFReplaceall]) + ' | ' + DublicateMD5Hash, 3);
                  DublicateQuery.Close;
                  // ”‰‡ÎˇÂÏ ‰Û·ÎËÍ‡Ú˚
                  if DeleteDublicate then
                  begin
                    DublicateQuery.SQL.Clear;
                    DublicateQuery.SQL.Text := 'delete from uin_'+ DBUserName + ' where id = '+ Query.FieldByName('id').AsString + ';';
                    try
                      DublicateQuery.ExecSQL;
                      Inc(DeletedMD5DublicateMesCount);
                    except
                      on e: Exception do
                      begin
                        // ≈ÒÎË ÌÂÚ ÍÓÌÌÂÍÚ‡ ËÎË ÓÌ ‡ÁÓ‚‡ÎÒˇ, ÚÓ ÂÍÓÌÂÍÚËÏÒˇ
                        if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
                        begin
                          ZConnection1.Disconnect;
                          if not ReConnectDB then
                          begin
                            CheckMD5HashDone := False;
                            if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
                            Query.Close;
                            ChangeQuery.Close;
                            DublicateQuery.Close;
                            Exit;
                          end
                          else
                          begin
                            Query.Open;
                            Query.RecNo := QueryRecNo;
                            DublicateQuery.ExecSQL;
                          end;
                        end;
                        if WriteErrLog then
                          WriteInLog(ProfilePath, Format(ERR_SEND_UPDATE, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), Trim(e.Message)]), 1);
                      end;
                    end;
                  end;
                  // End
                end;
                if WriteErrLog then
                  WriteInLog(ProfilePath, Format(ERR_SEND_UPDATE, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), StringReplace(e.Message,#13#10,'',[RFReplaceall])]), 1);
              end;
            end;
            ChangeQuery.Close;
            Inc(MsgMD5Cnt);
          end;
          // ¬˚‚Ó‰ ÒÚ‡ÚËÒÚËÍË
          if CheckQueryRecNo(TotalMD5Hash, QueryRecNo) then
          begin
            TMainSyncForm(Params).ThreadMsgNum := 2;
            TMainSyncForm(Params).ProgressBarCount := QueryRecNo;
            TMainSyncForm(Params).CheckTotalBrokenMD5Hash—ount := IntToStr(MsgMD5Cnt);
            TMainSyncForm(Params).CheckTotalChangeMD5Hash—ount := IntToStr(MsgMD5Cnt-ErrMsgMD5Cnt);
            TMainSyncForm(Params).CheckTotalMD5DublicateMesCount := IntToStr(ErrMD5DublicateMesCount);
            TMainSyncForm(Params).CheckTotalDeletedMD5DublicateMesCount := IntToStr(DeletedMD5DublicateMesCount);
            CheckMD5HashThread.Synchronize(TMainSyncForm(Params).MD5ThreadShowMessage);
          end;
          Query.Next;
        until Query.Eof;
        Query.Close;
      end;
      // End
      // »˘ÂÏ ‰Û·ÎËÍ‡Ú˚ ‚ Ú‡·ÎËˆÂ uin_chat_username
      Query.SQL.Clear;
      Query.SQL.Text := 'select count(*) as cnt from uin_chat_'+ DBUserName + ';';
      try
        Query.Open;
      except
        on e: Exception do
        begin // –ÂÍÓÌÂÍÚ ‚ ÒÎÛ˜‡Â ÔÓÚÂË Ò‚ˇÁË
          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - Exception ‚ ÔÓˆÂ‰ÛÂ CheckMD5HashThreadExecute (Query): ' + Trim(e.Message), 2);
          if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
          begin
            ZConnection1.Disconnect;
            if not ReConnectDB then
            begin
              CheckMD5HashDone := False;
              if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
              Query.Close;
              ChangeQuery.Close;
              DublicateQuery.Close;
              Exit;
              end;
            end
            else
              try
                Query.Open;
              except
              end;
          end;
        end;
      TotalMD5Hash := Query.FieldByName('cnt').AsInteger;
      Query.Close;
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: —ÔËÒÓÍ TSG_Proto: ¬ÒÂ„Ó Á‡ÔËÒÂÈ ‚ Ú‡·ÎËˆÂ uin_chat_' + DBUserName + ' = ' + IntToStr(TotalMD5Hash), 2);
      // ¬˚‚Ó‰ Ì‡˜‡Î¸ÌÓÈ ÒÚ‡ÚËÒÚËÍË ÔÓ MD5 ı˝¯‡Ï
      TMainSyncForm(Params).ThreadMsgNum := 2;
      TMainSyncForm(Params).CheckTotalBrokenMD5Hash—ount := '0';
      TMainSyncForm(Params).CheckTotalChangeMD5Hash—ount := '0';
      TMainSyncForm(Params).CheckTotalMD5DublicateMesCount := '0';
      TMainSyncForm(Params).CheckTotalDeletedMD5DublicateMesCount := '0';
      TMainSyncForm(Params).CheckTotalHashMsg—ount := TotalMD5Hash;
      TMainSyncForm(Params).ProgressBarCount := 0;
      CheckMD5HashThread.Synchronize(TMainSyncForm(Params).MD5ThreadShowMessage);
      // End
      if TotalMD5Hash = 0 then
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: TotalMD5Hash = 0 - «‡‚Â¯ÂÌËÂ ÔÓÚÓÍ‡ CheckMD5HashThread.', 2);
        CheckMD5HashDone := True;
        ChangeQuery.Close;
        DublicateQuery.Close;
        Exit;
      end;
      Query.SQL.Clear;
      Query.SQL.Text := 'select id,nick_name,msg_time,msg_text,md5hash from uin_chat_'+ DBUserName + ';';
      try
        Query.Open;
      except
        on e: Exception do
        begin // –ÂÍÓÌÂÍÚ ‚ ÒÎÛ˜‡Â ÔÓÚÂË Ò‚ˇÁË
          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - Exception ‚ ÔÓˆÂ‰ÛÂ CheckMD5HashThreadExecute (Query): ' + Trim(e.Message), 2);
          if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
          begin
            ZConnection1.Disconnect;
            if not ReConnectDB then
            begin
              CheckMD5HashDone := False;
              if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
              Query.Close;
              ChangeQuery.Close;
              DublicateQuery.Close;
              Exit;
              end;
            end
            else
              try
                Query.Open;
              except
              end;
          end;
        end;
      MsgMD5Cnt := 0;
      ErrMsgMD5Cnt := 0;
      ErrMD5DublicateMesCount := 0;
      DeletedMD5DublicateMesCount := 0;
      repeat
        QueryRecNo := Query.RecNo;
        MD5String := EncryptMD5(Query.FieldByName('nick_name').AsString + FormatDateTime('YYYY-MM-DD HH:MM:SS', StrToDateTime(StringReplace(Query.FieldByName('msg_time').AsString, '-', '/', [RFReplaceall]))) + Query.FieldByName('msg_text').AsString);
        if CheckMD5HashThread.Terminated then
        begin
          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ›ÍÒÚÂÌÌÓÂ Á‡‚Â¯ÂÌËÂ ÔÓÚÓÍ‡ CheckMD5HashThread.', 2);
          CheckMD5HashDone := False;
          Query.Close;
          ChangeQuery.Close;
          DublicateQuery.Close;
          Exit;
        end;
        if MD5String <> Query.FieldByName('md5hash').AsString then
        begin
          ChangeQuery.SQL.Clear;
          ChangeQuery.SQL.Text := 'update uin_chat_'+ DBUserName + ' set md5hash = '''+ MD5String + ''' where id = ' + Query.FieldByName('id').AsString + ';';
          try
            ChangeQuery.ExecSQL;
          except
            on e :
              Exception do
              begin
                // ≈ÒÎË ÌÂÚ ÍÓÌÌÂÍÚ‡ ËÎË ÓÌ ‡ÁÓ‚‡ÎÒˇ, ÚÓ ÂÍÓÌÂÍÚËÏÒˇ
                if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
                begin
                  ZConnection1.Disconnect;
                  if not ReConnectDB then
                  begin
                    CheckMD5HashDone := False;
                    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
                    Query.Close;
                    ChangeQuery.Close;
                    DublicateQuery.Close;
                    Exit;
                  end
                  else
                  begin
                    Query.Open;
                    Query.RecNo := QueryRecNo;
                    ChangeQuery.ExecSQL;
                  end;
                end;
                Inc(ErrMsgMD5Cnt);
                if MatchStrings(StringReplace(e.Message,#13#10,'',[RFReplaceall]), '*Duplicate entry*for key*') or
                    MatchStrings(StringReplace(e.Message,#13#10,'',[RFReplaceall]), '*column*is not unique*') or
                    MatchStrings(StringReplace(e.Message,#13#10,'',[RFReplaceall]), '*duplicate key value violates unique*') then
                begin
                  Inc(ErrMD5DublicateMesCount);
                  DublicateQuery.SQL.Clear;
                  DublicateQuery.SQL.Text := 'select id,nick_name,msg_time,msg_text,md5hash from uin_chat_'+ DBUserName + ' where md5hash = '''+ MD5String + ''';';
                  try
                    DublicateQuery.Open;
                  except
                    on e: Exception do
                    begin
                      // ≈ÒÎË ÌÂÚ ÍÓÌÌÂÍÚ‡ ËÎË ÓÌ ‡ÁÓ‚‡ÎÒˇ, ÚÓ ÂÍÓÌÂÍÚËÏÒˇ
                      if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
                      begin
                        ZConnection1.Disconnect;
                        if not ReConnectDB then
                        begin
                          CheckMD5HashDone := False;
                          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
                          Query.Close;
                          ChangeQuery.Close;
                          DublicateQuery.Close;
                          Exit;
                        end
                        else
                        begin
                          Query.Open;
                          Query.RecNo := QueryRecNo;
                          DublicateQuery.Open;
                        end;
                      end;
                    end;
                  end;
                  if DublicateQuery.FieldByName('md5hash').IsNull  then
                    DublicateMD5Hash := 'NULL_MD5_HASH'
                  else
                    DublicateMD5Hash := DublicateQuery.FieldByName('md5hash').AsString;
                  WriteInLog(ProfilePath, 'Original (table uin_chat_'+ DBUserName +'): ' + DublicateQuery.FieldByName('id').AsString + ' | ' + DublicateQuery.FieldByName('nick_name').AsString + ' | ' + DublicateQuery.FieldByName('msg_time').AsString + ' | ' + StringReplace(UTF8ToWideString(DublicateQuery.FieldByName('msg_text').AsString),#13#10,'\n\r',[RFReplaceall]) + ' | ' + DublicateMD5Hash, 3);
                  DublicateQuery.Close;
                  DublicateQuery.SQL.Clear;
                  DublicateQuery.SQL.Text := 'select id,nick_name,msg_time,msg_text,md5hash from uin_chat_'+ DBUserName + ' where id = '+ Query.FieldByName('id').AsString + ';';
                  try
                    DublicateQuery.Open;
                  except
                    on e: Exception do
                    begin
                      // ≈ÒÎË ÌÂÚ ÍÓÌÌÂÍÚ‡ ËÎË ÓÌ ‡ÁÓ‚‡ÎÒˇ, ÚÓ ÂÍÓÌÂÍÚËÏÒˇ
                      if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
                      begin
                        ZConnection1.Disconnect;
                        if not ReConnectDB then
                        begin
                          CheckMD5HashDone := False;
                          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
                          Query.Close;
                          ChangeQuery.Close;
                          DublicateQuery.Close;
                          Exit;
                        end
                        else
                        begin
                          Query.Open;
                          Query.RecNo := QueryRecNo;
                          DublicateQuery.Open;
                        end;
                      end;
                    end;
                  end;
                  if DublicateQuery.FieldByName('md5hash').IsNull  then
                    DublicateMD5Hash := 'NULL_MD5_HASH'
                  else
                    DublicateMD5Hash := DublicateQuery.FieldByName('md5hash').AsString;
                  WriteInLog(ProfilePath, 'Duplicate (table uin_chat_'+ DBUserName +'): ' + DublicateQuery.FieldByName('id').AsString + ' | ' + DublicateQuery.FieldByName('nick_name').AsString + ' | ' + DublicateQuery.FieldByName('msg_time').AsString + ' | ' + StringReplace(UTF8ToWideString(DublicateQuery.FieldByName('msg_text').AsString),#13#10,'\n\r',[RFReplaceall]) + ' | ' + DublicateMD5Hash, 3);
                  DublicateQuery.Close;
                  // ”‰‡ÎˇÂÏ ‰Û·ÎËÍ‡Ú˚
                  if DeleteDublicate then
                  begin
                    DublicateQuery.SQL.Clear;
                    DublicateQuery.SQL.Text := 'delete from uin_chat_'+ DBUserName + ' where id = '+ Query.FieldByName('id').AsString + ';';
                    try
                      DublicateQuery.ExecSQL;
                      Inc(DeletedMD5DublicateMesCount);
                    except
                      on e: Exception do
                      begin
                        // ≈ÒÎË ÌÂÚ ÍÓÌÌÂÍÚ‡ ËÎË ÓÌ ‡ÁÓ‚‡ÎÒˇ, ÚÓ ÂÍÓÌÂÍÚËÏÒˇ
                        if (not ZConnection1.Connected) or (MatchStrings(e.Message, '*MySQL server has gone away*')) then
                        begin
                          ZConnection1.Disconnect;
                          if not ReConnectDB then
                          begin
                            CheckMD5HashDone := False;
                            if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadExecute: ÕÂÛ‰‡˜Ì˚È ReConnectDB. «‡‚Â¯‡ÂÏ ÔÓÚÓÍ.', 2);
                            Query.Close;
                            ChangeQuery.Close;
                            DublicateQuery.Close;
                            Exit;
                          end
                          else
                          begin
                            Query.Open;
                            Query.RecNo := QueryRecNo;
                            DublicateQuery.ExecSQL;
                          end;
                        end;
                        if WriteErrLog then
                          WriteInLog(ProfilePath, Format(ERR_SEND_UPDATE, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), Trim(e.Message)]), 1);
                      end;
                    end;
                    DublicateQuery.Close;
                  end;
                  // End
                end;
                if WriteErrLog then
                  WriteInLog(ProfilePath, Format(ERR_SEND_UPDATE, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), Trim(e.Message)]), 1);
              end;
          end;
          ChangeQuery.Close;
          Inc(MsgMD5Cnt);
          //WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ': ' + ChangeQuery.SQL.Text, 2);
        end;
        // ¬˚‚Ó‰ ÒÚ‡ÚËÒÚËÍË
        if CheckQueryRecNo(TotalMD5Hash, QueryRecNo) then
        begin
          TMainSyncForm(Params).ThreadMsgNum := 2;
          TMainSyncForm(Params).ProgressBarCount := QueryRecNo;
          TMainSyncForm(Params).CheckTotalBrokenMD5Hash—ount := IntToStr(MsgMD5Cnt);
          TMainSyncForm(Params).CheckTotalChangeMD5Hash—ount := IntToStr(MsgMD5Cnt-ErrMsgMD5Cnt);
          TMainSyncForm(Params).CheckTotalMD5DublicateMesCount := IntToStr(ErrMD5DublicateMesCount);
          TMainSyncForm(Params).CheckTotalDeletedMD5DublicateMesCount := IntToStr(DeletedMD5DublicateMesCount);
          CheckMD5HashThread.Synchronize(TMainSyncForm(Params).MD5ThreadShowMessage);
        end;
        Query.Next;
      until Query.Eof;
      Query.Close;
      // End
    finally
      Query.Free;
      ChangeQuery.Free;
      DublicateQuery.Free;
    end;
    CheckMD5HashDone := True;
  end;
end;

{ œÓÚÓÍ ÔÂÂ‡Ò˜ÂÚ‡ MD5-ıÂ¯ÂÈ Á‡‚Â¯ÂÌ }
procedure TMainSyncForm.CheckMD5HashThreadFinish(Sender: TObject);
begin
  SyncProgressBar.Position := 0;
  CheckMD5HashStartedEnabled := False;
  if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ CheckMD5HashThreadFinish: œÓÚÓÍ CheckMD5HashThread ‚˚ÔÓÎÌÂÌ.', 2);
  // ŒÚÍÎ˛˜‡ÂÏÒˇ ÓÚ ¡ƒ
  if (not SyncHistoryStartedEnabled) and (not UpdateContactListStartedEnabled) then
    ZConnection1.Disconnect;
  // «‡Í‡Ì˜Ë‚‡ÂÏ ÏË„‡Ú¸ ‚ ÚÂÂ
  if not SyncHistoryStartedEnabled then
    StopSyncTrayFlashingTimer;
  // ¬ÍÎ˛˜‡ÂÏ ÍÌÓÔÍË Ë Ú.Ô.
  EnableButton;
  // «‡ÔÛÒÍ Ú‡ÈÏÂ‡ ÒËÌıÓÌËÁ‡ˆËË ÔÓ ‚ÂÏÂÌË
  if (StartStopSyncButton.Visible) and (not SyncTimerEnabled) and (not SyncHistoryStartedEnabled) then
    StartStopSyncButtonClick(StartStopSyncButton);
  // œÓ‰ÒÍ‡ÁÍ‡ ‚ ÚÂÂ
  if SyncHistoryStartedEnabled then
    HistoryToDBSyncTray.Hint := Caption + ' - ' + GetLangStr('HistoryToDBSyncStarted')
  else
    HistoryToDBSyncTray.Hint := Caption;
  // ≈ÒÎË Ó·ÌÓ‚ÎÂÌËÂ ÔÓ¯ÎÓ ·ÂÁ Ó¯Ë·ÓÍ
  if CheckMD5HashDone then
    ShowBalloonHint(MainSyncForm.Caption, GetLangStr('HistoryToDBSyncMD5Done'))
  else
    ShowBalloonHint(MainSyncForm.Caption, GetLangStr('HistoryToDBSyncMD5Err') + #13#10 + GetLangStr('SeeErrLog'));
  // ¬˚ıÓ‰ ËÁ ÔÓ„‡ÏÏ˚ ÔÓ ÓÚÎÓÊÂÌÌÓÏÛ Á‡ÔÓÒÛ
  if CloseRequest and (not SyncHistoryStartedEnabled) and (not UpdateContactListStartedEnabled) then
    HistoryExitClick(Self);
end;

{ —ËÌıÓÌËÁ‡ˆËˇ ÔÓÚÓÍ‡ SyncThread Ò ÓÒÌÓ‚ÌÓÈ ÔÓ„‡ÏÏÓÈ - ¬˚‚Ó‰ ÒÓÓ·˘ÂÌËÈ }
procedure TMainSyncForm.SyncThreadShowMessage;
begin
  case ThreadMsgNum of
  1: // Õ‡˜‡ÎÓ ÒËÌıÓÌËÁ‡ˆËË, ÓÒÚ‡ÌÓ‚Í‡ Ú‡ÈÏÂÓ‚, ÓÚÍÎ˛˜ÂÌËÂ ÍÌÓÔÓÍ
    begin
      // ŒÒÚ‡Ì‡‚ÎË‚‡ÂÏ Ú‡ÈÏÂ ÒËÌıÓÌËÁ‡ˆËË
      if (StartStopSyncButton.Visible) and (SyncTimerEnabled) then
        StartStopSyncButtonClick(StartStopSyncButton);
      // ÃÂÌˇÂÏ ÒÓÓ·˘ÂÌËÂ ‚ ÚÂÂ Ë Ú.Ô.
      HistoryToDBSyncTray.Hint := Caption + ' - ' + GetLangStr('HistoryToDBSyncStarted');
      HistoryToDBSyncTray.IconIndex := 0;
      LSyncStatusSet.Caption := GetLangStr('HistoryToDBSyncStarted');
      LSyncStatusSet.Hint := 'HistoryToDBSyncStarted';
      // ŒÚÍÎ˛˜‡ÂÏ ÍÌÓÔÍË
      DisableButton;
      // «‡ÔÛÒÍ‡ÂÏ ÏË„‡ÌËÂ ‚ ÚÂÂ
      if not SyncTrayFlashingTimerEnabled then
        StartSyncTrayFlashingTimer;
      // ¬˚‚Ó‰ ÒÓÓ·˘ÂÌËˇ ‚ ÚÂÈ
      if ThreadMsgStr <> '' then
        ShowBalloonHint(MainSyncForm.Caption, ThreadMsgStr);
    end;
  2:
    begin
      if not SyncTrayFlashingTimerEnabled then // ÃË„‡ÂÏ ‚ ÚÂÂ
        StartSyncTrayFlashingTimer;
      // ÃÂÌˇÂÏ ÒÓÓ·˘ÂÌËÂ ‚ ÚÂÂ Ë Ú.Ô.
      HistoryToDBSyncTray.Hint := Caption + ' - ' + GetLangStr('HistoryToDBSyncStarted');
      // œÓ„ÂÒ·‡
      try
        SyncProgressBar.Max := SyncTotalMesCount - 1;
        SyncProgressBar.Position := SyncMesCurrentCount;
      except
      end;
      LMesCurrentCount.Caption := IntToStr(SyncMesCurrentCount);
      LEncryptMesCount.Caption := IntToStr(SyncEncryptMsgCount);
      LTotalMesCount.Caption := IntToStr(SyncTotalMesCount);
      if SyncBadMesCount <> '' then
        LBadMesCount.Caption := SyncBadMesCount;
      if SyncDublicateMesCount <> '' then
        LDublicateMesCount.Caption := SyncDublicateMesCount;
      if SyncStartTime <> '' then
        LStartTime.Caption := SyncStartTime;
      if SyncEndTime <> '' then
        LEndTime.Caption := SyncEndTime;
      // ¬˚‚Ó‰ ÒÓÓ·˘ÂÌËˇ ‚ ÚÂÈ
      if ThreadMsgStr <> '' then
        ShowBalloonHint(MainSyncForm.Caption, ThreadMsgStr);
    end;
  3:
    begin
      ShowBalloonHint(MainSyncForm.Caption, ThreadMsgStr);
    end;
  end;
end;

{ —ËÌıÓÌËÁ‡ˆËˇ ÔÓÚÓÍ‡ CheckMD5HashThread Ò ÓÒÌÓ‚ÌÓÈ ÔÓ„‡ÏÏÓÈ - ¬˚‚Ó‰ ÒÓÓ·˘ÂÌËÈ }
procedure TMainSyncForm.MD5ThreadShowMessage;
begin
  case ThreadMsgNum of
  1: // Õ‡˜‡ÎÓ ÔÓ‚ÂÍË, ÓÒÚ‡ÌÓ‚Í‡ ‚ÒˇÍËı ÌÂÌÛÊÌ˚ı ‚Â˘ÂÈ
    begin
      // ŒÒÚ‡Ì‡‚ÎË‚‡ÂÏ Ú‡ÈÏÂ ÒËÌıÓÌËÁ‡ˆËË
      if (StartStopSyncButton.Visible) and (SyncTimerEnabled) then
        StartStopSyncButtonClick(StartStopSyncButton);
      // ÃÂÌˇÂÏ ÒÓÓ·˘ÂÌËÂ ‚ ÚÂÂ
      if (not SyncHistoryStartedEnabled) then
      begin
        HistoryToDBSyncTray.Hint := Caption + ' - ' + GetLangStr('HistoryToDBSyncStartMD5');
        HistoryToDBSyncTray.IconIndex := 0;
      end;
      // ŒÚÍÎ˛˜‡ÂÏ ÍÌÓÔÍË
      DisableButton;
      // «‡ÔÛÒÍ‡ÂÏ ÏË„‡ÌËÂ ‚ ÚÂÂ
      if not SyncTrayFlashingTimerEnabled then
        StartSyncTrayFlashingTimer;
      if ThreadMsgStr <> '' then
        ShowBalloonHint(MainSyncForm.Caption, ThreadMsgStr);
    end;
  2: // ¬˚‚Ó‰ ÒÚ‡ÚËÒÚËÍË ÔÓ MD5 ı˝¯‡Ï
    begin
      LTotalHashMsg—ount.Caption := IntToStr(CheckTotalHashMsg—ount);
      // «‡ÔÛÒÍ ÏË„‡ÌËˇ ‚ ÚÂÂ
      if not SyncTrayFlashingTimerEnabled then
        StartSyncTrayFlashingTimer;
      if CheckTotalBrokenMD5Hash—ount <> '' then
        LTotalBrokenMD5Hash—ount.Caption := CheckTotalBrokenMD5Hash—ount;
      if CheckTotalChangeMD5Hash—ount <> '' then
        LTotalChangeMD5Hash—ount.Caption := CheckTotalChangeMD5Hash—ount;
      if CheckTotalMD5DublicateMesCount <> '' then
        LMD5DublicateMesCount.Caption := CheckTotalMD5DublicateMesCount;
      if CheckTotalDeletedMD5DublicateMesCount <> '' then
        LDeletedMD5DublicateMesCount.Caption := CheckTotalDeletedMD5DublicateMesCount;
      // œÓ„ÂÒ·‡
      try
        SyncProgressBar.Max := CheckTotalHashMsg—ount - 1;
        SyncProgressBar.Position := ProgressBarCount;
      except
      end;
    end;
  3: // ¬˚‚Ó‰ ‚ÒÔÎ˚‚‡˛˘Ëı ÒÓÓ·˘ÂÌËÈ ‚ ÚÂÈ
    begin
      ShowBalloonHint(MainSyncForm.Caption, ThreadMsgStr);
    end;
  end;
end;

{ —ËÌıÓÌËÁ‡ˆËˇ ÔÓÚÓÍ‡ UpdateContactListThread Ò ÓÒÌÓ‚ÌÓÈ ÔÓ„‡ÏÏÓÈ - ¬˚‚Ó‰ ÒÓÓ·˘ÂÌËÈ }
procedure TMainSyncForm.CLThreadShowMessage;
begin
  case ThreadMsgNum of
  1: // Õ‡˜‡ÎÓ ÔÓ‚ÂÍË, ÓÒÚ‡ÌÓ‚Í‡ ‚ÒˇÍËı ÌÂÌÛÊÌ˚ı ‚Â˘ÂÈ
    begin
      // ŒÒÚ‡Ì‡‚ÎË‚‡ÂÏ Ú‡ÈÏÂ ÒËÌıÓÌËÁ‡ˆËË
      if (StartStopSyncButton.Visible) and (SyncTimerEnabled) then
        StartStopSyncButtonClick(StartStopSyncButton);
      // ÃÂÌˇÂÏ ÒÓÓ·˘ÂÌËÂ ‚ ÚÂÂ
      if (not SyncHistoryStartedEnabled) then
      begin
        HistoryToDBSyncTray.Hint := Caption + ' - ' + GetLangStr('HistoryToDBSyncStartUpdateCL');
        HistoryToDBSyncTray.IconIndex := 0;
      end;
      // ŒÚÍÎ˛˜‡ÂÏ ÍÌÓÔÍË
      DisableButton;
      // «‡ÔÛÒÍ‡ÂÏ ÏË„‡ÌËÂ ‚ ÚÂÂ
      if not SyncTrayFlashingTimerEnabled then
        StartSyncTrayFlashingTimer;
      if ThreadMsgStr <> '' then
        ShowBalloonHint(MainSyncForm.Caption, ThreadMsgStr);
    end;
  2: // ¬˚‚Ó‰ ÒÚ‡ÚËÒÚËÍË
    begin
      // œÓ„ÂÒ·‡
      try
        SyncProgressBar.Max := CheckTotalHashMsg—ount - 1;
        SyncProgressBar.Position := ProgressBarCount;
      except
      end;
    end;
  3: // ¬˚‚Ó‰ ‚ÒÔÎ˚‚‡˛˘Ëı ÒÓÓ·˘ÂÌËÈ ‚ ÚÂÈ
    begin
      ShowBalloonHint(MainSyncForm.Caption, ThreadMsgStr);
    end;
  end;
end;

{ ¬˚‚Ó‰ËÏ ÓÍÌÓ ‰Îˇ ‚‚Ó‰‡ Ô‡ÓÎˇ ÍÎ˛˜‡ ¯ËÙÓ‚‡ÌËˇ }
procedure TMainSyncForm.ReadEncryptionKey;
var
  EncryptionKeyPassword, KeyPassword: String;
  TempEncryptionKey, TempEncryptionKeyID: String;
  Status: Integer;
begin
  if not KeyPasswdSave then
  begin
    if EncryptionKey = '' then
    begin
      KeyPasswdForm.Show;
      while Global_KeyPasswdForm_Showing do
      begin
        Sleep(1);
        Forms.Application.ProcessMessages;
      end;
    end;
  end
  else
  begin
    Status := GetEncryptionKey('', TempEncryptionKey, TempEncryptionKeyID);
    if Status = 1 then // Œ¯Ë·Í‡ - ¬ ¡ƒ ÌÂ‚ÂÌ˚È Ô‡ÓÎ¸ ÍÎ˛˜‡
      MsgInf(MainSyncForm.Caption + ' - ' + GetLangStr('HistoryToDBSyncCheckEncKey'), GetLangStr('HistoryToDBSyncErrKeyPassword'))
    else if Status = 2 then // œ‡ÓÎ¸ ‚ÂÌ˚È, ÍÎ˛˜ ÔÓÎÛ˜ÂÌ
    begin
      EncryptionKeyID := TempEncryptionKeyID;
      EncryptionKey := TempEncryptionKey;
    end
    else if Status = 3 then // Œ¯Ë·Í‡ ‡Ò¯ËÙÓ‚ÍË
      MsgInf(MainSyncForm.Caption + ' - ' + GetLangStr('HistoryToDBSyncCheckEncKey'), GetLangStr('HistoryToDBSyncErrDecryptKey'))
    else if Status = 4 then // Œ¯Ë·Í‡ - Õ‡È‰ÂÌÓ ·ÓÎÂÂ 1 ‡ÍÚ. ÍÎ˛˜‡
      MsgInf(MainSyncForm.Caption + ' - ' + GetLangStr('HistoryToDBSyncCheckEncKey'), GetLangStr('HistoryToDBSyncMultiActiveKey'))
    else if Status = 5 then // Œ¯Ë·Í‡ - ÕÂ Ì‡È‰ÂÌÓ ‡ÍÚ. ÍÎ˛˜ÂÈ
      MsgInf(MainSyncForm.Caption + ' - ' + GetLangStr('HistoryToDBSyncCheckEncKey'), GetLangStr('HistoryToDBSyncErrActiveKey'))
    else if Status = 6 then // Œ¯Ë·Í‡ - ÕÂÚ ‰ÓÒÚÛÔ‡ Í ¡ƒ
      MsgInf(MainSyncForm.Caption + ' - ' + GetLangStr('HistoryToDBSyncCheckEncKey'), GetLangStr('ErrDBConnect'))
    else  // Œ¯Ë·Í‡ - ¬ Ù‡ÈÎÂ ÌÂ‚ÂÌ˚È Ô‡ÓÎ¸ ÍÎ˛˜‡
    begin
      KeyPasswdForm.Show;
      while Global_KeyPasswdForm_Showing do
      begin
        Sleep(1);
        Forms.Application.ProcessMessages;
      end;
    end;
  end;
end;

{ œÓ‚ÂˇÂÏ ‡ÍÚË‚ÌÓÒÚ¸ ÍÎ˛˜‡ Ë Â„Ó ÔÓÎÛ˜‡ÂÏ Â„Ó ÌÓÏÂ }
function TMainSyncForm.GetCurrentEncryptionKeyID(var ActiveKeyID: String): Integer;
var
  KeyCnt, Status: Integer;
begin
  // œÓ‰ÍÎ˛˜‡ÂÏÒˇ Í ·‡ÁÂ
  ConnectDB;
  if ZConnection1.Connected then
  begin
    SQL_Zeos_Key('select count(*) as cnt from key_'+ DBUserName + ' where status_key = 1');
    KeyCnt := KeyQuery.FieldByName('cnt').AsInteger;
    if KeyCnt = 1 then // Õ‡È‰ÂÌ 1 ‡ÍÚË‚Ì˚È ÍÎ˛˜
    begin
      SQL_Zeos_Key('select id from key_'+ DBUserName + ' where status_key = 1');
      Status := 1; // ¬ÒÂ ıÓÓ¯Ó
      ActiveKeyID := KeyQuery.FieldByName('id').AsString;
    end
    else if KeyCnt > 1 then
      Status := 2  // Œ¯Ë·Í‡ - Õ‡È‰ÂÌÓ ·ÓÎÂÂ 1 ‡ÍÚ. ÍÎ˛˜‡
    else
      Status := 3; // Œ¯Ë·Í‡ - ÕÂ Ì‡È‰ÂÌÓ ‡ÍÚ. ÍÎ˛˜ÂÈ
    if (not CheckMD5HashStartedEnabled) and (not SyncHistoryStartedEnabled) and (not UpdateContactListStartedEnabled) then
      ZConnection1.Disconnect;
  end
  else
    Status := 4; // Œ¯Ë·Í‡ - ÕÂÚ ÔÓ‰ÍÎ˛˜ÂÌËˇ Í ¡ƒ
  Result := Status;
end;

{ œÓÎÛ˜‡ÂÏ ÍÎ˛˜¸ ¯ËÙÓ‚‡ÌËˇ ËÁ ¡ƒ }
function TMainSyncForm.GetEncryptionKey(KeyPwd: String; var EncryptKey, EncryptKeyID: String): Integer;
var
  Cipher: TDCP_3des;
  Digest: Array[0..19] of Byte;
  Hash: TDCP_sha1;
  KeyCnt, Status: Integer;
  INIKeyPasswd: String;
  INIKeyPasswdRead: Boolean;
  DBKeyID, DBKeyEncryptionMethod, DBEncryptKey: String;
  FinalFullKey, FinalKeyID, FinalKeyEncryptionMethod, FinalKey, KeyPassword: String;
begin
  // œÓ‰ÍÎ˛˜‡ÂÏÒˇ Í ·‡ÁÂ
  ConnectDB;
  if ZConnection1.Connected then
  begin
    SQL_Zeos_Key('select count(*) as cnt from key_'+ DBUserName + ' where status_key = 1');
    KeyCnt := KeyQuery.FieldByName('cnt').AsInteger;
    if KeyCnt = 1 then
    begin
      SQL_Zeos_Key('select id, encryption_method, encryption_key from key_'+ DBUserName + ' where status_key = 1');
      DBEncryptKey := KeyQuery.FieldByName('encryption_key').AsString;
      DBKeyID := KeyQuery.FieldByName('id').AsString;
      DBKeyEncryptionMethod := KeyQuery.FieldByName('encryption_method').AsString;
      // ◊ËÚ‡ÂÏ Ô‡ÓÎ¸ ÚÓÎ¸ÍÓ ÔËÔ ‚˚ÁÓ‚Â ËÁ MainForm
      INIKeyPasswdRead := False;
      if (KeyPasswdSave) and (not Global_KeyPasswdForm_Showing) then
      begin
        INIKeyPasswd := ReadCustomINI(ProfilePath, 'Main', 'KeyPasswd'+DBKeyID, 'NoSave');
        KeyPwd := DecryptStr(INIKeyPasswd);
        INIKeyPasswdRead := True;
      end;
      // »ÌËˆË‡ÎËÁ‡ˆËˇ ÙÛÌÍˆËË ıÂ¯ËÓ‚‡ÌËˇ SHA1
      Hash:= TDCP_sha1.Create(Self);
      Hash.Init;
      Hash.UpdateStr(KeyPwd);
      Hash.Final(Digest);
      Hash.Free;
      // »ÌËˆË‡ÎËÁ‡ˆËˇ ÙÛÌÍˆËË ¯ËÙÓ‚‡ÌËˇ 3DES
      Cipher := TDCP_3des.Create(Self);
      Cipher.Init(Digest, Sizeof(Digest)*8, nil);
      // End
      // –‡Ò¯ËÙÓ‚˚‚‡ÂÏ ÍÎ˛˜ ‚‚Â‰ÂÌÌ˚Ï Ô‡ÓÎÂÏ ÔÓ ‡Î„ÓËÚÏÛ 3DES
      try
        Cipher.Reset;
        FinalFullKey := Cipher.DecryptString(DBEncryptKey);
        FinalKeyID :=  Tok('|', FinalFullKey);
        FinalKeyEncryptionMethod := Tok('|', FinalFullKey);
        FinalKey := Tok('|', FinalFullKey);
        if (DBKeyID <> FinalKeyID) and (DBKeyEncryptionMethod <> FinalKeyEncryptionMethod) then
        begin
          if INIKeyPasswdRead then
            Status := 7  // Œ¯Ë·Í‡ - ¬ Ù‡ÈÎÂ ÌÂ‚ÂÌ˚È Ô‡ÓÎ¸ ÍÎ˛˜‡
          else
            Status := 1; // Œ¯Ë·Í‡ - ¬ ¡ƒ ÌÂ‚ÂÌ˚È Ô‡ÓÎ¸ ÍÎ˛˜‡
        end
        else
        begin
          EncryptKey := Base64DecodeStr(FinalKey);
          EncryptKeyID := DBKeyID;
          Status := 2;
        end;
      except
        on e :
          Exception do
            Status := 3; // Œ¯Ë·Í‡ ‡Ò¯ËÙÓ‚ÍË
      end;
      Cipher.Burn;
      Cipher.Free;
    end
    else if KeyCnt > 1 then
      Status := 4 // Œ¯Ë·Í‡ - Õ‡È‰ÂÌÓ ·ÓÎÂÂ 1 ‡ÍÚ. ÍÎ˛˜‡
    else
      Status := 5; // Œ¯Ë·Í‡ - ÕÂ Ì‡È‰ÂÌÓ ‡ÍÚ. ÍÎ˛˜ÂÈ
    if (not CheckMD5HashStartedEnabled) and (not SyncHistoryStartedEnabled) and (not UpdateContactListStartedEnabled) then
      ZConnection1.Disconnect;
  end
  else
    Status := 6; // Œ¯Ë·Í‡ - ÕÂÚ ÔÓ‰ÍÎ˛˜ÂÌËˇ Í ¡ƒ
  Result := Status;
end;

{ œÓËÒÍ ‚ ÒÚÓÍÂ ÔÓ Â„ÛÎˇÌÓÏÛ ‚˚‡ÊÂÌË˛ }
function TMainSyncForm.RegExprMatchStrings(Source, PatternRegExpr: WideString): Boolean;
var
  RegStr: TRegExpr;
begin
  RegStr := TRegExpr.Create;
  try
    RegStr.Expression := PatternRegExpr;
    if RegStr.Exec(Source) then
      Result := True
    else
      Result := False;
  finally
    RegStr.Free;
  end;
end;

{ œÓ‰ÍÎ˛˜ÂÌ„ËÂ Í ¡ƒ Ò Ó·‡·ÓÚÍÓÈ Ó¯Ë·ÓÍ }
procedure TMainSyncForm.ConnectDB;
begin
  // œÓ‰ÍÎ˛˜‡ÂÏÒˇ Í ·‡ÁÂ
  if not ZConnection1.Connected then
  begin
    try
      ZConnection1.Connect;
    except
      on e: Exception do
      begin
        if not ReConnectDB then
          Exit;
      end
    end;
  end;
end;

function TMainSyncForm.ReConnectDB: Boolean;
var
  I: Integer;
begin
  if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - ‘ÛÌÍˆËˇ ReConnectDB: «‡ÔÛÒÍ.', 2);
  if not ZConnection1.Connected then
  begin
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - ‘ÛÌÍˆËˇ ReConnectDB: ÕÂÚ ÔÓ‰ÍÎ˛˜ÂÌËˇ Í ¡ƒ.', 2);
    // ŒÚÍÎ. ÏË„‡ÌËÂ ‚ ÚÂÂ
    if SyncTrayFlashingTimerEnabled then
      StopSyncTrayFlashingTimer;
    // œÓ·ÛÂÏ ÔÂÂÔÓ‰ÍÎ˛˜ËÚ¸Òˇ
    HistoryToDBSyncTray.IconIndex := 2;
    I := 0;
    while (not ZConnection1.Connected) and (I < ReconnectCount) do
    begin
      Inc(I);
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - ‘ÛÌÍˆËˇ ReConnectDB: ¬˚ÔÓÎÌˇÂÏ ZConnection1.Connect #' + IntToStr(I), 2);
      try
        ZConnection1.Connect;
      except
        on e: Exception do
        begin
          if WriteErrLog then
            WriteInLog(ProfilePath, Format(ERR_READ_DB_CONNECT_ERR, [FormatDateTime('dd.mm.yy hh:mm:ss', Now), Trim(e.Message)]), 1);
          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - Exception ‚ ÙÛÌÍˆËË ReConnectDB: ' + Trim(e.Message), 2);
          ZConnection1.Disconnect;
        end;
      end;
      //IMDelay(ReconnectInterval);
      Sleep(ReconnectInterval);
    end;
    if ZConnection1.Connected then
    begin
      HistoryToDBSyncTray.IconIndex := 0;
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - ‘ÛÌÍˆËˇ ReConnectDB: œÓ‰ÍÎ˛˜ÂÌËÂ Í ¡ƒ ÛÒÚ‡ÌÓ‚ÎÂÌÓ.', 2);
      Result := True;
    end
    else
    begin
      HistoryToDBSyncTray.IconIndex := 2;
      ShowBalloonHint(MainSyncForm.Caption, GetLangStr('ErrDBConnect') + #13#10 + GetLAngStr('SeeErrLog'));
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - ‘ÛÌÍˆËˇ ReConnectDB: ¬˚ÔÓÎÌÂÌÓ ' + IntToStr(ReconnectCount) + ' ÔÓÔ˚ÚÓÍ ÔÓ‰ÍÎ˛˜ÂÌËˇ Í ¡ƒ Ò ËÌÚÂ‚‡ÎÓÏ ' + IntToStr(ReconnectInterval) + ' ÏÒÂÍ. œÓ‰ÍÎ˛˜ËÚ¸Òˇ Í ¡ƒ ÌÂ Û‰‡ÎÓÒ¸.', 2);
      Result := False;
    end;
  end
  else
    Result := True;
end;

procedure TMainSyncForm.RunTimeSync;
begin
  if SyncMethod = 2 then
  begin
    if ((SyncInterval >= 0) and (SyncInterval < 4)) or (SyncInterval = 8) then
    begin
      StopJvSyncTimer;
      StartJvSyncTimer;
      StartStopSyncButton.Visible := True;
    end
    else
    begin
      StopJvSyncTimer;
      StartStopSyncButton.Visible := False;
    end;
  end
  else
  begin
    StopJvSyncTimer;
    StartStopSyncButton.Visible := False;
  end;
end;

{ ¬ÍÎ˛˜‡ÂÏ ÌÂÍÓÚÓ˚Â ÔÛÌÍÚ˚ ÏÂÌ˛ ‚ ÚÂÂ }
procedure TMainSyncForm.EnableButton;
begin
  SyncButton.Enabled := True;
  StartStopSyncButton.Enabled := True;
end;

{ ŒÚÍÎ˛˜‡ÂÏ ÌÂÍÓÚÓ˚Â ÔÛÌÍÚ˚ ÏÂÌ˛ ‚ ÚÂÂ }
procedure TMainSyncForm.DisableButton;
begin
  SyncButton.Enabled := False;
  StartStopSyncButton.Enabled := False;
end;

{ ¬ÍÎ. ÔÓ‰‰ÂÊÍË Skype }
procedure TMainSyncForm.EnableSkype;
begin
  SkypeInit := False;
  SkypeRunDone := False;
  SkypeAttachDone := False;
  try
    Skype := TSkype.Create(Self);
    SkypeInit := True;
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - ¬˚ÔÓÎÌÂÌÓ TSkype.Create', 4);
    if Global_RunningSkypeOnStartup then
    begin
      if not Skype.Client.IsRunning then
      begin
        LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeRun');
        LSkypeStatus.Hint := 'HistoryToDBSyncSkypeRun';
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œ˚Ú‡ÂÏÒˇ Á‡ÔÛÒÚËÚ¸ Skype...', 4);
        Skype.Client.Start(True, True);
      end;
    end;
  except
    on e :
      Exception do
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - Œ¯Ë·Í‡ ÒÓÁ‰‡ÌËˇ ËÌÚÂÙÂÈÒ‡ Skype: ' + e.Message, 4);
        LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeInitErr');
        LSkypeStatus.Hint := 'HistoryToDBSyncSkypeInitErr';
        SkypeInit := False;
        SkypeRunDone := False;
        Exit;
      end;
  end;
  SkypeStrList := TStringList.Create;
  SkypeChatList := TStringGrid.Create(nil);
  SkypeChatList.FixedCols := 0;
  SkypeChatList.FixedRows := 0;
  SkypeChatList.ColCount := 3;
  SkypeChatList.RowCount := 0;
  SkypeStrList.Clear;
  JvThreadTimerSkype.Enabled := True;
end;

{ —‡·ÓÚÍ‡ Ú‡ÈÏÂ‡ ‰Îˇ ‡‚ÚÓÏ‡ÚË˜ÂÒÍÓ„Ó ÂÊËÏ‡ ÒËÌıÓÌËÁ‡ˆËË }
procedure TMainSyncForm.JvThreadTimerAutoSyncTimer(Sender: TObject);
begin
  JvThreadTimerAutoSync.Enabled := False;
  if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ JvThreadTimerAutoSyncTimer: ¬˚ÔÓÎÌˇÂÏ ÒËÌıÓÌËÁ‡ˆË˛ ËÒÚÓËË ‚ ÂÊËÏÂ ‡‚ÚÓ.', 2);
  SyncButtonClick(Self);
end;

procedure TMainSyncForm.JvThreadTimerSkypeTimer(Sender: TObject);
begin
  // «‡ÔÛÒÍ‡ÂÏ Skype ÚÓÎ¸ÍÓ ÂÒÎË Á‡ÔÛÒÍ HistoryToDBSync Ë‰ÂÚ Ò 3 Ô‡‡ÏÂÚÓÏ = 0
  if (not Skype.Client.IsRunning) and (not SkypeRunDone) and (IMClientType = 'Skype') then
  begin
    try
      LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeRun');
      LSkypeStatus.Hint := 'HistoryToDBSyncSkypeRun';
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œ˚Ú‡ÂÏÒˇ Á‡ÔÛÒÚËÚ¸ Skype...', 4);
      Skype.Client.Start(True, False);
      SkypeRunDone := True;
    except
      on e :
        Exception do
        begin
          SkypeRunDone := False;
          LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeRunErr');
          LSkypeStatus.Hint := 'HistoryToDBSyncSkypeRunErr';
          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - Œ¯Ë·Í‡ Á‡ÔÛÒÍ‡ Skype: ' + e.Message, 4);
        end;
    end;
  end;
  if (Skype.Client.IsRunning) and (not SkypeAttachDone) then
  begin
    try
      Skype.OnUILanguageChanged := SkypeUILanguageChanged;
      Skype.OnChatMembersChanged := SkypeChatMembersChanged;
      Skype.OnAttachmentStatus := SkypeAttachmentStatus;
      Skype.OnMessageStatus := SkypeMessageStatus;
      Skype.OnApplicationDatagram   := SkypeApplicationDatagram;
      Skype.Attach(SkypeProtocol, False);
      SkypeAttachDone := True;
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - ¬˚ÔÓÎÌÂÌÓ Skype.Attach', 4);
    except
      on e :
        Exception do
        begin
          LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeErrCreate');
          LSkypeStatus.Hint := 'HistoryToDBSyncSkypeErrCreate';
          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - Œ¯Ë·Í‡ ÒÓÁ‰‡ÌËˇ ˝ÍÁÂÏÔÎˇ‡ Skype: ' + e.Message, 4);
        end;
    end;
  end;
end;

{ ŒÚÍÎ. ÔÓ‰‰ÂÊÍË Skype }
procedure TMainSyncForm.DisableSkype;
begin
  if Assigned(Skype) then
  begin
    try
      JvThreadTimerSkype.Enabled := False;
      SkypeStrList.Free;
      SkypeChatList.Free;
      Skype.Application[ProgramsName].Delete;
      Skype.Destroy;
      Skype := nil;
      SkypeAttachDone := False;
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - ›ÍÁÂÏÔÎˇ Skype Û‰‡ÎÂÌ.', 4);
    except
      on e :
        Exception do
        begin
          LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeErrDelete');
          LSkypeStatus.Hint := 'HistoryToDBSyncSkypeErrDelete';
          if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - Œ¯Ë·Í‡ Û‰‡ÎÂÌËˇ ˝ÍÁÂÏÔÎˇ‡ Skype: ' + e.Message, 4);
        end;
    end;
  end;
end;

procedure TMainSyncForm.SkypeUILanguageChanged(ASender: TObject; const code: WideString);
begin
  if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeUILanguageChanged: —ÏÂÌ‡ ˇÁ˚Í‡ ËÌÚÂÙÂÈÒ‡ - ' + UpperCase(code), 4);
  if (Skype.Client.IsRunning) and (SkypeAttachDone) and (code = 'ru') then
  begin
    FLanguage := 'Russian';
    CoreLanguageChanged;
  end
  else if (Skype.Client.IsRunning) and (SkypeAttachDone) and (code <> 'ru') then
  begin
    FLanguage := 'English';
    CoreLanguageChanged;
  end;
end;

// «Ì‡˜ÂÌËˇ Ô‡‡ÏÂÚ‡ Status:
//  cmsUnknown  = $FFFFFFFF;
//  cmsSending  = $00000000;
//  cmsSent     = $00000001;
//  cmsReceived = $00000002;
//  cmsRead     = $00000003;
// pMessage.FromDisplayName - »Ïˇ ÓÚ ÍÓ„Ó ÔËÌˇÚÓ ÒÓÓ·˘ÂÌËÂ
// pMessage.FromHandle - UserID ÓÚ ÍÓ„Ó ÔËÌˇÚÓ ÒÓÓ·˘ÂÌËÂ
// pMessage.Chat.FriendlyName - »Ïˇ ÍÓÏÛ ÓÚÔ‡‚ÎÂÌÓ ÒÓÓ·˘ÂÌËÂ
// pMessage.Chat.DialogPartner - UserID ÍÓÏÛ ÓÚÔ‡‚ÎÂÌÓ ÒÓÓ·˘ÂÌËÂ
procedure TMainSyncForm.SkypeMessageStatus(Sender: TObject; const pMessage: IChatMessage; Status: TChatMessageStatus);
var
  Cnt: Integer;
  ChatName, SkypeMsgStr: WideString;
  Date_Str: String;
  aChatName, aNickName, aProtoAcc, aMsgText, MD5String, DialogPartnerFullName: WideString;
  aMsgType, SkypeSearchID, SkypeChatListRowCount: Integer;
  aIsPrivate, ChatNameChange: Boolean;
begin
  if (pMessage.Chat.type_ = cmeCreatedChatWith) or (pMessage.Chat.type_ = cmeSetTopic) then
  begin
    ChatNameChange := False;
    if pMessage.Chat.Topic = '' then
    begin
      {if pMessage.Chat.Members.Count <= 2 then}
        ChatName := Skype.User[pMessage.Chat.DialogPartner].FullName;
        if ChatName = '' then
          ChatName := pMessage.Chat.DialogPartner;
      {else
        ChatName :=  '√ÛÔÔÓ‚ÓÈ ˜‡Ú';}
    end
    else
    begin
      ChatName :=  pMessage.Chat.Topic;
      if ChatName = '' then
        ChatName := pMessage.Chat.DialogPartner;
    end;

    SkypeSearchID := SkypeChatList.Cols[0].IndexOf(pMessage.Chat.Name);
    if SkypeSearchID <> -1 then // Õ‡¯ÎË! SkypeSearchID - ÒÚÓÍ‡
    begin
      if SkypeChatList.Cells[1,SkypeSearchID] <> ChatName then
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeMessageStatus: »ÁÏÂÌÂÌËÂ ËÏÂÌË ˜‡Ú‡: ID ˜‡Ú‡ = ' + pMessage.Chat.Name + ' | »Ïˇ ˜‡Ú‡ ‰Ó = ' + SkypeChatList.Cells[1,SkypeSearchID] + ' | »Ïˇ ˜‡Ú‡ ÔÓÒÎÂ = ' + ChatName + ' |  ÓÎË˜ÂÒÚ‚Ó Û˜‡ÒÚÌËÍÓ‚ = ' + IntToStr(pMessage.Chat.Members.Count), 4);
        SkypeChatList.Cells[1,SkypeSearchID] := ChatName;
        ChatNameChange := True;
      end;
      if SkypeChatList.Cells[2,SkypeSearchID] <> IntToStr(pMessage.Chat.Members.Count) then
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeMessageStatus: »ÁÏÂÌÂÌËÂ ÍÓÎ. Û˜‡ÒÚÌËÍÓ‚ ˜‡Ú‡: ID ˜‡Ú‡ = ' + pMessage.Chat.Name + ' | »Ïˇ ˜‡Ú‡ = ' + ChatName + ' |  ÓÎ. Û˜‡ÒÚÌËÍÓ‚ ‰Ó = ' + SkypeChatList.Cells[2,SkypeSearchID] + ' |  ÓÎ. Û˜‡ÒÚÌËÍÓ‚ ÔÓÒÎÂ = ' + IntToStr(pMessage.Chat.Members.Count), 4);
        SkypeChatList.Cells[2,SkypeSearchID] := IntToStr(pMessage.Chat.Members.Count);
      end;
    end
    else
    begin
      SkypeChatListRowCount := SkypeChatList.RowCount-1;
      SkypeChatList.Cells[0, SkypeChatListRowCount] := pMessage.Chat.Name;
      SkypeChatList.Cells[1, SkypeChatListRowCount] := ChatName;
      SkypeChatList.Cells[2, SkypeChatListRowCount] := IntToStr(pMessage.Chat.Members.Count);
      SkypeChatList.RowCount := SkypeChatListRowCount+2;
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeMessageStatus: —ÓÁ‰‡Ì ˜‡Ú: ID ˜‡Ú‡ = ' + pMessage.Chat.Name + ' | »Ïˇ ˜‡Ú‡ = ' + ChatName + ' |  ÓÎ. Û˜‡ÒÌËÍÓ‚ = ' + IntToStr(pMessage.Chat.Members.Count), 4);
    end;
    if EnableDebug then
    begin
      for Cnt := 0 to SkypeChatList.RowCount-2 do
        WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeMessageStatus: SkypeChatList: ID ˜‡Ú‡ = ' + SkypeChatList.Cells[0, Cnt] + ' | »Ïˇ ˜‡Ú‡ = ' + SkypeChatList.Cells[1, Cnt] + ' |  ÓÎ. Û˜‡ÒÌËÍÓ‚ = ' + SkypeChatList.Cells[2, Cnt], 4);
      WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeMessageStatus: SkypeChatList: RowCount = ' + IntToStr(SkypeChatList.RowCount-1), 4);
    end;
  end
  else
  begin
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeMessageStatus: ID ˜‡Ú‡ = ' + pMessage.Chat.Name + ' | »Ïˇ ˜‡Ú = ' + pMessage.Chat.Topic  + ' | ChatMessageType = ' + Skype.Convert.ChatMessageTypeToText(pMessage.Chat.type_) + ' |  ÓÎ. Û˜‡ÒÌËÍÓ‚ = ' + IntToStr(pMessage.Chat.Members.Count), 4);
  end;

  {if ((Status = cmsReceived) and (pMessage.Chat.Members.Count > 2) and (pMessage.Body <> '')) or ((Status = cmsSent)  and (pMessage.Chat.Members.Count > 2) and (pMessage.Body <> '')) then
  begin
    Log('¬ÒÂ„Ó ‚ ˜‡ÚÂ: '+ IntToStr(pMessage.Chat.Members.Count));
    for i:=1 to pMessage.Chat.Members.Count do
    begin
      Log('”˜‡ÒÚÌËÍ π' + IntToStr(i) +': ' + pMessage.Chat.Members.Item[i].FullName + ' (' + pMessage.Chat.Members.Item[i].Handle + ')');
    end;
    Log('===');
  end;}
  if pMessage.Body <> '' then
  begin
   case Status of
    cmsReceived :
    begin
      if pMessage.Chat.Members.Count <= 2 then
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œËÌˇÚÓ ÓÚ ' + pMessage.FromDisplayName + ' (' + pMessage.FromHandle + ') (' + FormatDateTime('dd.mm.yy hh:mm:ss', pMessage.Timestamp) + ')', 4);
        aNickName := WideStringToUTF8(PrepareString(pWideChar(pMessage.FromDisplayName + ' (' + pMessage.FromHandle + ')')));
        aIsPrivate := True;
      end
      else
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œËÌˇÚÓ ÓÚ ' + pMessage.FromDisplayName + ' (' + pMessage.FromHandle + ') (' + FormatDateTime('dd.mm.yy hh:mm:ss', pMessage.Timestamp) + ')', 4);
        aNickName := WideStringToUTF8(PrepareString(pWideChar(pMessage.FromDisplayName + ' (' + pMessage.FromHandle + ')')));
        aIsPrivate := False;
      end;
      aMsgType := 0;
      aMsgText :=  WideStringToUTF8(PrepareString(pWideChar(pMessage.Body)));
      MD5String := aNickName + FormatDateTime('YYYY-MM-DD HH:MM:SS', pMessage.Timestamp) + aMsgText;
      aChatName := WideStringToUTF8(PrepareString(pWideChar(ChatName)));
      aProtoAcc := 'Skype';
      if (DBType = 'oracle') or (DBType = 'oracle-9i') then
        Date_Str := FormatDateTime('DD.MM.YYYY HH:MM:SS', pMessage.Timestamp)
      else
        Date_Str := FormatDateTime('YYYY-MM-DD HH:MM:SS', pMessage.Timestamp);
      if not ChatNameChange then
      begin
        if (MatchStrings(DBType, 'oracle*')) then // ≈ÒÎË Oracle, ÚÓ ÔË¯ÂÏ SQL-ÎÓ„ ‚ ÙÓÏ‡ÚÂ CHAT_MSG_LOG_ORACLE
          WriteInLog(ProfilePath, Format(SKYPE_CHAT_MSG_LOG_ORACLE, [DBUserName, IntToStr(aMsgType), 'to_date('''+Date_Str+''', ''dd.mm.yyyy hh24:mi:ss'')', aChatName, aProtoAcc, aNickName, BoolToIntStr(aIsPrivate), '0', '0', aMsgText, EncryptMD5(MD5String)]), 0)
        else
          WriteInLog(ProfilePath, Format(SKYPE_CHAT_MSG_LOG, [DBUserName, IntToStr(aMsgType), Date_Str, aChatName, aProtoAcc, aNickName, BoolToIntStr(aIsPrivate), '0', '0', aMsgText, EncryptMD5(MD5String)]), 0);
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œËÌˇÚÓ ‰Îˇ ' + Skype.User[Skype.CurrentUserHandle].FullName + ' (' + Skype.CurrentUserHandle + ') (' + FormatDateTime('dd.mm.yy hh:mm:ss', pMessage.Timestamp) + '): ' + pMessage.Body, 4);
      end;
      ChatNameChange := False;
      //SkypeStrList.Add(SkypeMsgStr);
    end;
    cmsSent :
    begin
      if pMessage.Chat.Members.Count <= 2 then
      begin
        DialogPartnerFullName := Skype.User[pMessage.Chat.DialogPartner].FullName;
        if DialogPartnerFullName = '' then
          DialogPartnerFullName := Skype.User[pMessage.Chat.DialogPartner].DisplayName;
        if DialogPartnerFullName = '' then
          DialogPartnerFullName := pMessage.Chat.DialogPartner;
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - ŒÚÔ‡‚ÎÂÌÓ ‰Îˇ ' + DialogPartnerFullName + ' (' + pMessage.Chat.DialogPartner + ') (' + FormatDateTime('dd.mm.yy hh:mm:ss', pMessage.Timestamp) + ')', 4);
        aNickName := WideStringToUTF8(PrepareString(pWideChar(DialogPartnerFullName + ' (' + pMessage.Chat.DialogPartner + ')')));
        aIsPrivate := True;
      end
      else
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - ŒÚÔ‡‚ÎÂÌÓ ‰Îˇ ˜‡Ú‡ ' + ChatName + ' (' + pMessage.FromHandle + ') (' + FormatDateTime('dd.mm.yy hh:mm:ss', pMessage.Timestamp) + ')', 4);
        aNickName := WideStringToUTF8(PrepareString(pWideChar(pMessage.FromDisplayName + ' (' + pMessage.FromHandle + ')')));
        aIsPrivate := False;
      end;
      aMsgType := 1;
      aMsgText :=  WideStringToUTF8(PrepareString(pWideChar(pMessage.Body)));
      MD5String := aNickName + FormatDateTime('YYYY-MM-DD HH:MM:SS', pMessage.Timestamp) + aMsgText;
      aChatName := WideStringToUTF8(PrepareString(pWideChar(ChatName)));
      aProtoAcc := 'Skype';
      if (DBType = 'oracle') or (DBType = 'oracle-9i') then
        Date_Str := FormatDateTime('DD.MM.YYYY HH:MM:SS', pMessage.Timestamp)
      else
        Date_Str := FormatDateTime('YYYY-MM-DD HH:MM:SS', pMessage.Timestamp);
      if not ChatNameChange then
      begin
        if (MatchStrings(DBType, 'oracle*')) then // ≈ÒÎË Oracle, ÚÓ ÔË¯ÂÏ SQL-ÎÓ„ ‚ ÙÓÏ‡ÚÂ CHAT_MSG_LOG_ORACLE
          WriteInLog(ProfilePath, Format(SKYPE_CHAT_MSG_LOG_ORACLE, [DBUserName, IntToStr(aMsgType), 'to_date('''+Date_Str+''', ''dd.mm.yyyy hh24:mi:ss'')', aChatName, aProtoAcc, aNickName, BoolToIntStr(aIsPrivate), '0', '0', aMsgText, EncryptMD5(MD5String)]), 0)
        else
          WriteInLog(ProfilePath, Format(SKYPE_CHAT_MSG_LOG, [DBUserName, IntToStr(aMsgType), Date_Str, aChatName, aProtoAcc, aNickName, BoolToIntStr(aIsPrivate), '0', '0', aMsgText, EncryptMD5(MD5String)]), 0);
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - ŒÚÔ‡‚ÎÂÌÓ ÓÚ ' + pMessage.FromDisplayName + ' (' + pMessage.FromHandle + ') (' + FormatDateTime('dd.mm.yy hh:mm:ss', pMessage.Timestamp) + '): ' + pMessage.Body, 4);
      end;
      ChatNameChange := False;
    end;
   end;
  end;
end;

procedure TMainSyncForm.SkypeAttachmentStatus(Sender: TObject; Status: TOleEnum);
begin
  if Status = apiAttachPendingAuthorization then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeAttachPendingAuthorization');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeAttachPendingAuthorization';
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - —Ú‡ÚÛÒ ÔÓ‰ÍÎ˛˜ÂÌËˇ Í ˝ÍÁÂÏÔÎˇÛ Skype: «‡ÔÓÒ ‡‚ÚÓËÁ‡ˆËË.', 4);
  end
  else if Status = apiAttachSuccess then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeAttachSuccess');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeAttachSuccess';
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - —Ú‡ÚÛÒ ÔÓ‰ÍÎ˛˜ÂÌËˇ Í ˝ÍÁÂÏÔÎˇÛ Skype: œÓ‰ÍÎ˛˜ÂÌËÂ ‡ÁÂ¯ÂÌÓ.', 4);
  end
  else if Status = apiAttachRefused then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeAttachRefused');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeAttachRefused';
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - —Ú‡ÚÛÒ ÔÓ‰ÍÎ˛˜ÂÌËˇ Í ˝ÍÁÂÏÔÎˇÛ Skype: œÓ‰ÍÎ˛˜ÂÌËÂ ÓÚÍÎÓÌÂÌÓ.', 4);
  end
  else if Status = apiAttachNotAvailable then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeAttachNotAvailable');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeAttachNotAvailable';
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - —Ú‡ÚÛÒ ÔÓ‰ÍÎ˛˜ÂÌËˇ Í ˝ÍÁÂÏÔÎˇÛ Skype: œÓ‰ÍÎ˛˜ÂÌËÂ ÓÚÍÎ˛˜ÂÌÓ.', 4);
    SkypeAttachDone := False;
  end
  else if Status = apiAttachAvailable then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeAttachAvailable');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeAttachAvailable';
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - —Ú‡ÚÛÒ ÔÓ‰ÍÎ˛˜ÂÌËˇ Í ˝ÍÁÂÏÔÎˇÛ Skype: Skype API ‰ÓÒÚÛÔÌÓ.', 4);
  end
  else
  begin
    LSkypeStatus.Caption := Skype.Convert.AttachmentStatusToText(Status);
    LSkypeStatus.Hint := '';
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - —Ú‡ÚÛÒ ÔÓ‰ÍÎ˛˜ÂÌËˇ Í ˝ÍÁÂÏÔÎˇÛ Skype: ' + Skype.Convert.AttachmentStatusToText(Status), 4);
  end;
  if Status = apiAttachAvailable then
    Skype.Attach(SkypeProtocol, False);
  if Status = apiAttachSuccess Then
  begin
    Skype.Application[ProgramsName].Create;
    LSkypeStatus.Caption := Skype.CurrentUser.FullName + ' (' + Skype.CurrentUser.Handle + ')';
    LSkypeStatus.Hint := '';
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓ‰ÍÎ˛˜ÂÌÓ: ' + Skype.CurrentUser.FullName + ' (' + Skype.CurrentUser.Handle + ')', 4);
  end;
end;

procedure TMainSyncForm.SkypeApplicationDatagram(Sender: TObject;
      const pApp: IApplication; const pStream: IApplicationStream;
      const Text: WideString);
begin
  if pApp.Name = ProgramsName then
  begin
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - SkypeApplicationDatagram: ' + pStream.Handle, 4);
    if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - SkypeApplicationDatagram: ' + Text, 4);
  end;
end;

procedure  TMainSyncForm.SkypeChatMembersChanged(ASender: TObject; const pChat: IChat; const pMembers: IUserCollection);
var
  ChatName: WideString;
  pMembersCnt, SkypeSearchID, SkypeChatListRowCount: Integer;
begin
  if (pChat.type_ = cmeCreatedChatWith) or (pChat.type_ = cmeSetTopic) then
  begin
    if pChat.Topic = '' then
    begin
      {if pChat.Members.Count <= 2 then}
        ChatName := Skype.User[pChat.DialogPartner].FullName;
      {else
        ChatName :=  '√ÛÔÔÓ‚ÓÈ ˜‡Ú';}
    end
    else
      ChatName :=  pChat.Topic;

    SkypeSearchID := SkypeChatList.Cols[0].IndexOf(pChat.Name);
    if SkypeSearchID <> -1 then // Õ‡¯ÎË! SkypeSearchID - ÒÚÓÍ‡
    begin
      if SkypeChatList.Cells[1,SkypeSearchID] <> ChatName then
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeChatMembersChanged: »ÁÏÂÌÂÌËÂ ËÏÂÌË ˜‡Ú‡: ID ˜‡Ú‡ = ' + pChat.Name + ' | »Ïˇ ˜‡Ú‡ ‰Ó = ' + SkypeChatList.Cells[1,SkypeSearchID] + ' | »Ïˇ ˜‡Ú‡ ÔÓÒÎÂ = ' + ChatName + ' |  ÓÎË˜ÂÒÚ‚Ó Û˜‡ÒÚÌËÍÓ‚ = ' + IntToStr(pMembers.Count), 4);
        SkypeChatList.Cells[1,SkypeSearchID] := ChatName;
      end;
      if SkypeChatList.Cells[2,SkypeSearchID] <> IntToStr(pMembers.Count) then
      begin
        if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeChatMembersChanged: »ÁÏÂÌÂÌËÂ ÍÓÎ. Û˜‡ÒÚÌËÍÓ‚ ˜‡Ú‡: ID ˜‡Ú‡ = ' + pChat.Name + ' | »Ïˇ ˜‡Ú‡ = ' + ChatName + ' |  ÓÎ. Û˜‡ÒÚÌËÍÓ‚ ‰Ó = ' + SkypeChatList.Cells[2,SkypeSearchID] + ' |  ÓÎ. Û˜‡ÒÚÌËÍÓ‚ ÔÓÒÎÂ = ' + IntToStr(pMembers.Count), 4);
        SkypeChatList.Cells[2,SkypeSearchID] := IntToStr(pMembers.Count);
        if EnableDebug then
        begin
          for pMembersCnt:=1 to pMembers.Count do
            WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeChatMembersChanged: ”˜‡ÒÚÌËÍ ˜‡Ú‡ π' + IntToStr(pMembersCnt) +': ' + pMembers.Item[pMembersCnt].FullName + ' (' + pMembers.Item[pMembersCnt].Handle + ')', 4);
        end;
      end;
    end
    else
    begin
      SkypeChatListRowCount := SkypeChatList.RowCount;
      SkypeChatList.Cells[0, SkypeChatListRowCount+1] := pChat.Name;
      SkypeChatList.Cells[1, SkypeChatListRowCount+1] := ChatName;
      SkypeChatList.Cells[2, SkypeChatListRowCount+1] := IntToStr(pMembers.Count);
      SkypeChatList.RowCount := SkypeChatListRowCount+1;
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeChatMembersChanged: —ÓÁ‰‡Ì ˜‡Ú: ID ˜‡Ú‡ = ' + pChat.Name + ' | »Ïˇ ˜‡Ú‡ = ' + ChatName + ' |  ÓÎË˜ÂÒÚ‚Ó Û˜‡ÒÚÌËÍÓ‚ = ' + IntToStr(pMembers.Count), 4);
    end;
  end;

  {if EnableDebug then
  begin
    for Cnt := 0 to SkypeChatList.RowCount-2 do
      WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeChatMembersChanged: SkypeChatList: ID ˜‡Ú‡ = ' + SkypeChatList.Cells[0, Cnt] + ' | »Ïˇ ˜‡Ú‡ = ' + SkypeChatList.Cells[1, Cnt] + ' |  ÓÎ. Û˜‡ÒÌËÍÓ‚ = ' + SkypeChatList.Cells[2, Cnt], 4);
  end;}

  SkypeSearchID := SkypeChatList.Cols[0].IndexOf(pChat.Name);
  if SkypeSearchID <> -1 then // Õ‡¯ÎË! SkypeSearchID - ÒÚÓÍ‡
  begin
    if SkypeChatList.Cells[2,SkypeSearchID] <> IntToStr(pMembers.Count) then
    begin
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeChatMembersChanged: —ÏÂÌ‡ Û˜‡ÒÚÌËÍÓ‚ ˜‡Ú‡ (ƒÓ ÒÏÂÌ˚): ID ˜‡Ú‡ = ' + SkypeChatList.Cells[0,SkypeSearchID] + ' | »Ïˇ ˜‡Ú‡ = ' + SkypeChatList.Cells[1,SkypeSearchID] + ' |  ÓÎË˜ÂÒÚ‚Ó Û˜‡ÒÚÌËÍÓ‚ = ' + SkypeChatList.Cells[2,SkypeSearchID], 4);
      if EnableDebug then WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeChatMembersChanged: —ÏÂÌ‡ Û˜‡ÒÚÌËÍÓ‚ ˜‡Ú‡ (œÓÒÎÂ ÒÏÂÌ˚): ID ˜‡Ú‡ = ' + pChat.Name + ' | »Ïˇ ˜‡Ú‡ = ' + ChatName + ' |  ÓÎË˜ÂÒÚ‚Ó Û˜‡ÒÚÌËÍÓ‚ = ' + IntToStr(pMembers.Count), 4);
      if EnableDebug then
      begin
        for pMembersCnt:=1 to pMembers.Count do
          WriteInLog(ProfilePath, FormatDateTime('dd.mm.yy hh:mm:ss', Now) + ' - œÓˆÂ‰Û‡ SkypeChatMembersChanged: ”˜‡ÒÚÌËÍ ˜‡Ú‡ π' + IntToStr(pMembersCnt) +': ' + pMembers.Item[pMembersCnt].FullName + ' (' + pMembers.Item[pMembersCnt].Handle + ')', 4);
      end;
    end;
  end;
  //Log('—ÏÂÌ‡ Û˜‡ÒÚÌËÍÓ‚ ˜‡Ú‡: ◊‡Ú - ' + pChat.Name + ' |  ÓÎË˜ÂÒÚ‚Ó Û˜‡ÒÚÌËÍÓ‚: ' + IntToStr(pMembers.Count));
end;

{ œÓ‚ÂÍ‡ Ì‡ Í‡ÚÌÓÒÚ¸ ÌÓÏÂ‡ Á‡ÔËÒË ‚ Á‡ÔÓÒÂ }
function TMainSyncForm.CheckQueryRecNo(TotalRecNo, CurRecNo: Integer): Boolean;
begin
  if TotalRecNo < 1000 then
    Result := True
  else if (TotalRecNo >= 1000) and (TotalRecNo < 10000) then
  begin
    if Round(CurRecNo/100) = CurRecNo/100 then
      Result := True
    else
      Result := False;
  end
  else if (TotalRecNo >= 10000) and (TotalRecNo < 100000) then
  begin
    if Round(CurRecNo/1000) = CurRecNo/1000 then
      Result := True
    else
      Result := False;
  end
  else if (TotalRecNo >= 100000) and (TotalRecNo < 1000000) then
  begin
    if Round(CurRecNo/10000) = CurRecNo/10000 then
      Result := True
    else
      Result := False;
  end
  else
  begin
    if Round(CurRecNo/100000) = CurRecNo/100000 then
      Result := True
    else
      Result := False;
  end;
end;

{ ŒÚÎ‡‚ÎË‚‡ÂÏ ÒÓ·˚ÚËÂ WM_MSGBOX ‰Îˇ ËÁÏÂÌÂÌËˇ ÔÓÁ‡˜ÌÓÒÚË ÓÍÌ‡ }
procedure TMainSyncForm.msgBoxShow(var Msg: TMessage);
var
  msgbHandle: HWND;
begin
  msgbHandle := GetActiveWindow;
  if msgbHandle <> 0 then
    MakeTransp(msgbHandle);
end;

{ —ÏÂÌ‡ ˇÁ˚Í‡ ËÌÚÂÙÂÈÒ‡ ÔÓ ÒÓ·˚ÚË˛ WM_LANGUAGECHANGED }
procedure TMainSyncForm.OnLanguageChanged(var Msg: TMessage);
begin
  LoadLanguageStrings;
end;

{ ‘ÛÌÍˆËˇ ‰Îˇ ÏÛÎ¸ÚËˇÁ˚ÍÓ‚ÓÈ ÔÓ‰‰ÂÊÍË }
procedure TMainSyncForm.CoreLanguageChanged;
var
  LangFile: String;
begin
  if CoreLanguage = '' then
    Exit;
  try
    LangFile := PluginPath + dirLangs + CoreLanguage + '.xml';
    if FileExists(LangFile) then
      LangDoc.LoadFromFile(LangFile)
    else
    begin
      if FileExists(PluginPath + dirLangs + defaultLangFile) then
        LangDoc.LoadFromFile(PluginPath + dirLangs + defaultLangFile)
      else
      begin
        MsgDie(ProgramsName, 'Not found any language file!');
        Exit;
      end;
    end;
    Global.CoreLanguage := CoreLanguage;
    SendMessage(MainFormHandle, WM_LANGUAGECHANGED, 0, 0);
    SendMessage(LogFormHandle, WM_LANGUAGECHANGED, 0, 0);
    SendMessage(KeyPasswdFormHandle, WM_LANGUAGECHANGED, 0, 0);
    SendMessage(AboutFormHandle, WM_LANGUAGECHANGED, 0, 0);
  except
    on E: Exception do
      MsgDie(ProgramsName, 'Error on CoreLanguageChanged: ' + E.Message + sLineBreak +
        'CoreLanguage: ' + CoreLanguage);
  end;
end;

{ ƒÎˇ ÏÛÎ¸ÚËˇÁ˚ÍÓ‚ÓÈ ÔÓ‰‰ÂÊÍË }
procedure TMainSyncForm.LoadLanguageStrings;
begin
  if IMClientType <> 'Unknown' then
    Caption := ProgramsName + ' for ' + IMClientType + ' (' + MyAccount + ')'
  else
    Caption := ProgramsName;
  HistoryToDBSyncTray.Hint := Caption;
  ShowSyncSettings;
  if HistoryToDbSyncPopupMenu.Items[0].Hint = 'HistoryToDBSyncPopupMenuShow' then
  begin
    HistoryToDbSyncPopupMenu.Items[0].Caption := GetLangStr('HistoryToDBSyncPopupMenuShow');
    HistoryToDbSyncPopupMenu.Items[0].Hint := 'HistoryToDBSyncPopupMenuShow';
  end
  else
  begin
    HistoryToDbSyncPopupMenu.Items[0].Caption := GetLangStr('HistoryToDBSyncPopupMenuHide');
    HistoryToDbSyncPopupMenu.Items[0].Hint := 'HistoryToDBSyncPopupMenuHide';
  end;
  HistoryToDbSyncPopupMenu.Items[2].Caption := GetLangStr('HistoryToDBSyncPopupMenuSync');
  HistoryToDbSyncPopupMenu.Items[3].Caption := GetLangStr('IMCaption');
  HistoryToDbSyncPopupMenu.Items[5].Caption := GetLangStr('CheckMD5Hash');
  HistoryToDbSyncPopupMenu.Items[6].Caption := GetLangStr('CheckAndDeleteMD5Hash');
  HistoryToDbSyncPopupMenu.Items[7].Caption := GetLangStr('UpdateContactListButton');
  HistoryToDbSyncPopupMenu.Items[8].Caption := GetLangStr('CheckUpdateButton');
  HistoryToDbSyncPopupMenu.Items[9].Caption := GetLangStr('HistoryToDBSyncShowLogFile');
  HistoryToDbSyncPopupMenu.Items[10].Caption := GetLangStr('SettingsButton');
  HistoryToDbSyncPopupMenu.Items[12].Caption := GetLangStr('HistoryToDBSyncPopupMenuShowAbout');
  HistoryToDbSyncPopupMenu.Items[13].Caption := GetLangStr('HistoryToDBSyncPopupMenuShowExit');
  SyncButton.Caption := GetLangStr('HistoryToDBSyncPopupMenuSync');
  if StartStopSyncButton.Hint = 'HistoryToDBSyncStop' then
  begin
    StartStopSyncButton.Caption := GetLangStr('HistoryToDBSyncStop');
    StartStopSyncButton.Hint := 'HistoryToDBSyncStop';
  end
  else
  begin
    StartStopSyncButton.Caption := GetLangStr('HistoryToDBSyncStart');
    StartStopSyncButton.Hint := 'HistoryToDBSyncStart';
  end;
  LSkypeStatusDesc.Caption := GetLangStr('HistoryToDBSyncLSkypeStatusDesc');
  if LSkypeStatus.Hint = 'HistoryToDBSyncSkypeOff' then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeOff');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeOff';
  end
  else if LSkypeStatus.Hint = 'HistoryToDBSyncSkypeAttachPendingAuthorization' then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeAttachPendingAuthorization');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeAttachPendingAuthorization';
  end
  else if LSkypeStatus.Hint = 'HistoryToDBSyncSkypeAttachSuccess' then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeAttachSuccess');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeAttachSuccess';
  end
  else if LSkypeStatus.Hint = 'HistoryToDBSyncSkypeAttachRefused' then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeAttachRefused');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeAttachRefused';
  end
  else if LSkypeStatus.Hint = 'HistoryToDBSyncSkypeAttachNotAvailable' then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeAttachNotAvailable');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeAttachNotAvailable';
  end
  else if LSkypeStatus.Hint = 'HistoryToDBSyncSkypeAttachAvailable' then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeAttachAvailable');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeAttachAvailable';
  end
  else if LSkypeStatus.Hint = 'HistoryToDBSyncSkypeErrCreate' then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeErrCreate');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeErrCreate';
  end
  else if LSkypeStatus.Hint = 'HistoryToDBSyncSkypeErrDelete' then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeErrDelete');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeErrDelete';
  end
  else if LSkypeStatus.Hint = 'HistoryToDBSyncSkypeRun' then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeRun');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeRun';
  end
  else if LSkypeStatus.Hint = 'HistoryToDBSyncSkypeRunErr' then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeRunErr');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeRunErr';
  end
  else if LSkypeStatus.Hint = 'HistoryToDBSyncSkypeInitErr' then
  begin
    LSkypeStatus.Caption := GetLangStr('HistoryToDBSyncSkypeInitErr');
    LSkypeStatus.Hint := 'HistoryToDBSyncSkypeInitErr';
  end;
  SyncGroupBox.Caption := GetLangStr('HistoryToDBSyncGroupBox');
  LSyncMethod.Caption := GetLangStr('LSyncMethod');
  LSyncInterval.Caption := GetLangStr('LSyncInterval');
  LSyncStatus.Caption := GetLangStr('HistoryToDBSyncStatus');
  LSyncStatusSet.Caption := GetLangStr(LSyncStatusSet.Hint);
  LTotalMesCountDesc.Caption := GetLangStr('HistoryToDBSyncLTotalMesCountDesc');
  LMesCurrentCountDesc.Caption := GetLangStr('HistoryToDBSyncLMesCurrentCountDesc');
  LBadMesCountDesc.Caption := GetLangStr('HistoryToDBSyncLBadMesCountDesc');
  LStartTimeDesc.Caption := GetLangStr('HistoryToDBSyncLStartTimeDesc');
  LEndTimeDesc.Caption := GetLangStr('HistoryToDBSyncLEndTimeDesc');
  LDublicateMesCountDesc.Caption := GetLangStr('HistoryToDBSyncLDublicateMesCountDesc');
  //LogViewButton.Caption := GetLangStr('HistoryToDBSyncLogViewButton');
  LTotalHashMsg—ountDesc.Caption := GetLangStr('HistoryToDBSyncLTotalHashMsg—ountDesc');
  LTotalBrokenMD5Hash—ountDesc.Caption := GetLangStr('HistoryToDBSyncLTotalBrokenMD5Hash—ountDesc');
  LTotalChangeMD5Hash—ountDesc.Caption := GetLangStr('HistoryToDBSyncLTotalChangeMD5Hash—ountDesc');
  LMD5DublicateMesCountDesc.Caption := GetLangStr('HistoryToDBSyncLMD5DublicateMesCountDesc');
  LDeletedMD5DublicateMesCountDesc.Caption := GetLangStr('HistoryToDBSyncLDeletedMD5DublicateMesCountDesc');
  LEncryptMesCountDesc.Caption := GetLangStr('HistoryToDBSyncLEncryptMesCountDesc');
  // œÓÁËˆËÓÌËÓ‚‡ÌËÂ Ò˜ÂÚ˜ËÍÓ‚
  LStartTime.Left := LStartTimeDesc.Left + LStartTimeDesc.Width + 5;
  LEndTime.Left := LEndTimeDesc.Left + LEndTimeDesc.Width + 5;
  // End
  ERR_READ_DB_CONNECT_ERR := GetLangStr('ERR_READ_DB_CONNECT_ERR');
  ERR_READ_DB_SERVICE_MODE := GetLangStr('ERR_READ_DB_SERVICE_MODE');
  ERR_LOAD_MSG_TO_DB := GetLangStr('ERR_LOAD_MSG_TO_DB');
  ERR_SEND_UPDATE := GetLangStr('ERR_SEND_UPDATE');
  ERR_NO_DB_CONNECTED := GetLangStr('ERR_NO_DB_CONNECTED');
  LOAD_TEMP_MSG := GetLangStr('LOAD_TEMP_MSG');
  LOAD_TEMP_MSG_SCREEN := GetLangStr('LOAD_TEMP_MSG_SCREEN');
  LOAD_TEMP_MSG_NOLOGFILE := GetLangStr('LOAD_TEMP_MSG_NOLOGFILE');
  LOAD_TEMP_MSG_NOMSGFILE := GetLangStr('LOAD_TEMP_MSG_NOMSGFILE');
end;

{ œÓÎÛ˜ÂÌËÂ ÒÓÓ·˘ÂÌËˇ ËÁ Ô‡ÏˇÚË }
procedure TMainSyncForm.ReadMappedText;
var
  ASize: Integer;
  Msg: PChar;
begin
  with FMap do
  begin
    Position := 0;
    ReadBuffer(@ASize,Sizeof(Integer));
    Inc(ASize);
    Msg := AllocMem(ASize);
    Msg[ASize] := #0;
    Dec(ASize);
    try
      ReadBuffer(Msg, ASize);
      WriteInLog(ProfilePath, DecryptStr(Msg), 0);
    finally
      ReAllocMem(Msg, 0);
    end;
  end;
end;

end.

